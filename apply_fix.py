#!/usr/bin/env python3
import base64, os, shutil
STEALTH = 'IiIiCnN0ZWFsdGgucHkg4oCTIEFkdmFuY2VkIGFudGktZGV0ZWN0aW9uIGxheWVyIGZvciBUaWtUb2sgQnJvd3NlciBCb3QuCgpQcm92aWRlczoKLSBCw6l6aWVyLWN1cnZlIG1vdXNlIG1vdmVtZW50IChuYXR1cmFsIHBvaW50ZXIgcGF0aHMpCi0gSHVtYW4tbGlrZSBjbGlja2luZyB3aXRoIG9mZnNldCBqaXR0ZXIKLSBJZGxlIHNpbXVsYXRpb24gKG1pY3JvLW1vdmVtZW50cyBkdXJpbmcgd2FpdCBwZXJpb2RzKQotIENBUFRDSEEgLyByYXRlLWxpbWl0IGRldGVjdGlvbiB3aXRoIGFkYXB0aXZlIHRocm90dGxpbmcKLSBCcm93c2VyIGZpbmdlcnByaW50IGhhcmRlbmluZyBzY3JpcHRzCi0gVmlld3BvcnQgcmFuZG9taXNhdGlvbgoiIiIKCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYW5ub3RhdGlvbnMKCmltcG9ydCBsb2dnaW5nCmltcG9ydCBtYXRoCmltcG9ydCByYW5kb20KaW1wb3J0IHRpbWUKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzLCBmaWVsZAoKZnJvbSBib3RfdXRpbHMgaW1wb3J0IGVsZW1lbnRfZXhpc3RzCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcigiVGlrVG9rQm90IikKCiMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiMgQWRhcHRpdmUgVGhyb3R0bGUgU3RhdGUKIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKCkBkYXRhY2xhc3MKY2xhc3MgVGhyb3R0bGVTdGF0ZToKICAgICIiIlRyYWNrcyBzdXNwaWNpb24gc2lnbmFscyBhbmQgc2NhbGVzIGRlbGF5cyBhY2NvcmRpbmdseS4iIiIKICAgIHN1c3BpY2lvbl9zY29yZTogZmxvYXQgPSAwLjAKICAgIGNhcHRjaGFfY291bnQ6IGludCA9IDAKICAgIHJhdGVfbGltaXRfY291bnQ6IGludCA9IDAKICAgIGxhc3RfYWN0aW9uX3RzOiBmbG9hdCA9IGZpZWxkKGRlZmF1bHRfZmFjdG9yeT10aW1lLnRpbWUpCgogICAgIyBTY29yZSB0aHJlc2hvbGRzCiAgICBXQVJOX1RIUkVTSE9MRDogZmxvYXQgPSAzLjAKICAgIENSSVRJQ0FMX1RIUkVTSE9MRDogZmxvYXQgPSA2LjAKICAgIE1BWF9TQ09SRTogZmxvYXQgPSAxMC4wCgogICAgZGVmIGJ1bXAoc2VsZiwgYW1vdW50OiBmbG9hdCA9IDEuMCwgcmVhc29uOiBzdHIgPSAiIikgLT4gTm9uZToKICAgICAgICAiIiJJbmNyZWFzZSBzdXNwaWNpb24gc2NvcmUuIiIiCiAgICAgICAgc2VsZi5zdXNwaWNpb25fc2NvcmUgPSBtaW4oc2VsZi5zdXNwaWNpb25fc2NvcmUgKyBhbW91bnQsIHNlbGYuTUFYX1NDT1JFKQogICAgICAgIGlmIHJlYXNvbjoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICAgICAiW1Rocm90dGxlXSBTdXNwaWNpb24gKyUuMWYgKCVzKSDihpIgdG90YWwgJS4xZiIsCiAgICAgICAgICAgICAgICBhbW91bnQsIHJlYXNvbiwgc2VsZi5zdXNwaWNpb25fc2NvcmUsCiAgICAgICAgICAgICkKCiAgICBkZWYgZGVjYXkoc2VsZiwgYW1vdW50OiBmbG9hdCA9IDAuMykgLT4gTm9uZToKICAgICAgICAiIiJHcmFkdWFsbHkgcmVkdWNlIHN1c3BpY2lvbiBhZnRlciBjbGVhbiBhY3Rpb25zLiIiIgogICAgICAgIHNlbGYuc3VzcGljaW9uX3Njb3JlID0gbWF4KDAuMCwgc2VsZi5zdXNwaWNpb25fc2NvcmUgLSBhbW91bnQpCgogICAgQHByb3BlcnR5CiAgICBkZWYgZGVsYXlfbXVsdGlwbGllcihzZWxmKSAtPiBmbG9hdDoKICAgICAgICAiIiJSZXR1cm5zIGEgbXVsdGlwbGllciAoMS4w4oCTNC4wKSB0byBzY2FsZSBhbGwgZGVsYXlzLiIiIgogICAgICAgIGlmIHNlbGYuc3VzcGljaW9uX3Njb3JlID49IHNlbGYuQ1JJVElDQUxfVEhSRVNIT0xEOgogICAgICAgICAgICByZXR1cm4gNC4wCiAgICAgICAgaWYgc2VsZi5zdXNwaWNpb25fc2NvcmUgPj0gc2VsZi5XQVJOX1RIUkVTSE9MRDoKICAgICAgICAgICAgcmV0dXJuIDIuMCArIChzZWxmLnN1c3BpY2lvbl9zY29yZSAtIHNlbGYuV0FSTl9USFJFU0hPTEQpICogMC41CiAgICAgICAgcmV0dXJuIDEuMCArIHNlbGYuc3VzcGljaW9uX3Njb3JlICogMC4xNQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGlzX2NyaXRpY2FsKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIHNlbGYuc3VzcGljaW9uX3Njb3JlID49IHNlbGYuQ1JJVElDQUxfVEhSRVNIT0xECgogICAgZGVmIHJlY29yZF9hY3Rpb24oc2VsZikgLT4gTm9uZToKICAgICAgICBzZWxmLmxhc3RfYWN0aW9uX3RzID0gdGltZS50aW1lKCkKCgpfdGhyb3R0bGUgPSBUaHJvdHRsZVN0YXRlKCkKCgpkZWYgZ2V0X3Rocm90dGxlKCkgLT4gVGhyb3R0bGVTdGF0ZToKICAgICIiIlJldHVybiB0aGUgZ2xvYmFsIHRocm90dGxlIHN0YXRlLiIiIgogICAgcmV0dXJuIF90aHJvdHRsZQoKCiMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiMgQsOpemllciBDdXJ2ZSBNb3VzZSBNb3ZlbWVudAojIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAoKZGVmIF9iZXppZXJfcG9pbnQodDogZmxvYXQsIHAwOiB0dXBsZSwgcDE6IHR1cGxlLCBwMjogdHVwbGUsIHAzOiB0dXBsZSkgLT4gdHVwbGU6CiAgICAiIiJFdmFsdWF0ZSBhIGN1YmljIELDqXppZXIgY3VydmUgYXQgcGFyYW1ldGVyICp0KiDiiIggWzAsIDFdLiIiIgogICAgdSA9IDEgLSB0CiAgICB4ID0gdSoqMyAqIHAwWzBdICsgMyAqIHUqKjIgKiB0ICogcDFbMF0gKyAzICogdSAqIHQqKjIgKiBwMlswXSArIHQqKjMgKiBwM1swXQogICAgeSA9IHUqKjMgKiBwMFsxXSArIDMgKiB1KioyICogdCAqIHAxWzFdICsgMyAqIHUgKiB0KioyICogcDJbMV0gKyB0KiozICogcDNbMV0KICAgIHJldHVybiAoeCwgeSkKCgpkZWYgX2dlbmVyYXRlX2Jlemllcl9wYXRoKAogICAgc3RhcnQ6IHR1cGxlW2Zsb2F0LCBmbG9hdF0sCiAgICBlbmQ6IHR1cGxlW2Zsb2F0LCBmbG9hdF0sCiAgICBzdGVwczogaW50IHwgTm9uZSA9IE5vbmUsCikgLT4gbGlzdFt0dXBsZVtmbG9hdCwgZmxvYXRdXToKICAgICIiIkdlbmVyYXRlIGEgbmF0dXJhbC1sb29raW5nIG1vdXNlIHBhdGggZnJvbSAqc3RhcnQqIHRvICplbmQqIHVzaW5nCiAgICBhIGN1YmljIELDqXppZXIgY3VydmUgd2l0aCByYW5kb21pc2VkIGNvbnRyb2wgcG9pbnRzLgogICAgIiIiCiAgICBkeCA9IGVuZFswXSAtIHN0YXJ0WzBdCiAgICBkeSA9IGVuZFsxXSAtIHN0YXJ0WzFdCiAgICBkaXN0ID0gbWF0aC5oeXBvdChkeCwgZHkpCgogICAgaWYgc3RlcHMgaXMgTm9uZToKICAgICAgICBzdGVwcyA9IG1heCgxMiwgaW50KGRpc3QgLyA4KSkKICAgIHN0ZXBzID0gbWluKHN0ZXBzLCA4MCkKCiAgICAjIENvbnRyb2wgcG9pbnRzOiBvZmZzZXQgcGVycGVuZGljdWxhciB0byB0aGUgZGlyZWN0IGxpbmUKICAgIHNwcmVhZCA9IG1heCgzMCwgZGlzdCAqIDAuMykKICAgIGNwMSA9ICgKICAgICAgICBzdGFydFswXSArIGR4ICogcmFuZG9tLnVuaWZvcm0oMC4xNSwgMC40NSkgKyByYW5kb20udW5pZm9ybSgtc3ByZWFkLCBzcHJlYWQpICogMC4zLAogICAgICAgIHN0YXJ0WzFdICsgZHkgKiByYW5kb20udW5pZm9ybSgwLjE1LCAwLjQ1KSArIHJhbmRvbS51bmlmb3JtKC1zcHJlYWQsIHNwcmVhZCkgKiAwLjMsCiAgICApCiAgICBjcDIgPSAoCiAgICAgICAgc3RhcnRbMF0gKyBkeCAqIHJhbmRvbS51bmlmb3JtKDAuNTUsIDAuODUpICsgcmFuZG9tLnVuaWZvcm0oLXNwcmVhZCwgc3ByZWFkKSAqIDAuMjUsCiAgICAgICAgc3RhcnRbMV0gKyBkeSAqIHJhbmRvbS51bmlmb3JtKDAuNTUsIDAuODUpICsgcmFuZG9tLnVuaWZvcm0oLXNwcmVhZCwgc3ByZWFkKSAqIDAuMjUsCiAgICApCgogICAgcGF0aCA9IFtdCiAgICBmb3IgaSBpbiByYW5nZShzdGVwcyArIDEpOgogICAgICAgIHQgPSBpIC8gc3RlcHMKICAgICAgICAjIEFwcGx5IGVhc2luZzogc2xvdyBzdGFydCwgZmFzdCBtaWRkbGUsIHNsb3cgZW5kCiAgICAgICAgdF9lYXNlZCA9IHQgKiB0ICogKDMgLSAyICogdCkgICMgc21vb3Roc3RlcAogICAgICAgIHB0ID0gX2Jlemllcl9wb2ludCh0X2Vhc2VkLCBzdGFydCwgY3AxLCBjcDIsIGVuZCkKICAgICAgICAjIEFkZCBtaWNyby1qaXR0ZXIgKMKxMSBweCkKICAgICAgICBqeCA9IHB0WzBdICsgcmFuZG9tLnVuaWZvcm0oLTAuOCwgMC44KQogICAgICAgIGp5ID0gcHRbMV0gKyByYW5kb20udW5pZm9ybSgtMC44LCAwLjgpCiAgICAgICAgcGF0aC5hcHBlbmQoKGp4LCBqeSkpCgogICAgcmV0dXJuIHBhdGgKCgpkZWYgaHVtYW5fbW92ZV9tb3VzZShwYWdlLCB0YXJnZXRfeDogZmxvYXQsIHRhcmdldF95OiBmbG9hdCkgLT4gTm9uZToKICAgICIiIk1vdmUgdGhlIG1vdXNlIGZyb20gaXRzIGN1cnJlbnQgcG9zaXRpb24gdG8gKCp0YXJnZXRfeCosICp0YXJnZXRfeSopCiAgICBhbG9uZyBhIG5hdHVyYWwgQsOpemllci1jdXJ2ZSBwYXRoIHdpdGggdmFyaWFibGUgc3BlZWQuCiAgICAiIiIKICAgIHRyeToKICAgICAgICAjIEdldCBjdXJyZW50IG1vdXNlIHBvc2l0aW9uIHZpYSBKUyAoZmFsbGJhY2sgdG8gcmFuZG9tIHZpZXdwb3J0IHBvcykKICAgICAgICBjdXJyZW50ID0gcGFnZS5ldmFsdWF0ZSgKICAgICAgICAgICAgIigpID0+ICh7IHg6ICh3aW5kb3cuX19tUG9zICYmIHdpbmRvdy5fX21Qb3MueCkgfHwgMCwgeTogKHdpbmRvdy5fX21Qb3MgJiYgd2luZG93Ll9fbVBvcy55KSB8fCAwIH0pIgogICAgICAgICkKICAgICAgICBzdGFydCA9IChjdXJyZW50LmdldCgieCIsIHJhbmRvbS5yYW5kaW50KDEwMCwgNjAwKSksCiAgICAgICAgICAgICAgICAgY3VycmVudC5nZXQoInkiLCByYW5kb20ucmFuZGludCgxMDAsIDQwMCkpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBzdGFydCA9IChyYW5kb20ucmFuZGludCgxMDAsIDYwMCksIHJhbmRvbS5yYW5kaW50KDEwMCwgNDAwKSkKCiAgICBwYXRoID0gX2dlbmVyYXRlX2Jlemllcl9wYXRoKHN0YXJ0LCAodGFyZ2V0X3gsIHRhcmdldF95KSkKCiAgICBmb3IgcHgsIHB5IGluIHBhdGg6CiAgICAgICAgcGFnZS5tb3VzZS5tb3ZlKHB4LCBweSkKICAgICAgICAjIFZhcmlhYmxlIGludGVyLXN0ZXAgZGVsYXk6IGZhc3RlciBpbiBtaWRkbGUsIHNsb3dlciBhdCBlbmRzCiAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjAwMywgMC4wMTgpKQoKICAgICMgVHJhY2sgcG9zaXRpb24gZm9yIG5leHQgY2FsbCAoc3RvcmVkIGluIGNsb3N1cmUsIG5vdCBvbiB3aW5kb3cpCiAgICB0cnk6CiAgICAgICAgcGFnZS5ldmFsdWF0ZSgKICAgICAgICAgICAgZiIoKSA9PiB7eyBpZighd2luZG93Ll9fbVBvcylPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCdfX21Qb3MnLHt7dmFsdWU6e3t9fSx3cml0YWJsZTp0cnVlLGVudW1lcmFibGU6ZmFsc2UsY29uZmlndXJhYmxlOmZhbHNlfX0pOyB3aW5kb3cuX19tUG9zLng9e3RhcmdldF94fTsgd2luZG93Ll9fbVBvcy55PXt0YXJnZXRfeX07IH19IgogICAgICAgICkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKCmRlZiBodW1hbl9jbGlja19lbGVtZW50KHBhZ2UsIGxvY2F0b3IsIHRpbWVvdXQ6IGludCA9IDUwMDApIC0+IGJvb2w6CiAgICAiIiJNb3ZlIG1vdXNlIHRvICpsb2NhdG9yKiB3aXRoIGEgQsOpemllciBwYXRoLCB0aGVuIGNsaWNrIHdpdGggYQogICAgc2xpZ2h0IHJhbmRvbSBvZmZzZXQgZnJvbSBjZW50ZXIuIFJldHVybnMgVHJ1ZSBvbiBzdWNjZXNzLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgbG9jYXRvci53YWl0X2ZvcihzdGF0ZT0idmlzaWJsZSIsIHRpbWVvdXQ9dGltZW91dCkKICAgICAgICBib3ggPSBsb2NhdG9yLmJvdW5kaW5nX2JveCh0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgaWYgbm90IGJveDoKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJodW1hbl9jbGlja19lbGVtZW50OiBubyBib3VuZGluZyBib3gsIGZhbGxpbmcgYmFjayB0byBkaXJlY3QgY2xpY2siKQogICAgICAgICAgICBsb2NhdG9yLmNsaWNrKHRpbWVvdXQ9dGltZW91dCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgIyBUYXJnZXQgYSByYW5kb20gcG9pbnQgd2l0aGluIHRoZSBlbGVtZW50IChub3QgZGVhZCBjZW50ZXIpCiAgICAgICAgb2Zmc2V0X3ggPSByYW5kb20udW5pZm9ybShib3hbIndpZHRoIl0gKiAwLjIsIGJveFsid2lkdGgiXSAqIDAuOCkKICAgICAgICBvZmZzZXRfeSA9IHJhbmRvbS51bmlmb3JtKGJveFsiaGVpZ2h0Il0gKiAwLjI1LCBib3hbImhlaWdodCJdICogMC43NSkKICAgICAgICB0YXJnZXRfeCA9IGJveFsieCJdICsgb2Zmc2V0X3gKICAgICAgICB0YXJnZXRfeSA9IGJveFsieSJdICsgb2Zmc2V0X3kKCiAgICAgICAgaHVtYW5fbW92ZV9tb3VzZShwYWdlLCB0YXJnZXRfeCwgdGFyZ2V0X3kpCiAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjA1LCAwLjIpKQoKICAgICAgICBwYWdlLm1vdXNlLmNsaWNrKHRhcmdldF94LCB0YXJnZXRfeSkKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXhjOgogICAgICAgIGxvZ2dlci5kZWJ1ZygiaHVtYW5fY2xpY2tfZWxlbWVudCBmYWlsZWQ6ICVzIiwgZXhjKQogICAgICAgIHRyeToKICAgICAgICAgICAgbG9jYXRvci5jbGljayh0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgoKIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKIyBJZGxlIFNpbXVsYXRpb24KIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKCmRlZiBpZGxlX3NsZWVwKHBhZ2UsIGR1cmF0aW9uOiBmbG9hdCkgLT4gTm9uZToKICAgICIiIlNsZWVwIGZvciAqZHVyYXRpb24qIHNlY29uZHMgd2hpbGUgcGVyZm9ybWluZyBvY2Nhc2lvbmFsCiAgICBtaWNyby1tb3VzZS1tb3ZlbWVudHMgYW5kIHRpbnkgc2Nyb2xscyB0byBzaW11bGF0ZSBhbiBpZGxlIHVzZXIuCiAgICAiIiIKICAgIHRocm90dGxlID0gZ2V0X3Rocm90dGxlKCkKICAgIGR1cmF0aW9uICo9IHRocm90dGxlLmRlbGF5X211bHRpcGxpZXIKCiAgICAjIENhY2hlIHZpZXdwb3J0IHNpemUgb25jZSAoYXZvaWRzIHJlcGVhdGVkIGV2YWx1YXRlKCkgY2FsbHMpCiAgICB0cnk6CiAgICAgICAgdnAgPSBwYWdlLnZpZXdwb3J0X3NpemUgb3Ige30KICAgICAgICB2dyA9IHZwLmdldCgid2lkdGgiLCAxMjgwKQogICAgICAgIHZoID0gdnAuZ2V0KCJoZWlnaHQiLCA4MDApCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHZ3LCB2aCA9IDEyODAsIDgwMAoKICAgIGVuZF90aW1lID0gdGltZS50aW1lKCkgKyBkdXJhdGlvbgogICAgd2hpbGUgdGltZS50aW1lKCkgPCBlbmRfdGltZToKICAgICAgICByZW1haW5pbmcgPSBlbmRfdGltZSAtIHRpbWUudGltZSgpCiAgICAgICAgaWYgcmVtYWluaW5nIDw9IDA6CiAgICAgICAgICAgIGJyZWFrCgogICAgICAgICMgRGVjaWRlIHdoYXQgdG8gZG8gaW4gdGhpcyBtaWNyby1pbnRlcnZhbAogICAgICAgIGFjdGlvbl9yb2xsID0gcmFuZG9tLnJhbmRvbSgpCgogICAgICAgIGlmIGFjdGlvbl9yb2xsIDwgMC4xMCBhbmQgcmVtYWluaW5nID4gMS41OgogICAgICAgICAgICAjIE1pY3JvIG1vdXNlIGRyaWZ0IChzbWFsbCByYW5kb20gbW92ZW1lbnQpIOKAkyBsZXNzIGZyZXF1ZW50CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG54ID0gcmFuZG9tLnVuaWZvcm0odncgKiAwLjEsIHZ3ICogMC45KQogICAgICAgICAgICAgICAgbnkgPSByYW5kb20udW5pZm9ybSh2aCAqIDAuMSwgdmggKiAwLjkpCiAgICAgICAgICAgICAgICBwYWdlLm1vdXNlLm1vdmUobngsIG55KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDAuNSwgMS41KSkKCiAgICAgICAgZWxpZiBhY3Rpb25fcm9sbCA8IDAuMTMgYW5kIHJlbWFpbmluZyA+IDEuMDoKICAgICAgICAgICAgIyBUaW55IHNjcm9sbCAoMS0zIG5vdGNoZXMpIOKAkyBsZXNzIGZyZXF1ZW50CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBhZ2UubW91c2Uud2hlZWwoMCwgcmFuZG9tLmNob2ljZShbLTMwLCAtMTUsIDE1LCAzMF0pKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDAuNCwgMC44KSkKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBKdXN0IHdhaXQgYSBiaXQgKGxvbmdlciBjaHVua3MgPSBmZXdlciBsb29wIGl0ZXJhdGlvbnMgPSBmZXdlciBwb3RlbnRpYWwgSlMgY2FsbHMpCiAgICAgICAgICAgIGNodW5rID0gbWluKHJhbmRvbS51bmlmb3JtKDIuMCwgNS4wKSwgcmVtYWluaW5nKQogICAgICAgICAgICB0aW1lLnNsZWVwKGNodW5rKQoKCiMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiMgRW5oYW5jZWQgVHlwaW5nCiMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACgpkZWYgaHVtYW5fdHlwZV9hZHZhbmNlZChwYWdlLCBsb2NhdG9yLCB0ZXh0OiBzdHIpIC0+IE5vbmU6CiAgICAiIiJUeXBlICp0ZXh0KiB3aXRoIHJlYWxpc3RpYyByaHl0aG06IGJ1cnN0LXR5cGUgd2l0aGluIHdvcmRzLAogICAgbG9uZ2VyIHBhdXNlcyBhdCB3b3JkIGJvdW5kYXJpZXMgYW5kIHB1bmN0dWF0aW9uLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgaHVtYW5fY2xpY2tfZWxlbWVudChwYWdlLCBsb2NhdG9yKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBsb2NhdG9yLmNsaWNrKCkKICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4zLCAwLjcpKQoKICAgIGZvciBpLCBjaGFyIGluIGVudW1lcmF0ZSh0ZXh0KToKICAgICAgICBsb2NhdG9yLnR5cGUoY2hhciwgZGVsYXk9MCkKCiAgICAgICAgIyBEZXRlcm1pbmUgZGVsYXkgYmFzZWQgb24gY29udGV4dAogICAgICAgIGlmIGNoYXIgaW4gKCIgIiwgIlxuIiwgIlx0Iik6CiAgICAgICAgICAgICMgV29yZCBib3VuZGFyeSDigJQgbG9uZ2VyIHBhdXNlCiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4xMCwgMC4zMCkpCiAgICAgICAgZWxpZiBjaGFyIGluICgiLiIsICIsIiwgIiEiLCAiPyIsICI7IiwgIjoiKToKICAgICAgICAgICAgIyBQdW5jdHVhdGlvbiDigJQgc2xpZ2h0IHBhdXNlCiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4xMiwgMC4zNSkpCiAgICAgICAgZWxpZiBjaGFyID09ICIjIjoKICAgICAgICAgICAgIyBIYXNodGFnIHN0YXJ0IOKAlCBicmllZiBoZXNpdGF0aW9uCiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4xNSwgMC40MCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBOb3JtYWwga2V5c3Ryb2tlIOKAlCBmYXN0IGJ1cnN0CiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4wMywgMC4xMikpCgogICAgICAgICMgT2NjYXNpb25hbCBsb25nZXIgcGF1c2UgKHRoaW5raW5nKQogICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IDAuMDM6CiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC40LCAxLjIpKQoKICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4zLCAwLjgpKQoKCiMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiMgU21vb3RoIFNjcm9sbGluZwojIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAoKZGVmIHNtb290aF9zY3JvbGwocGFnZSwgZGlyZWN0aW9uOiBzdHIsIGRpc3RhbmNlOiBpbnQsIHN0ZXBzOiBpbnQgPSBOb25lKSAtPiBOb25lOgogICAgIiIiU2Nyb2xsIHNtb290aGx5IHVzaW5nIHNtYWxsIG1vdXNlIHdoZWVsIGV2ZW50cy4KCiAgICBPcHRpbWl6ZWQgZm9yIGZsdWlkaXR5IChoaWdoZXIgZXZlbnQgcmF0ZSkgdG8gYXZvaWQgdmlzdWFsIHN0dXR0ZXJpbmcuCiAgICAiIiIKICAgIGlmIHN0ZXBzIGlzIE5vbmU6CiAgICAgICAgIyBTdGVwcyBiYXNlZCBvbiBkaXN0YW5jZSBidXQgZW5zdXJpbmcgc21vb3RobmVzcwogICAgICAgICMgVGFyZ2V0IH4xNS0yNXB4IHBlciBzdGVwIGZvciBmbHVpZCBtb3Rpb24KICAgICAgICBzdGVwcyA9IG1heCgxMCwgaW50KGRpc3RhbmNlIC8gMjApKQogICAgCiAgICAjIFJhbmRvbWl6ZSBzdGVwIHNpemVzIHNsaWdodGx5IGZvciBodW1hbiB2YXJpYW5jZQogICAgc3RlcF9hbW91bnRzID0gW10KICAgIHJlbWFpbmluZyA9IGRpc3RhbmNlCiAgICBmb3IgXyBpbiByYW5nZShzdGVwcyAtIDEpOgogICAgICAgICMgQXZlcmFnZSBzdGVwIHNpemUgYXJvdW5kIGRpc3RhbmNlL3N0ZXBzCiAgICAgICAgYXZnID0gcmVtYWluaW5nIC8gKHN0ZXBzIC0gbGVuKHN0ZXBfYW1vdW50cykpCiAgICAgICAgYW10ID0gaW50KHJhbmRvbS5nYXVzcyhhdmcsIGF2ZyAqIDAuMikpICMgR2F1c3NpYW4gdmFyaWFuY2UKICAgICAgICBhbXQgPSBtYXgoMSwgYW10KQogICAgICAgIHN0ZXBfYW1vdW50cy5hcHBlbmQoYW10KQogICAgICAgIHJlbWFpbmluZyAtPSBhbXQKICAgIHN0ZXBfYW1vdW50cy5hcHBlbmQocmVtYWluaW5nKQoKICAgIHNpZ24gPSAxIGlmIGRpcmVjdGlvbiA9PSAiZG93biIgZWxzZSAtMQogICAgCiAgICAjIFBlcmZvcm0gdGhlIHNjcm9sbCB3aXRoIHZlcnkgc2hvcnQgZGVsYXlzIGZvciBoaWdoIGZyYW1lIHJhdGUgKH42MGZwcyB0YXJnZXQpCiAgICBmb3IgYW10IGluIHN0ZXBfYW1vdW50czoKICAgICAgICBwYWdlLm1vdXNlLndoZWVsKDAsIHNpZ24gKiBhbXQpCiAgICAgICAgIyBTbGVlcCA1LTEybXMgcGVyIGV2ZW50IC0+IH44MC0xNjAgZXZlbnRzL3NlYyAodmVyeSBzbW9vdGgpCiAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjAwNSwgMC4wMTIpKQoKICAgICMgU21hbGwgcGF1c2UgYWZ0ZXIgc2Nyb2xsIGNvbXBsZXRlcwogICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjMsIDAuNykpCgoKZGVmIGh1bWFuX3Njcm9sbF9uZXh0X3ZpZGVvKHBhZ2UpIC0+IE5vbmU6CiAgICAiIiJBZHZhbmNlIHRvIHRoZSBuZXh0IGZlZWQgaXRlbSB1c2luZyBUaWtUb2sncyBuYXRpdmUgc25hcCBzY3JvbGwuCgogICAgVGlrVG9rJ3MgRm9yLVlvdSBwYWdlIHVzZXMgQ1NTIHNjcm9sbC1zbmFwLCBzbyBrZXlib2FyZCBBcnJvd0Rvd24KICAgIGNsZWFubHkgdHJpZ2dlcnMgYSBzbmFwLXRvLW5leHQtdmlkZW8gdHJhbnNpdGlvbi4gIEF2b2lkIG1hbnkgdGlueQogICAgbW91c2Uud2hlZWwgZXZlbnRzIHdoaWNoIGZpZ2h0IHRoZSBzbmFwIGFuZCBjYXVzZSBjaG9wcGluZXNzLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgbW9kZSA9IHJhbmRvbS5jaG9pY2VzKAogICAgICAgICAgICBbImtleSIsICJ3aGVlbCIsICJtaXhlZCJdLAogICAgICAgICAgICB3ZWlnaHRzPVswLjY1LCAwLjIwLCAwLjE1XSwKICAgICAgICAgICAgaz0xLAogICAgICAgIClbMF0KCiAgICAgICAgaWYgbW9kZSA9PSAia2V5IjoKICAgICAgICAgICAgIyBBcnJvd0Rvd24gdHJpZ2dlcnMgVGlrVG9rJ3MgbmF0aXZlIHNuYXAtdG8tbmV4dAogICAgICAgICAgICBwYWdlLmtleWJvYXJkLnByZXNzKCJBcnJvd0Rvd24iKQogICAgICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDAuMywgMC42KSkKCiAgICAgICAgZWxpZiBtb2RlID09ICJ3aGVlbCI6CiAgICAgICAgICAgICMgU2luZ2xlIGxhcmdlIHdoZWVsIGV2ZW50IOKAlCBUaWtUb2sgc25hcHMgdG8gdGhlIG5leHQgdmlkZW8KICAgICAgICAgICAgdnAgPSBwYWdlLnZpZXdwb3J0X3NpemUKICAgICAgICAgICAgZGlzdGFuY2UgPSAodnBbImhlaWdodCJdIGlmIHZwIGVsc2UgODAwKSAqIHJhbmRvbS51bmlmb3JtKDAuODUsIDEuMCkKICAgICAgICAgICAgcGFnZS5tb3VzZS53aGVlbCgwLCBpbnQoZGlzdGFuY2UpKQogICAgICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDAuNCwgMC44KSkKCiAgICAgICAgZWxzZTogICMgbWl4ZWQKICAgICAgICAgICAgIyBLZXlib2FyZCBzbmFwICsgc21hbGwgc2V0dGxpbmcgd2hlZWwKICAgICAgICAgICAgcGFnZS5rZXlib2FyZC5wcmVzcygiQXJyb3dEb3duIikKICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjMsIDAuNSkpCiAgICAgICAgICAgIHBhZ2UubW91c2Uud2hlZWwoMCwgcmFuZG9tLnJhbmRpbnQoMjAsIDYwKSkKICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjIsIDAuNCkpCgogICAgICAgICMgT2NjYXNpb25hbCB0aW55IGNvcnJlY3Rpb24gKGh1bWFuLWxpa2UpCiAgICAgICAgaWYgcmFuZG9tLnJhbmRvbSgpIDwgMC4xMDoKICAgICAgICAgICAgcGFnZS5tb3VzZS53aGVlbCgwLCByYW5kb20ucmFuZGludCgtNDAsIC0xNSkpCiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4yLCAwLjQpKQoKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgdHJ5OgogICAgICAgICAgICBwYWdlLmtleWJvYXJkLnByZXNzKCJBcnJvd0Rvd24iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDAuNiwgMS4yKSkKCgpkZWYgaHVtYW5fcHJvZmlsZV93YXJtdXAocGFnZSkgLT4gTm9uZToKICAgICIiIlNpbXVsYXRlIGJyaWVmIHByb2ZpbGUgcmVhZGluZyBiZWhhdmlvciBiZWZvcmUgdGFraW5nIGFjdGlvbnMuIiIiCiAgICAjIEluaXRpYWwgcmVhZCBwYXVzZS4KICAgIGlkbGVfc2xlZXAocGFnZSwgcmFuZG9tLnVuaWZvcm0oMS4wLCAyLjUpKQoKICAgICMgSG92ZXIgbGlrZWx5IGludGVyYWN0aXZlIHByb2ZpbGUgZWxlbWVudHMuCiAgICBob3Zlcl9zZWxlY3RvcnMgPSBbCiAgICAgICAgJ1tkYXRhLWUyZT0idXNlci10aXRsZSJdJywKICAgICAgICAnW2RhdGEtZTJlPSJmb2xsb3ctYnV0dG9uIl0nLAogICAgICAgICdhW2hyZWYqPSIvdmlkZW8vIl0nLAogICAgICAgICdbZGF0YS1lMmU9ImZvbGxvd2Vycy1jb3VudCJdJywKICAgIF0KICAgIHJhbmRvbS5zaHVmZmxlKGhvdmVyX3NlbGVjdG9ycykKCiAgICBmb3Igc2VsIGluIGhvdmVyX3NlbGVjdG9yc1s6IHJhbmRvbS5yYW5kaW50KDEsIDMpXToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGVsID0gcGFnZS5sb2NhdG9yKHNlbCkuZmlyc3QKICAgICAgICAgICAgaWYgZWwuaXNfdmlzaWJsZSh0aW1lb3V0PTgwMCk6CiAgICAgICAgICAgICAgICBib3ggPSBlbC5ib3VuZGluZ19ib3godGltZW91dD0xMjAwKQogICAgICAgICAgICAgICAgaWYgYm94OgogICAgICAgICAgICAgICAgICAgIHR4ID0gYm94WyJ4Il0gKyByYW5kb20udW5pZm9ybShib3hbIndpZHRoIl0gKiAwLjI1LCBib3hbIndpZHRoIl0gKiAwLjc1KQogICAgICAgICAgICAgICAgICAgIHR5ID0gYm94WyJ5Il0gKyByYW5kb20udW5pZm9ybShib3hbImhlaWdodCJdICogMC4yNSwgYm94WyJoZWlnaHQiXSAqIDAuNzUpCiAgICAgICAgICAgICAgICAgICAgaHVtYW5fbW92ZV9tb3VzZShwYWdlLCB0eCwgdHkpCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjIsIDAuNykpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgY29udGludWUKCiAgICAjIFRpbnkgcmVhZCBzY3JvbGwgcGF0dGVybi4KICAgIHRyeToKICAgICAgICBzbW9vdGhfc2Nyb2xsKHBhZ2UsIGRpcmVjdGlvbj0iZG93biIsIGRpc3RhbmNlPXJhbmRvbS5yYW5kaW50KDEyMCwgNDIwKSkKICAgICAgICBpZiByYW5kb20ucmFuZG9tKCkgPCAwLjM1OgogICAgICAgICAgICBzbW9vdGhfc2Nyb2xsKHBhZ2UsIGRpcmVjdGlvbj0idXAiLCBkaXN0YW5jZT1yYW5kb20ucmFuZGludCg2MCwgMTgwKSkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKICAgIGlkbGVfc2xlZXAocGFnZSwgcmFuZG9tLnVuaWZvcm0oMC42LCAxLjUpKQoKCmRlZiBodW1hbl9oYXNodGFnX3dhcm11cChwYWdlKSAtPiBOb25lOgogICAgIiIiU2ltdWxhdGUgYnJpZWYgYnJvd3Npbmcgb24gYSBoYXNodGFnL3RhZyBwYWdlIGJlZm9yZSBzY3JhcGluZy4KICAgIFJlZHVjZXMgQ0FQVENIQSBieSBzaG93aW5nIGh1bWFuLWxpa2UgYWN0aXZpdHkgYmVmb3JlIERPTSBxdWVyaWVzLgogICAgIiIiCiAgICBpZGxlX3NsZWVwKHBhZ2UsIHJhbmRvbS51bmlmb3JtKDEuNSwgMy4wKSkKICAgIHRyeToKICAgICAgICBzbW9vdGhfc2Nyb2xsKHBhZ2UsIGRpcmVjdGlvbj0iZG93biIsIGRpc3RhbmNlPXJhbmRvbS5yYW5kaW50KDgwLCAyNTApKQogICAgICAgIGlkbGVfc2xlZXAocGFnZSwgcmFuZG9tLnVuaWZvcm0oMS4wLCAyLjUpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgoKZGVmIGh1bWFuX21vdXNlX3dhcm11cChwYWdlLCBzdGVwczogaW50ID0gMTgpIC0+IE5vbmU6CiAgICAiIiJTbWFsbC1zdGVwIGppdHRlcmVkIG1vdXNlIG1vdmUgdG8gYSByYW5kb20gcG9pbnQgaW4gdmlld3BvcnQuCiAgICBDYWxsIGJlZm9yZSBzZW5zaXRpdmUgYWN0aW9ucyAoaGFzaHRhZyBsb2FkLCBwcm9maWxlIGxvYWQpIHRvIHNob3cgaW50ZXJhY3Rpb24uCiAgICBTeW5jIHZlcnNpb24gZm9yIFBsYXl3cmlnaHQgc3luY19hcGkuCiAgICAiIiIKICAgIHRyeToKICAgICAgICB2aWV3cG9ydCA9IHBhZ2Uudmlld3BvcnRfc2l6ZSBvciB7IndpZHRoIjogMTI4MCwgImhlaWdodCI6IDcyMH0KICAgICAgICB3LCBoID0gdmlld3BvcnQuZ2V0KCJ3aWR0aCIsIDEyODApLCB2aWV3cG9ydC5nZXQoImhlaWdodCIsIDcyMCkKICAgICAgICAjIFRhcmdldDogcmFuZG9tIHBvaW50IGluIGNlbnRlciA2MCUgb2Ygdmlld3BvcnQKICAgICAgICB0eCA9IHcgKiAoMC4yICsgcmFuZG9tLnVuaWZvcm0oMCwgMC42KSkKICAgICAgICB0eSA9IGggKiAoMC4yICsgcmFuZG9tLnVuaWZvcm0oMCwgMC42KSkKICAgICAgICBzdGFydCA9IHBhZ2UuZXZhbHVhdGUoIiIiKCkgPT4gKHsgeDogd2luZG93LmlubmVyV2lkdGggLyAyLCB5OiB3aW5kb3cuaW5uZXJIZWlnaHQgLyAyIH0pIiIiKQogICAgICAgIHN4LCBzeSA9IHN0YXJ0LmdldCgieCIsIHcgLyAyKSwgc3RhcnQuZ2V0KCJ5IiwgaCAvIDIpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMSwgc3RlcHMgKyAxKToKICAgICAgICAgICAgdCA9IGkgLyBzdGVwcwogICAgICAgICAgICAjIFNsaWdodCBjdXJ2ZSAobm90IGxpbmVhcikgZm9yIHJlYWxpc20KICAgICAgICAgICAganggPSAwLjA4ICogbWF0aC5zaW4odCAqIG1hdGgucGkgKiAyKQogICAgICAgICAgICBqeSA9IDAuMDUgKiBtYXRoLmNvcyh0ICogbWF0aC5waSAqIDIpCiAgICAgICAgICAgIGN4ID0gc3ggKyAodHggLSBzeCkgKiAodCArIGp4KQogICAgICAgICAgICBjeSA9IHN5ICsgKHR5IC0gc3kpICogKHQgKyBqeSkKICAgICAgICAgICAgcGFnZS5tb3VzZS5tb3ZlKGN4LCBjeSwgc3RlcHM9MSkKICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjAwOCwgMC4wMjIpKQogICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMC4zLCAwLjkpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgoKIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKIyBDQVBUQ0hBICYgUmF0ZS1MaW1pdCBEZXRlY3Rpb24KIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKCkNBUFRDSEFfSU5ESUNBVE9SUyA9IFsKICAgICJ2ZXJpZnkgeW91IGFyZSBodW1hbiIsCiAgICAidmVyaWZ5IHlvdXIgaWRlbnRpdHkiLAogICAgInNlY3VyaXR5IHZlcmlmaWNhdGlvbiIsCiAgICAic2xpZGUgdG8gdmVyaWZ5IiwKICAgICJkcmFnIHRoZSBzbGlkZXIiLAogICAgImZpdCB0aGUgcHV6emxlIiwKICAgICJmaXggdGhlIHB1enpsZSIsCiAgICAiY2FwdGNoYSIsCiAgICAidW51c3VhbCBhY3Rpdml0eSIsCiAgICAidG9vIG1hbnkgcmVxdWVzdHMiLAogICAgInRyeSBhZ2FpbiBsYXRlciIsCiAgICAidGVtcG9yYXJpbHkgdW5hdmFpbGFibGUiLAogICAgImFjY2VzcyBkZW5pZWQiLAogICAgInJhdGUgbGltaXQiLAogICAgInNlbGVjdCAyIG9iamVjdHMiLAogICAgInNlbGVjdCB0aGUgaW1hZ2UiLApdCgpDQVBUQ0hBX1NFTEVDVE9SUyA9IFsKICAgICdbZGF0YS1lMmU9ImNhcHRjaGEtdmVyaWZ5LWNvbnRhaW5lciJdJywKICAgICdbSUQ9ImNhcHRjaGFfY29udGFpbmVyIl0nLAogICAgJ2lmcmFtZVtzcmMqPSJjYXB0Y2hhIl0nLAogICAgJ1tjbGFzcyo9InRpa3Rvay12ZXJpZnkiXScsCiAgICAnW2NsYXNzKj0ic2Vjc2RrLWNhcHRjaGEiXScsCiAgICAjIFRpa1RvayBzbGlkZXIgcHV6emxlIG1vZGFsIChCeXRlRGFuY2Ugc2Vjc2RrKQogICAgJ1tjbGFzcyo9InNlY3NkayJdJywKICAgICdkaXZbcm9sZT0iZGlhbG9nIl1bY2xhc3MqPSJWZXJpZnkiXScsCiAgICAnW2NsYXNzKj0iVmVyaWZ5Il0gW2NsYXNzKj0ibW9kYWwiXScsCiAgICAjIFNwZWNpZmljIENBUFRDSEEgYnV0dG9uL2VsZW1lbnQgc2VsZWN0b3JzIChOT1QgZ2VuZXJpYyBkaXNhYmxlZCBidXR0b25zKQogICAgJ2J1dHRvbltjbGFzcyo9ImNhcHRjaGEiXScsCiAgICAnYnV0dG9uW2NsYXNzKj0ic2Vjc2RrIl0nLAogICAgJ1tjbGFzcyo9InB1enpsZSJdJywKICAgICdbY2xhc3MqPSJkcmFnLWljb24iXScsCiAgICAjIFNwZWNpZmljIElEIGZvciBUaWtUb2sgc2xpZGVyIENBUFRDSEEKICAgICcjY2FwdGNoYV9zbGlkZV9idXR0b24nLAogICAgJ2J1dHRvbiNjYXB0Y2hhX3NsaWRlX2J1dHRvbicsCiAgICAjIENsYXNzIHBhdHRlcm5zIGZyb20gYWN0dWFsIFRpa1RvayBDQVBUQ0hBCiAgICAnW2NsYXNzKj0ic2Vjc2RrLWNhcHRjaGEtZHJhZy1pY29uIl0nLAogICAgJ2J1dHRvbltjbGFzcyo9InNlY3Nkay1jYXB0Y2hhIl0nLApdCgojIFNlbGVjdG9ycyB0aGF0IGluZGljYXRlIGEgbGVnaXRpbWF0ZSBkaWFsb2cgKE5PVCBhIENBUFRDSEEpCkxFR0lUSU1BVEVfRElBTE9HX1NFTEVDVE9SUyA9IFsKICAgICdbZGF0YS1lMmU9ImxvZ2luLWJ1dHRvbiJdJywgICMgTG9naW4gcHJvbXB0CiAgICAnW2RhdGEtZTJlPSJzaWdudXAtYnV0dG9uIl0nLCAgIyBTaWdudXAgcHJvbXB0CiAgICAnYnV0dG9uOmhhcy10ZXh0KCJMb2cgaW4iKScsCiAgICAnYnV0dG9uOmhhcy10ZXh0KCJTaWduIHVwIiknLApdCgoKZGVmIF9kZXRlY3RfY2FwdGNoYV9pbl9zaGFkb3dfZG9tKHBhZ2UpIC0+IHN0ciB8IE5vbmU6CiAgICAiIiJDaGVjayBmb3IgQ0FQVENIQSBlbGVtZW50cyBpbnNpZGUgc2hhZG93IERPTS4KICAgIAogICAgVGlrVG9rJ3MgQ0FQVENIQSBtYXkgYmUgcmVuZGVyZWQgaW5zaWRlIHNoYWRvdyBET00gd2hpY2ggbm9ybWFsCiAgICBQbGF5d3JpZ2h0IHNlbGVjdG9ycyBjYW4ndCByZWFjaC4KICAgICIiIgogICAgdHJ5OgogICAgICAgICMgVXNlIEphdmFTY3JpcHQgdG8gdHJhdmVyc2Ugc2hhZG93IERPTQogICAgICAgIHJlc3VsdCA9IHBhZ2UuZXZhbHVhdGUoIiIiKCkgPT4gewogICAgICAgICAgICAvLyBGdW5jdGlvbiB0byByZWN1cnNpdmVseSBzZWFyY2ggc2hhZG93IERPTQogICAgICAgICAgICBmdW5jdGlvbiBzZWFyY2hTaGFkb3dSb290KHJvb3QsIGRlcHRoID0gMCkgewogICAgICAgICAgICAgICAgaWYgKGRlcHRoID4gNSkgcmV0dXJuIG51bGw7IC8vIExpbWl0IHJlY3Vyc2lvbiBkZXB0aAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgQ0FQVENIQSBlbGVtZW50cyAoc3BlY2lmaWMgcGF0dGVybnMgb25seSDigJQgYXZvaWQgYnJvYWQgbWF0Y2hlcwogICAgICAgICAgICAgICAgLy8gbGlrZSAic2xpZGVyIiB3aGljaCBtYXRjaCBUaWtUb2sncyB1cGxvYWQgcHJvZ3Jlc3MgYmFyKQogICAgICAgICAgICAgICAgY29uc3QgY2FwdGNoYVNlbGVjdG9ycyA9IFsKICAgICAgICAgICAgICAgICAgICAnW2NsYXNzKj0ic2Vjc2RrLWNhcHRjaGEiXScsCiAgICAgICAgICAgICAgICAgICAgJ1tjbGFzcyo9ImNhcHRjaGEiXScsCiAgICAgICAgICAgICAgICAgICAgJyNjYXB0Y2hhX3NsaWRlX2J1dHRvbicsCiAgICAgICAgICAgICAgICAgICAgJ2J1dHRvblthcmlhLWRpc2FibGVkPSJ0cnVlIl1bY2xhc3MqPSJzZWNzZGsiXScsCiAgICAgICAgICAgICAgICAgICAgJ1tjbGFzcyo9ImRyYWctaWNvbiJdJywKICAgICAgICAgICAgICAgICAgICAnW2NsYXNzKj0icHV6emxlIl0nCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHNlbCBvZiBjYXB0Y2hhU2VsZWN0b3JzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSByb290LnF1ZXJ5U2VsZWN0b3Ioc2VsKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHNlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWw6IGVsLm91dGVySFRNTC5zdWJzdHJpbmcoMCwgMzAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWU6IGVsLnRhZ05hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6IGVsLmNsYXNzTmFtZQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU2VhcmNoIHNoYWRvdyByb290cwogICAgICAgICAgICAgICAgY29uc3QgYWxsRWxlbWVudHMgPSByb290LnF1ZXJ5U2VsZWN0b3JBbGwoJyonKTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZWwgb2YgYWxsRWxlbWVudHMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwuc2hhZG93Um9vdCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBzZWFyY2hTaGFkb3dSb290KGVsLnNoYWRvd1Jvb3QsIGRlcHRoICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgc2VhcmNoIGZyb20gZG9jdW1lbnQKICAgICAgICAgICAgcmV0dXJuIHNlYXJjaFNoYWRvd1Jvb3QoZG9jdW1lbnQpOwogICAgICAgIH0iIiIpCiAgICAgICAgCiAgICAgICAgaWYgcmVzdWx0IGFuZCByZXN1bHQuZ2V0KCdmb3VuZCcpOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygKICAgICAgICAgICAgICAgICJbU0hBRE9XIERPTSBDQVBUQ0hBXSBGb3VuZDogJXMsIGNsYXNzPSVzLCBodG1sPSVzLi4uIiwKICAgICAgICAgICAgICAgIHJlc3VsdC5nZXQoJ3NlbGVjdG9yJyksIHJlc3VsdC5nZXQoJ2NsYXNzTmFtZScsICcnKVs6NTBdLCByZXN1bHQuZ2V0KCdodG1sJywgJycpWzoxMDBdCiAgICAgICAgICAgICkKICAgICAgICAgICAgcmV0dXJuIGYic2hhZG93X2RvbTp7cmVzdWx0LmdldCgnc2VsZWN0b3InKX0iCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nZ2VyLmRlYnVnKCJbU0hBRE9XIERPTV0gRXJyb3Igc2VhcmNoaW5nIHNoYWRvdyBET006ICVzIiwgZSkKICAgIAogICAgcmV0dXJuIE5vbmUKCgpkZWYgZGV0ZWN0X2NoYWxsZW5nZShwYWdlLCBwaGFzZTogc3RyIHwgTm9uZSA9IE5vbmUpIC0+IHN0ciB8IE5vbmU6CiAgICAiIiJDaGVjayBpZiB0aGUgY3VycmVudCBwYWdlIHNob3dzIGEgQ0FQVENIQSBvciByYXRlLWxpbWl0IGNoYWxsZW5nZS4KCiAgICBSZXR1cm5zIGEgZGVzY3JpcHRpb24gc3RyaW5nIGlmIGEgY2hhbGxlbmdlIGlzIGRldGVjdGVkLCBvciBOb25lLgogICAgcGhhc2U6IE9wdGlvbmFsIGxhYmVsIChmZWVkLCBoYXNodGFnLCBwcm9maWxlLCB1cGxvYWQsIGV0Yy4pIHRvIGdhdGUKICAgICAgICAgICBwaGFzZS1zcGVjaWZpYyBkZXRlY3Rpb24gbG9naWMgYW5kIGF2b2lkIGZhbHNlIHBvc2l0aXZlcy4KICAgICIiIgogICAgdHJ5OgogICAgICAgICMgQ2hlY2sgVVJMLWJhc2VkIHJlZGlyZWN0cwogICAgICAgIHVybCA9IHBhZ2UudXJsLmxvd2VyKCkKICAgICAgICBpZiAiY2FwdGNoYSIgaW4gdXJsIG9yICJjaGFsbGVuZ2UiIGluIHVybDoKICAgICAgICAgICAgIHJldHVybiBmImNoYWxsZW5nZV91cmw6e3VybH0iCgogICAgICAgICMg4pSA4pSAIENoZWNrIHNoYWRvdyBET00gZm9yIENBUFRDSEEgZWxlbWVudHMg4pSA4pSACiAgICAgICAgc2hhZG93X3Jlc3VsdCA9IF9kZXRlY3RfY2FwdGNoYV9pbl9zaGFkb3dfZG9tKHBhZ2UpCiAgICAgICAgaWYgc2hhZG93X3Jlc3VsdDoKICAgICAgICAgICAgcmV0dXJuIHNoYWRvd19yZXN1bHQKCiAgICAgICAgIyDilIDilIAgQ2hlY2sgZm9yIENBUFRDSEEgZGlhbG9ncyBvbiBwcm9maWxlIHBhZ2VzIG9ubHkg4pSA4pSACiAgICAgICAgIyBTa2lwIHRoaXMgY2hlY2sgb24gdXBsb2FkIHBhZ2VzIOKAlCBUaWtUb2sncyB1cGxvYWQgVUkgdXNlcyBkaWFsb2dzCiAgICAgICAgIyBmb3Igbm9ybWFsIGZ1bmN0aW9uYWxpdHkgKHRvcGljIHNlbGVjdGlvbiwgZHVldCBzZXR0aW5ncywgZXRjLikgd2hpY2gKICAgICAgICAjIHdvdWxkIG90aGVyd2lzZSBjYXVzZSBmYWxzZS1wb3NpdGl2ZSBDQVBUQ0hBIGRldGVjdGlvbi4KICAgICAgICBpZiBwaGFzZSAhPSAidXBsb2FkIjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGlhbG9nID0gcGFnZS5sb2NhdG9yKCdkaXZbcm9sZT0iZGlhbG9nIl0nKS5maXJzdAogICAgICAgICAgICAgICAgaWYgZGlhbG9nLmlzX3Zpc2libGUodGltZW91dD0zMDApOgogICAgICAgICAgICAgICAgICAgICMgQ2hlY2sgaWYgdGhpcyBpcyBhIGxlZ2l0aW1hdGUgZGlhbG9nIChsb2dpbi9zaWdudXAgcHJvbXB0KQogICAgICAgICAgICAgICAgICAgIGlzX2xlZ2l0aW1hdGUgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGZvciBsZWdpdF9zZWwgaW4gTEVHSVRJTUFURV9ESUFMT0dfU0VMRUNUT1JTOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBwYWdlLmxvY2F0b3IobGVnaXRfc2VsKS5maXJzdC5pc192aXNpYmxlKHRpbWVvdXQ9MjAwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc19sZWdpdGltYXRlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICAgICBpZiBub3QgaXNfbGVnaXRpbWF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBDaGVjayBkaWFsb2cgY29udGVudCBmb3IgZXhwbGljaXQgQ0FQVENIQSBrZXl3b3JkcyBvbmx5CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ190ZXh0ID0gZGlhbG9nLmlubmVyX3RleHQodGltZW91dD01MDApLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ19odG1sID0gZGlhbG9nLmV2YWx1YXRlKCJlbCA9PiBlbC5vdXRlckhUTUwiKVs6NTAwXQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiW0NBUFRDSEEgREVURUNUSU9OXSBEaWFsb2cgZm91bmQgKHBoYXNlPSVzKS4gVGV4dDogJXMuLi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBoYXNlIG9yICJ1bmtub3duIiwgZGlhbG9nX3RleHRbOjEwMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGNoYV9rZXl3b3JkcyA9IFsic2xpZGVyIiwgInB1enpsZSIsICJkcmFnIiwgInZlcmlmeSIsICJjYXB0Y2hhIiwgImZpdCIsICJyb3RhdGUiXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGtleXdvcmQgaW4gY2FwdGNoYV9rZXl3b3JkczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBrZXl3b3JkIGluIGRpYWxvZ190ZXh0IG9yIGtleXdvcmQgaW4gZGlhbG9nX2h0bWwubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYiZGlhbG9nX2NhcHRjaGE6e2tleXdvcmR9IgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgT25seSBmbGFnIGFzIHN1c3BpY2lvdXMgb24gcHJvZmlsZSBwYWdlcyDigJQgZWxzZXdoZXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGRpYWxvZ3MgYXJlIG5vcm1hbCBVSSAoc2V0dGluZ3MsIHRlcm1zLCB0b29sdGlwcywgZXRjLikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICIvQCIgaW4gdXJsIGFuZCAic2VhcmNoIiBub3QgaW4gdXJsOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiW0NBUFRDSEEgREVURUNUSU9OXSBVbmV4cGVjdGVkIGRpYWxvZyBvbiBwcm9maWxlIHBhZ2UgLSB0cmVhdGluZyBhcyBDQVBUQ0hBIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gInVuZXhwZWN0ZWRfZGlhbG9nX29uX3Byb2ZpbGUiCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiW0NBUFRDSEEgREVURUNUSU9OXSBFcnJvciBjaGVja2luZyBkaWFsb2cgY29udGVudDogJXMiLCBlKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIENoZWNrIGZvciBDQVBUQ0hBIERPTSBlbGVtZW50cwogICAgICAgIGZvciBzZWwgaW4gQ0FQVENIQV9TRUxFQ1RPUlM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGVsID0gcGFnZS5sb2NhdG9yKHNlbCkuZmlyc3QKICAgICAgICAgICAgICAgIGlmIGVsLmlzX3Zpc2libGUodGltZW91dD01MDApOgogICAgICAgICAgICAgICAgICAgICMgTG9nIHdoYXQgd2UgZm91bmQgdG8gZGVidWcgZmFsc2UgcG9zaXRpdmVzCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBodG1sX3NuaXBwZXQgPSBlbC5ldmFsdWF0ZSgiZWwgPT4gZWwub3V0ZXJIVE1MIilbOjIwMF0KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlBvdGVudGlhbCBDQVBUQ0hBIGVsZW1lbnQgZm91bmQgKCVzKTogJXMiLCBzZWwsIGh0bWxfc25pcHBldCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYiY2FwdGNoYV9lbGVtZW50OntzZWx9IgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgIyBDaGVjayBwYWdlIHRleHQgZm9yIHJhdGUtbGltaXQgbGFuZ3VhZ2UKICAgICAgICAjIE9ubHkgY2hlY2sgc3BlY2lmaWMgZXJyb3IgY29udGFpbmVycywgbm90IGVudGlyZSBib2R5ICh0b28gc2xvdyAmIG5vaXN5KQogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDb21tb24gZXJyb3IgY29udGFpbmVycwogICAgICAgICAgICBmb3IgY29udGFpbmVyIGluIFsnW2RhdGEtZTJlPSJlcnJvci1wYWdlIl0nLCAnZGl2W3JvbGU9ImRpYWxvZyJdJywgJ2JvZHknXToKICAgICAgICAgICAgICAgICBpZiBub3QgZWxlbWVudF9leGlzdHMocGFnZSwgY29udGFpbmVyKToKICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICB0ZXh0ID0gcGFnZS5sb2NhdG9yKGNvbnRhaW5lcikuZmlyc3QuaW5uZXJfdGV4dCh0aW1lb3V0PTUwMCkubG93ZXIoKQogICAgICAgICAgICAgICAgIGZvciBpbmRpY2F0b3IgaW4gQ0FQVENIQV9JTkRJQ0FUT1JTOgogICAgICAgICAgICAgICAgICAgICBpZiBpbmRpY2F0b3IgaW4gdGV4dDoKICAgICAgICAgICAgICAgICAgICAgICAgICMgRG91YmxlIGNoZWNrIHN0cmluZyBsZW5ndGggdG8gYXZvaWQgbWF0Y2hpbmcgbG9uZyBwYXJhZ3JhcGhzCiAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4odGV4dCkgPCA1MDA6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmInRleHRfbWF0Y2g6e2luZGljYXRvcn0iCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgIHBhc3MKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4YzoKICAgICAgICBsb2dnZXIuZGVidWcoImRldGVjdF9jaGFsbGVuZ2UgZXJyb3I6ICVzIiwgZXhjKQoKICAgIHJldHVybiBOb25lCgoKZGVmIGhhbmRsZV9jaGFsbGVuZ2UocGFnZSwgcGhhc2U6IHN0ciB8IE5vbmUgPSBOb25lLCBjYXB0dXJlX2RlYnVnOiBib29sIHwgTm9uZSA9IE5vbmUpIC0+IGJvb2w6CiAgICAiIiJJZiBhIGNoYWxsZW5nZSBpcyBkZXRlY3RlZCwgdHJ5IHRvIGRpc21pc3MgaXQsIHRoZW4gYmFjayBvZmYuCgogICAgcGhhc2U6IE9wdGlvbmFsIGxhYmVsIChmZWVkLCBoYXNodGFnLCBwcm9maWxlLCBzdWdnZXN0ZWQsIHVwbG9hZCkgZm9yIGxvZ3MgYW5kIGRlYnVnIGNhcHR1cmUuCiAgICBjYXB0dXJlX2RlYnVnOiBJZiBUcnVlLCBzYXZlIHNjcmVlbnNob3QgKyBIVE1MIHRvIGRlYnVnLyB3aGVuIGNoYWxsZW5nZSBpcyBkZXRlY3RlZC4KICAgIFJldHVybnMgVHJ1ZSBpZiBhIGNoYWxsZW5nZSB3YXMgZm91bmQsIEZhbHNlIGlmIHBhZ2UgaXMgY2xlYW4uCiAgICAiIiIKICAgICMg4pSA4pSAIERJQUdOT1NUSUM6IExvZyBwYWdlIHN0YXRlIGJlZm9yZSBjaGFsbGVuZ2UgZGV0ZWN0aW9uIOKUgOKUgAogICAgdHJ5OgogICAgICAgIHVybCA9IHBhZ2UudXJsCiAgICAgICAgZGlhZ19zdGF0ZSA9IHBhZ2UuZXZhbHVhdGUoIiIiKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYXNEaWFsb2cgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaXZbcm9sZT0iZGlhbG9nIl0nKSAhPT0gbnVsbDsKICAgICAgICAgICAgY29uc3QgaGFzU2Vjc2RrID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2NsYXNzKj0ic2Vjc2RrIl0nKSAhPT0gbnVsbDsKICAgICAgICAgICAgY29uc3QgaGFzQ2FwdGNoYSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tjbGFzcyo9ImNhcHRjaGEiXScpICE9PSBudWxsOwogICAgICAgICAgICBjb25zdCBoYXNWZXJpZnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbY2xhc3MqPSJWZXJpZnkiXScpICE9PSBudWxsOwogICAgICAgICAgICBjb25zdCBib2R5VGV4dCA9IChkb2N1bWVudC5ib2R5Py5pbm5lclRleHQgfHwgIiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGNvbnN0IGhhc1NsaWRlclRleHQgPSBib2R5VGV4dC5pbmNsdWRlcygic2xpZGVyIikgfHwgYm9keVRleHQuaW5jbHVkZXMoInB1enpsZSIpIHx8IGJvZHlUZXh0LmluY2x1ZGVzKCJkcmFnIik7CiAgICAgICAgICAgIHJldHVybiB7IGhhc0RpYWxvZywgaGFzU2Vjc2RrLCBoYXNDYXB0Y2hhLCBoYXNWZXJpZnksIGhhc1NsaWRlclRleHQsIHVybDogd2luZG93LmxvY2F0aW9uLmhyZWYgfTsKICAgICAgICB9IiIiKQogICAgICAgIGxvZ2dlci53YXJuaW5nKAogICAgICAgICAgICAiW0RJQUdOT1NUSUNdIENoYWxsZW5nZSBjaGVjayAocGhhc2U9JXMpOiB1cmw9JXMsIGRpYWxvZz0lcywgc2Vjc2RrPSVzLCBjYXB0Y2hhPSVzLCB2ZXJpZnk9JXMsIHNsaWRlclRleHQ9JXMiLAogICAgICAgICAgICBwaGFzZSBvciAidW5rbm93biIsIHVybCwgZGlhZ19zdGF0ZS5nZXQoImhhc0RpYWxvZyIsIEZhbHNlKSwgZGlhZ19zdGF0ZS5nZXQoImhhc1NlY3NkayIsIEZhbHNlKSwKICAgICAgICAgICAgZGlhZ19zdGF0ZS5nZXQoImhhc0NhcHRjaGEiLCBGYWxzZSksIGRpYWdfc3RhdGUuZ2V0KCJoYXNWZXJpZnkiLCBGYWxzZSksIGRpYWdfc3RhdGUuZ2V0KCJoYXNTbGlkZXJUZXh0IiwgRmFsc2UpCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBkaWFnX2VycjoKICAgICAgICBsb2dnZXIuZGVidWcoIltESUFHTk9TVElDXSBGYWlsZWQgdG8gZ2V0IHBhZ2Ugc3RhdGU6ICVzIiwgZGlhZ19lcnIpCiAgICAKICAgIGNoYWxsZW5nZSA9IGRldGVjdF9jaGFsbGVuZ2UocGFnZSwgcGhhc2U9cGhhc2UpCiAgICBpZiBjaGFsbGVuZ2UgaXMgTm9uZToKICAgICAgICBfdGhyb3R0bGUuZGVjYXkoMC4yKQogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGxvZ2dlci53YXJuaW5nKCJbQ0hBTExFTkdFIERFVEVDVEVEXSAlcyAocGhhc2U9JXMpIiwgY2hhbGxlbmdlLCBwaGFzZSBvciAidW5rbm93biIpCiAgICBpZiBwaGFzZToKICAgICAgICBsb2dnZXIud2FybmluZygiQ0FQVENIQSBvY2N1cnJlZCBkdXJpbmc6ICVzIiwgcGhhc2UpCgogICAgIyBPcHRpb25hbDogc2F2ZSBzY3JlZW5zaG90ICsgSFRNTCBmb3Igcm9vdC1jYXVzZSBhbmFseXNpcwogICAgaWYgY2FwdHVyZV9kZWJ1ZyBpcyBOb25lOgogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBjb25maWcgaW1wb3J0IERFQlVHX0NBUFRDSEFfQ0FQVFVSRSwgREVCVUdfRElSCiAgICAgICAgICAgIGNhcHR1cmVfZGVidWcgPSBERUJVR19DQVBUQ0hBX0NBUFRVUkUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBjYXB0dXJlX2RlYnVnID0gRmFsc2UKICAgIGlmIGNhcHR1cmVfZGVidWc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgb3MKICAgICAgICAgICAgZnJvbSBjb25maWcgaW1wb3J0IERFQlVHX0RJUgogICAgICAgICAgICBvcy5tYWtlZGlycyhERUJVR19ESVIsIGV4aXN0X29rPVRydWUpCiAgICAgICAgICAgIGRlYnVnX2RpciA9IERFQlVHX0RJUgogICAgICAgICAgICB0cyA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgcGFnZS5zY3JlZW5zaG90KHBhdGg9b3MucGF0aC5qb2luKGRlYnVnX2RpciwgZiJjYXB0Y2hhX3t0c30ucG5nIiksIGZ1bGxfcGFnZT1GYWxzZSkKICAgICAgICAgICAgaHRtbCA9IHBhZ2UuY29udGVudCgpCiAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oZGVidWdfZGlyLCBmImNhcHRjaGFfe3RzfS5odG1sIiksICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoaHRtbCkKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkNBUFRDSEEgZGVidWcgc2F2ZWQ6ICVzL2NhcHRjaGFfJXMuKiAocGhhc2U9JXMpIiwgZGVidWdfZGlyLCB0cywgcGhhc2Ugb3IgInVua25vd24iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJDb3VsZCBub3Qgc2F2ZSBDQVBUQ0hBIGRlYnVnOiAlcyIsIGUpCgogICAgX3Rocm90dGxlLmJ1bXAoMi41LCByZWFzb249Y2hhbGxlbmdlKQoKICAgIGlmICJjYXB0Y2hhIiBpbiBjaGFsbGVuZ2UubG93ZXIoKToKICAgICAgICBfdGhyb3R0bGUuY2FwdGNoYV9jb3VudCArPSAxCgogICAgIyDilIDilIAgU3RlcCAxOiBUcnkgdG8gU09MVkUgdGhlIENBUFRDSEEgcHJvZ3JhbW1hdGljYWxseSDilIDilIAKICAgIHRyeToKICAgICAgICBmcm9tIGNhcHRjaGFfc29sdmVyIGltcG9ydCBhdHRlbXB0X3NvbHZlX2NhcHRjaGEKICAgICAgICBmcm9tIGNvbmZpZyBpbXBvcnQgREVCVUdfRElSCiAgICAgICAgc29sdmVkID0gYXR0ZW1wdF9zb2x2ZV9jYXB0Y2hhKHBhZ2UsIGRlYnVnX2Rpcj1ERUJVR19ESVIpCiAgICAgICAgaWYgc29sdmVkOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiW0NIQUxMRU5HRV0gQ0FQVENIQSBzb2x2ZWQgcHJvZ3JhbW1hdGljYWxseSEgUmVzdW1pbmcuIikKICAgICAgICAgICAgX3Rocm90dGxlLmRlY2F5KDEuNSkKICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgzLCA4KSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgc29sdmVfZXJyOgogICAgICAgIGxvZ2dlci5kZWJ1ZygiW0NIQUxMRU5HRV0gQ0FQVENIQSBzb2x2ZXIgZXJyb3I6ICVzIiwgc29sdmVfZXJyKQoKICAgICMg4pSA4pSAIFN0ZXAgMjogVHJ5IHRvIERJU01JU1MgdGhlIENBUFRDSEEgYnkgY2xvc2luZyBpdHMgZGlhbG9nIOKUgOKUgAogICAgZGlzbWlzc2VkID0gX3RyeV9kaXNtaXNzX2NhcHRjaGEocGFnZSkKICAgIGlmIGRpc21pc3NlZDoKICAgICAgICBsb2dnZXIuaW5mbygiW0NIQUxMRU5HRV0gQ0FQVENIQSBkaWFsb2cgZGlzbWlzc2VkLiBTaG9ydCBjb29sZG93biDigKYiKQogICAgICAgIGNvb2xkb3duID0gcmFuZG9tLnVuaWZvcm0oMTAsIDI1KQogICAgICAgIHRpbWUuc2xlZXAoY29vbGRvd24pCiAgICAgICAgIyBDaGVjayBpZiBpdCBhY3R1YWxseSB3ZW50IGF3YXkKICAgICAgICBpZiBkZXRlY3RfY2hhbGxlbmdlKHBhZ2UpIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJbQ0hBTExFTkdFXSBDQVBUQ0hBIGNsZWFyZWQgYWZ0ZXIgZGlzbWlzcy4gUmVzdW1pbmcuIikKICAgICAgICAgICAgX3Rocm90dGxlLmRlY2F5KDEuMCkgICMgcGFydGx5IHJlY292ZXIgc3VzcGljaW9uCiAgICAgICAgICAgIHJldHVybiBUcnVlICAjIHdhcyBjaGFsbGVuZ2UsIGJ1dCByZXNvbHZlZAoKICAgICMg4pSA4pSAIFN0ZXAgMzogRGlzbWlzcyBmYWlsZWQg4oCUIGZ1bGwgYmFja29mZiDilIDilIAKICAgIGlmIF90aHJvdHRsZS5pc19jcml0aWNhbDoKICAgICAgICBwYXVzZV9zZWNzID0gcmFuZG9tLnVuaWZvcm0oMTgwLCAzNjApCiAgICAgICAgbG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICJbVGhyb3R0bGVdIENSSVRJQ0FMIHN1c3BpY2lvbiAoJS4xZikuICIKICAgICAgICAgICAgIkJhY2tpbmcgb2ZmIGZvciAlLjBmIHMg4oCmIiwKICAgICAgICAgICAgX3Rocm90dGxlLnN1c3BpY2lvbl9zY29yZSwgcGF1c2Vfc2VjcywKICAgICAgICApCiAgICBlbHNlOgogICAgICAgIHBhdXNlX3NlY3MgPSByYW5kb20udW5pZm9ybSg2MCwgMTgwKQogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAiW1Rocm90dGxlXSBTdXNwaWNpb24gJS4xZiDigJMgYmFja2luZyBvZmYgJS4wZiBzIOKApiIsCiAgICAgICAgICAgIF90aHJvdHRsZS5zdXNwaWNpb25fc2NvcmUsIHBhdXNlX3NlY3MsCiAgICAgICAgKQoKICAgIHRpbWUuc2xlZXAocGF1c2Vfc2VjcykKCiAgICAjIE5hdmlnYXRlIHRvIGhvbWVwYWdlIHRvIGNsZWFyIHRoZSBDQVBUQ0hBIHBhZ2UKICAgIHRyeToKICAgICAgICBwYWdlLmdvdG8oImh0dHBzOi8vd3d3LnRpa3Rvay5jb20iLCB3YWl0X3VudGlsPSJkb21jb250ZW50bG9hZGVkIiwgdGltZW91dD0zMDAwMCkKICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDUsIDEwKSkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKICAgIHJldHVybiBUcnVlCgoKZGVmIF90cnlfZGlzbWlzc19jYXB0Y2hhKHBhZ2UpIC0+IGJvb2w6CiAgICAiIiJUcnkgdG8gY2xvc2UgYSBDQVBUQ0hBIGRpYWxvZyBieSBjbGlja2luZyBpdHMgWC9jbG9zZSBidXR0b24uCgogICAgUmV0dXJucyBUcnVlIGlmIGEgY2xvc2UgYnV0dG9uIHdhcyBmb3VuZCBhbmQgY2xpY2tlZC4KICAgICIiIgogICAgY2xvc2Vfc2VsZWN0b3JzID0gWwogICAgICAgICMgVGlrVG9rIHNsaWRlciBwdXp6bGU6IFggaW4gdG9wLXJpZ2h0IG9mICJEcmFnIHRoZSBzbGlkZXIgdG8gZml0IHRoZSBwdXp6bGUiIG1vZGFsCiAgICAgICAgJ2Rpdltyb2xlPSJkaWFsb2ciXSBidXR0b25bYXJpYS1sYWJlbD0iQ2xvc2UiXScsCiAgICAgICAgJ2Rpdltyb2xlPSJkaWFsb2ciXSBidXR0b25bYXJpYS1sYWJlbD0iY2xvc2UiXScsCiAgICAgICAgJ1tjbGFzcyo9InNlY3NkayJdIGJ1dHRvblthcmlhLWxhYmVsPSJDbG9zZSJdJywKICAgICAgICAnW2NsYXNzKj0iVmVyaWZ5Il0gYnV0dG9uW2FyaWEtbGFiZWw9IkNsb3NlIl0nLAogICAgICAgICdbY2xhc3MqPSJjYXB0Y2hhIl0gYnV0dG9uW2FyaWEtbGFiZWw9IkNsb3NlIl0nLAogICAgICAgICdbY2xhc3MqPSJEaXZDbG9zZVdyYXBwZXIiXScsCiAgICAgICAgIyBDbG9zZSAvIFggYnV0dG9ucyBjb21tb25seSB1c2VkIGluIENBUFRDSEEgbW9kYWxzCiAgICAgICAgJ1tjbGFzcyo9ImNhcHRjaGEiXSBidXR0b25bY2xhc3MqPSJjbG9zZSJdJywKICAgICAgICAnW2NsYXNzKj0iY2FwdGNoYSJdIFtjbGFzcyo9IkNsb3NlIl0nLAogICAgICAgICdbY2xhc3MqPSJWZXJpZnkiXSBidXR0b25bY2xhc3MqPSJjbG9zZSJdJywKICAgICAgICAnW2NsYXNzKj0ic2Vjc2RrIl0gW2NsYXNzKj0iY2xvc2UiXScsCiAgICAgICAgJ1tjbGFzcyo9ImNhcHRjaGEtbW9kYWwiXSBidXR0b24nLAogICAgICAgICdkaXZbY2xhc3MqPSJjYXB0Y2hhIl0gfiBidXR0b24nLAogICAgICAgICdkaXZbY2xhc3MqPSJjYXB0Y2hhIl0gc3ZnW2NsYXNzKj0iY2xvc2UiXScsCiAgICAgICAgJ2J1dHRvblthcmlhLWxhYmVsPSJDbG9zZSJdJywKICAgICAgICAnYnV0dG9uW2FyaWEtbGFiZWw9ImNsb3NlIl0nLAogICAgXQoKICAgIGZvciBzZWwgaW4gY2xvc2Vfc2VsZWN0b3JzOgogICAgICAgIHRyeToKICAgICAgICAgICAgYnRuID0gcGFnZS5sb2NhdG9yKHNlbCkuZmlyc3QKICAgICAgICAgICAgaWYgYnRuLmlzX3Zpc2libGUodGltZW91dD04MDApOgogICAgICAgICAgICAgICAgYnRuLmNsaWNrKHRpbWVvdXQ9MjAwMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJbQ0FQVENIQSBESVNNSVNTXSBDbGlja2VkIGNsb3NlIHZpYTogJXMiLCBzZWwpCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDIsIDQpKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBjb250aW51ZQoKICAgICMgRmFsbGJhY2s6IHRyeSBwcmVzc2luZyBFc2NhcGUga2V5CiAgICB0cnk6CiAgICAgICAgcGFnZS5rZXlib2FyZC5wcmVzcygiRXNjYXBlIikKICAgICAgICB0aW1lLnNsZWVwKHJhbmRvbS51bmlmb3JtKDEsIDIpKQogICAgICAgIGxvZ2dlci5pbmZvKCJbQ0FQVENIQSBESVNNSVNTXSBQcmVzc2VkIEVzY2FwZSBrZXkuIikKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgcmV0dXJuIEZhbHNlCgoKIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKIyBWaWV3cG9ydCBSYW5kb21pc2F0aW9uCiMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACgpDT01NT05fVklFV1BPUlRTID0gWwogICAgKDEyODAsIDcyMCksCiAgICAoMTI4MCwgODAwKSwKICAgICgxMzY2LCA3NjgpLAogICAgKDE0NDAsIDkwMCksCiAgICAoMTUzNiwgODY0KSwKICAgICgxNjAwLCA5MDApLAogICAgKDE5MjAsIDEwODApLApdCgoKZGVmIHJhbmRvbV92aWV3cG9ydCgpIC0+IGRpY3Q6CiAgICAiIiJSZXR1cm4gYSBzbGlnaHRseSBqaXR0ZXJlZCB2aWV3cG9ydCBmcm9tIGNvbW1vbiByZXNvbHV0aW9ucy4iIiIKICAgIGJhc2VfdywgYmFzZV9oID0gcmFuZG9tLmNob2ljZShDT01NT05fVklFV1BPUlRTKQogICAgcmV0dXJuIHsKICAgICAgICAid2lkdGgiOiBiYXNlX3cgKyByYW5kb20ucmFuZGludCgtMTYsIDE2KSwKICAgICAgICAiaGVpZ2h0IjogYmFzZV9oICsgcmFuZG9tLnJhbmRpbnQoLTEyLCAxMiksCiAgICB9CgoKIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKIyBCcm93c2VyIEZpbmdlcnByaW50IEhhcmRlbmluZwojIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAoKZGVmIGdldF9maW5nZXJwcmludF9zY3JpcHRzKHVzZXJfYWdlbnQ6IHN0cikgLT4gc3RyOgogICAgIiIiUmV0dXJuIGEgSlMgcGF5bG9hZCB0aGF0IGhhcmRlbnMgdGhlIGJyb3dzZXIgZmluZ2VycHJpbnQKICAgIGJleW9uZCB3aGF0IHBsYXl3cmlnaHQtc3RlYWx0aCBjb3ZlcnMuCiAgICAiIiIKICAgIGh3X2NvbmN1cnJlbmN5ID0gcmFuZG9tLmNob2ljZShbNCwgNiwgOCwgMTJdKQogICAgZGV2X21lbW9yeSA9IHJhbmRvbS5jaG9pY2UoWzQsIDgsIDE2XSkKICAgICMgVXNlIGEgcGVyLXNlc3Npb24gc2VlZCBmb3IgY29uc2lzdGVudCBjYW52YXMgbm9pc2Ugd2l0aGluIGEgc2Vzc2lvbgogICAgY2FudmFzX3NlZWQgPSByYW5kb20ucmFuZGludCgxLCAyKiozMSkKCiAgICByZXR1cm4gIiIiCiAgICAvLyAtLS0gd2ViZHJpdmVyIChiZWx0LWFuZC1zdXNwZW5kZXJzIHdpdGggLS1kaXNhYmxlLWJsaW5rLWZlYXR1cmVzKSAtLS0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuYXZpZ2F0b3IsICd3ZWJkcml2ZXInLCB7CiAgICAgICAgZ2V0OiAoKSA9PiBmYWxzZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwoKICAgIC8vIC0tLSBwbHVnaW5zIChtaW1pYyByZWFsIENocm9tZSDigJMgUGx1Z2luQXJyYXktbGlrZSkgLS0tCiAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgcGx1Z2luRGF0YSA9IFsKICAgICAgICAgICAgeyBuYW1lOiAnUERGIFZpZXdlcicsIGZpbGVuYW1lOiAnaW50ZXJuYWwtcGRmLXZpZXdlcicsCiAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdQb3J0YWJsZSBEb2N1bWVudCBGb3JtYXQnLAogICAgICAgICAgICAgIG1pbWVUeXBlczogW3sgdHlwZTogJ2FwcGxpY2F0aW9uL3BkZicsIHN1ZmZpeGVzOiAncGRmJywgZGVzY3JpcHRpb246ICdQb3J0YWJsZSBEb2N1bWVudCBGb3JtYXQnIH1dIH0sCiAgICAgICAgICAgIHsgbmFtZTogJ0Nocm9tZSBQREYgVmlld2VyJywgZmlsZW5hbWU6ICdpbnRlcm5hbC1wZGYtdmlld2VyJywKICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1BvcnRhYmxlIERvY3VtZW50IEZvcm1hdCcsCiAgICAgICAgICAgICAgbWltZVR5cGVzOiBbeyB0eXBlOiAnYXBwbGljYXRpb24veC1nb29nbGUtY2hyb21lLXBkZicsIHN1ZmZpeGVzOiAncGRmJywgZGVzY3JpcHRpb246ICcnIH1dIH0sCiAgICAgICAgICAgIHsgbmFtZTogJ0Nocm9taXVtIFBERiBWaWV3ZXInLCBmaWxlbmFtZTogJ2ludGVybmFsLXBkZi12aWV3ZXInLAogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUG9ydGFibGUgRG9jdW1lbnQgRm9ybWF0JywKICAgICAgICAgICAgICBtaW1lVHlwZXM6IFt7IHR5cGU6ICdhcHBsaWNhdGlvbi9wZGYnLCBzdWZmaXhlczogJ3BkZicsIGRlc2NyaXB0aW9uOiAnJyB9XSB9LAogICAgICAgIF07CiAgICAgICAgY29uc3QgcGx1Z2lucyA9IE9iamVjdC5jcmVhdGUoUGx1Z2luQXJyYXkucHJvdG90eXBlKTsKICAgICAgICBwbHVnaW5EYXRhLmZvckVhY2goKHAsIGkpID0+IHsgcGx1Z2luc1tpXSA9IHA7IH0pOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwbHVnaW5zLCAnbGVuZ3RoJywgeyBnZXQ6ICgpID0+IHBsdWdpbkRhdGEubGVuZ3RoIH0pOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuYXZpZ2F0b3IsICdwbHVnaW5zJywgewogICAgICAgICAgICBnZXQ6ICgpID0+IHBsdWdpbnMsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0pOwogICAgfSkoKTsKCiAgICAvLyAtLS0gbGFuZ3VhZ2VzIC0tLQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5hdmlnYXRvciwgJ2xhbmd1YWdlcycsIHsKICAgICAgICBnZXQ6ICgpID0+IFsnZW4tVVMnLCAnZW4nXSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwoKICAgIC8vIC0tLSBjaHJvbWUgcnVudGltZSAocmVhbGlzdGljIHN0cnVjdHVyZSkgLS0tCiAgICBpZiAoIXdpbmRvdy5jaHJvbWUpIHsKICAgICAgICB3aW5kb3cuY2hyb21lID0ge307CiAgICB9CiAgICBpZiAoIXdpbmRvdy5jaHJvbWUucnVudGltZSkgewogICAgICAgIHdpbmRvdy5jaHJvbWUucnVudGltZSA9IHsKICAgICAgICAgICAgT25JbnN0YWxsZWRSZWFzb246IHsgQ0hST01FX1VQREFURTogJ2Nocm9tZV91cGRhdGUnLCBJTlNUQUxMOiAnaW5zdGFsbCcsIFNIQVJFRF9NT0RVTEVfVVBEQVRFOiAnc2hhcmVkX21vZHVsZV91cGRhdGUnLCBVUERBVEU6ICd1cGRhdGUnIH0sCiAgICAgICAgICAgIE9uUmVzdGFydFJlcXVpcmVkUmVhc29uOiB7IEFQUF9VUERBVEU6ICdhcHBfdXBkYXRlJywgT1NfVVBEQVRFOiAnb3NfdXBkYXRlJywgUEVSSU9ESUM6ICdwZXJpb2RpYycgfSwKICAgICAgICAgICAgUGxhdGZvcm1BcmNoOiB7IEFSTTogJ2FybScsIEFSTTY0OiAnYXJtNjQnLCBNSVBTOiAnbWlwcycsIE1JUFM2NDogJ21pcHM2NCcsIFg4Nl8zMjogJ3g4Ni0zMicsIFg4Nl82NDogJ3g4Ni02NCcgfSwKICAgICAgICAgICAgUGxhdGZvcm1OYWNsQXJjaDogeyBBUk06ICdhcm0nLCBNSVBTOiAnbWlwcycsIE1JUFM2NDogJ21pcHM2NCcsIFg4Nl8zMjogJ3g4Ni0zMicsIFg4Nl82NDogJ3g4Ni02NCcgfSwKICAgICAgICAgICAgUGxhdGZvcm1PczogeyBBTkRST0lEOiAnYW5kcm9pZCcsIENST1M6ICdjcm9zJywgTElOVVg6ICdsaW51eCcsIE1BQzogJ21hYycsIE9QRU5CU0Q6ICdvcGVuYnNkJywgV0lOOiAnd2luJyB9LAogICAgICAgICAgICBSZXF1ZXN0VXBkYXRlQ2hlY2tTdGF0dXM6IHsgTk9fVVBEQVRFOiAnbm9fdXBkYXRlJywgVEhST1RUTEVEOiAndGhyb3R0bGVkJywgVVBEQVRFX0FWQUlMQUJMRTogJ3VwZGF0ZV9hdmFpbGFibGUnIH0sCiAgICAgICAgICAgIGNvbm5lY3Q6IGZ1bmN0aW9uKCkgeyByZXR1cm4geyBvbkRpc2Nvbm5lY3Q6IHsgYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKCkge30gfSwgb25NZXNzYWdlOiB7IGFkZExpc3RlbmVyOiBmdW5jdGlvbigpIHt9IH0sIHBvc3RNZXNzYWdlOiBmdW5jdGlvbigpIHt9IH07IH0sCiAgICAgICAgICAgIHNlbmRNZXNzYWdlOiBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICBpZDogdW5kZWZpbmVkLAogICAgICAgIH07CiAgICB9CiAgICAvLyBNYWtlIGNocm9tZS5hcHAgcmVhbGlzdGljCiAgICBpZiAoIXdpbmRvdy5jaHJvbWUuYXBwKSB7CiAgICAgICAgd2luZG93LmNocm9tZS5hcHAgPSB7CiAgICAgICAgICAgIGlzSW5zdGFsbGVkOiBmYWxzZSwKICAgICAgICAgICAgSW5zdGFsbFN0YXRlOiB7IERJU0FCTEVEOiAnZGlzYWJsZWQnLCBJTlNUQUxMRUQ6ICdpbnN0YWxsZWQnLCBOT1RfSU5TVEFMTEVEOiAnbm90X2luc3RhbGxlZCcgfSwKICAgICAgICAgICAgUnVubmluZ1N0YXRlOiB7IENBTk5PVF9SVU46ICdjYW5ub3RfcnVuJywgUkVBRFlfVE9fUlVOOiAncmVhZHlfdG9fcnVuJywgUlVOTklORzogJ3J1bm5pbmcnIH0sCiAgICAgICAgICAgIGdldERldGFpbHM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gbnVsbDsgfSwKICAgICAgICAgICAgZ2V0SXNJbnN0YWxsZWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0sCiAgICAgICAgfTsKICAgIH0KCiAgICAvLyAtLS0gcGVybWlzc2lvbnMgcXVlcnkgLS0tCiAgICBjb25zdCBvcmlnaW5hbFF1ZXJ5ID0gd2luZG93Lm5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeTsKICAgIHdpbmRvdy5uYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkgPSAocGFyYW1ldGVycykgPT4gewogICAgICAgIGlmIChwYXJhbWV0ZXJzLm5hbWUgPT09ICdub3RpZmljYXRpb25zJykgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdGU6IE5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3JpZ2luYWxRdWVyeShwYXJhbWV0ZXJzKTsKICAgIH07CgogICAgLy8gLS0tIGNvbm5lY3Rpb24gKE5ldHdvcmtJbmZvcm1hdGlvbikgLS0tCiAgICBpZiAoIW5hdmlnYXRvci5jb25uZWN0aW9uKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5hdmlnYXRvciwgJ2Nvbm5lY3Rpb24nLCB7CiAgICAgICAgICAgIGdldDogKCkgPT4gKHsKICAgICAgICAgICAgICAgIGVmZmVjdGl2ZVR5cGU6ICc0ZycsCiAgICAgICAgICAgICAgICBydHQ6ICIiIiArIHN0cihyYW5kb20uY2hvaWNlKFs1MCwgNzUsIDEwMF0pKSArICIiIiwKICAgICAgICAgICAgICAgIGRvd25saW5rOiAiIiIgKyBzdHIocmFuZG9tLmNob2ljZShbNSwgOCwgMTAsIDE1XSkpICsgIiIiLAogICAgICAgICAgICAgICAgc2F2ZURhdGE6IGZhbHNlLAogICAgICAgICAgICB9KSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gLS0tIGhhcmR3YXJlIGNvbmN1cnJlbmN5IChyZWFsaXN0aWMgdmFsdWUsIGNvbnNpc3RlbnQgcGVyIHNlc3Npb24pIC0tLQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5hdmlnYXRvciwgJ2hhcmR3YXJlQ29uY3VycmVuY3knLCB7CiAgICAgICAgZ2V0OiAoKSA9PiAiIiIgKyBzdHIoaHdfY29uY3VycmVuY3kpICsgIiIiLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CgogICAgLy8gLS0tIGRldmljZSBtZW1vcnkgLS0tCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobmF2aWdhdG9yLCAnZGV2aWNlTWVtb3J5JywgewogICAgICAgIGdldDogKCkgPT4gIiIiICsgc3RyKGRldl9tZW1vcnkpICsgIiIiLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CgogICAgLy8gLS0tIGNhbnZhcyBub2lzZSAoc2VlZGVkLCByZWFsaXN0aWMgcGVyLXNlc3Npb24gZmluZ2VycHJpbnQpIC0tLQogICAgKGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHNlZWQgPSAiIiIgKyBzdHIoY2FudmFzX3NlZWQpICsgIiIiOwogICAgICAgIC8vIFNpbXBsZSBzZWVkZWQgUFJORyBmb3IgY29uc2lzdGVudCBub2lzZSB3aXRoaW4gYSBzZXNzaW9uCiAgICAgICAgbGV0IHMgPSBzZWVkOwogICAgICAgIGZ1bmN0aW9uIG5leHRSYW5kKCkgewogICAgICAgICAgICBzID0gKHMgKiAxMTAzNTE1MjQ1ICsgMTIzNDUpICYgMHg3ZmZmZmZmZjsKICAgICAgICAgICAgcmV0dXJuIChzID4+IDE2KSAmIDB4ZmY7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBvcmlnVG9EYXRhVVJMID0gSFRNTENhbnZhc0VsZW1lbnQucHJvdG90eXBlLnRvRGF0YVVSTDsKICAgICAgICBIVE1MQ2FudmFzRWxlbWVudC5wcm90b3R5cGUudG9EYXRhVVJMID0gZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy53aWR0aCA9PT0gMCB8fCB0aGlzLmhlaWdodCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdUb0RhdGFVUkwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICAgICAgaWYgKGN0eCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IHN1YnRsZSBub2lzZSB0byBhIGZldyBzY2F0dGVyZWQgcGl4ZWxzIChub3QganVzdCBmaXJzdCAyKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHcgPSBNYXRoLm1pbih0aGlzLndpZHRoLCAxNik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaCA9IE1hdGgubWluKHRoaXMuaGVpZ2h0LCAxNik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1nRGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgdywgaCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGl4ZWxDb3VudCA9IHcgKiBoOwogICAgICAgICAgICAgICAgICAgIC8vIE1vZGlmeSB+MTAlIG9mIHBpeGVscyB3aXRoICstMSBub2lzZQogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHAgPSAwOyBwIDwgcGl4ZWxDb3VudDsgcCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0UmFuZCgpICUgMTAgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHAgKiA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IG5leHRSYW5kKCkgJSAzOyAvLyBSLCBHLCBvciBCCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWx0YSA9IChuZXh0UmFuZCgpICUgMykgLSAxOyAvLyAtMSwgMCwgb3IgKzEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZ0RhdGEuZGF0YVtpZHggKyBjaGFubmVsXSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDI1NSwgaW1nRGF0YS5kYXRhW2lkeCArIGNoYW5uZWxdICsgZGVsdGEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHgucHV0SW1hZ2VEYXRhKGltZ0RhdGEsIDAsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICAgIHJldHVybiBvcmlnVG9EYXRhVVJMLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQWxzbyBob29rIHRvQmxvYgogICAgICAgIGNvbnN0IG9yaWdUb0Jsb2IgPSBIVE1MQ2FudmFzRWxlbWVudC5wcm90b3R5cGUudG9CbG9iOwogICAgICAgIEhUTUxDYW52YXNFbGVtZW50LnByb3RvdHlwZS50b0Jsb2IgPSBmdW5jdGlvbihjYWxsYmFjaywgdHlwZSwgcXVhbGl0eSkgewogICAgICAgICAgICAvLyBUcmlnZ2VyIG91ciBub2lzZSB2aWEgdG9EYXRhVVJMIGZpcnN0CiAgICAgICAgICAgIHRyeSB7IHRoaXMudG9EYXRhVVJMKHR5cGUpOyB9IGNhdGNoKGUpIHt9CiAgICAgICAgICAgIHJldHVybiBvcmlnVG9CbG9iLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgIH0pKCk7CgogICAgLy8gLS0tIFdlYkdMIHJlbmRlcmVyL3ZlbmRvciAocGxhdGZvcm0tYXdhcmUpIC0tLQogICAgKGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGdldFBhcmFtID0gV2ViR0xSZW5kZXJpbmdDb250ZXh0LnByb3RvdHlwZS5nZXRQYXJhbWV0ZXI7CiAgICAgICAgLy8gTGV0IHJlYWwgV2ViR0wgdmFsdWVzIHBhc3MgdGhyb3VnaCDigJQgb3ZlcnJpZGluZyBjcmVhdGVzIGRldGVjdGFibGUgbWlzbWF0Y2gKICAgICAgICAvLyBPbmx5IG92ZXJyaWRlIGlmIHZhbHVlcyBhcmUgbWlzc2luZy9lbXB0eSAoZS5nLiBzb2Z0d2FyZSByZW5kZXJlcikKICAgICAgICBXZWJHTFJlbmRlcmluZ0NvbnRleHQucHJvdG90eXBlLmdldFBhcmFtZXRlciA9IGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbCA9IGdldFBhcmFtLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmIChwYXJhbSA9PT0gMzc0NDUgJiYgKCF2YWwgfHwgdmFsID09PSAnJykpIHJldHVybiAnR29vZ2xlIEluYy4nOwogICAgICAgICAgICBpZiAocGFyYW0gPT09IDM3NDQ2ICYmICghdmFsIHx8IHZhbCA9PT0gJycpKSByZXR1cm4gJ0FOR0xFIChHb29nbGUsIFZ1bGthbiAxLjMuMCwgT3BlbkdMIEVTIDMuMiknOwogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH07CiAgICAgICAgLy8gU2FtZSBmb3IgV2ViR0wyCiAgICAgICAgaWYgKHR5cGVvZiBXZWJHTDJSZW5kZXJpbmdDb250ZXh0ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBjb25zdCBnZXRQYXJhbTIgPSBXZWJHTDJSZW5kZXJpbmdDb250ZXh0LnByb3RvdHlwZS5nZXRQYXJhbWV0ZXI7CiAgICAgICAgICAgIFdlYkdMMlJlbmRlcmluZ0NvbnRleHQucHJvdG90eXBlLmdldFBhcmFtZXRlciA9IGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBnZXRQYXJhbTIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIGlmIChwYXJhbSA9PT0gMzc0NDUgJiYgKCF2YWwgfHwgdmFsID09PSAnJykpIHJldHVybiAnR29vZ2xlIEluYy4nOwogICAgICAgICAgICAgICAgaWYgKHBhcmFtID09PSAzNzQ0NiAmJiAoIXZhbCB8fCB2YWwgPT09ICcnKSkgcmV0dXJuICdBTkdMRSAoR29vZ2xlLCBWdWxrYW4gMS4zLjAsIE9wZW5HTCBFUyAzLjIpJzsKICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSkoKTsKCiAgICAvLyAtLS0gdHJhY2sgbW91c2UgcG9zaXRpb24gKG5vbi1lbnVtZXJhYmxlLCBoaWRkZW4gZnJvbSBkZXRlY3Rpb24pIC0tLQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdywgJ19fbVBvcycsIHsKICAgICAgICB2YWx1ZTogeyB4OiAwLCB5OiAwIH0sCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgfSk7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgIHdpbmRvdy5fX21Qb3MueCA9IGUuY2xpZW50WDsKICAgICAgICB3aW5kb3cuX19tUG9zLnkgPSBlLmNsaWVudFk7CiAgICB9LCB7IHBhc3NpdmU6IHRydWUgfSk7CiAgICAiIiIK'
TIKTOK  = 'IiIiCnRpa3Rva19ib3QucHkg4oCTIE1haW4gVGlrVG9rIEJyb3dzZXIgQm90IGNsYXNzLgoKSGFuZGxlcyBicm93c2VyIGxpZmVjeWNsZSwgYXV0aGVudGljYXRpb24gKG1hbnVhbCBRUi1jb2RlIGxvZ2luICsgY29va2llCnBlcnNpc3RlbmNlKSwgZmVlZCBpbnRlcmFjdGlvbiwgIk11dHVhbHMiIG5ldHdvcmsgZ3Jvd3RoLCBhbmQgdmlkZW8gdXBsb2FkLgoiIiIKCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgYW5ub3RhdGlvbnMKCmltcG9ydCBqc29uCmltcG9ydCBvcwppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHJhbmRvbQppbXBvcnQgcmUKaW1wb3J0IHRpbWUKaW1wb3J0IHdhcm5pbmdzCgojIFBoYW50b213cmlnaHQncyBhZGRfaW5pdF9zY3JpcHQgcmFpc2VzIFVzZXJXYXJuaW5nOyB3ZSB1c2UgaXQgaW50ZW50aW9uYWxseS4Kd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoImlnbm9yZSIsIG1lc3NhZ2U9Ii4qYWRkX2luaXRfc2NyaXB0LioiLCBjYXRlZ29yeT1Vc2VyV2FybmluZykKCmZyb20gcGhhbnRvbXdyaWdodC5zeW5jX2FwaSBpbXBvcnQgc3luY19wbGF5d3JpZ2h0CmZyb20gcGhhbnRvbXdyaWdodC5zdGVhbHRoIGltcG9ydCBTdGVhbHRoCgpmcm9tIGJvdF91dGlscyBpbXBvcnQgKAogICAgZWxlbWVudF9leGlzdHMsCiAgICBodW1hbl90eXBlLAogICAgaHVtYW5fdHlwZV9lbGVtZW50LAogICAgbG9nZ2VyLAogICAgcmFuZG9tX3NsZWVwLAogICAgc2FmZV9jbGljaywKICAgIHNjcm9sbF9wYWdlLAogICAgd2FpdF91bnRpbF9hY3RpdmUsCikKZnJvbSBjb25maWcgaW1wb3J0ICgKICAgIEJBU0VfRElSLAogICAgQlJPV1NFUl9EQVRBX0RJUiwKICAgIENPT0tJRVNfUEFUSCwKICAgIERFTEFZX0xPTkcsCiAgICBERUxBWV9NRURJVU0sCiAgICBERUxBWV9TSE9SVCwKICAgIEVOQUJMRV9NVVRVQUxTLAogICAgRU5BQkxFX1NVR0dFU1RFRCwKICAgIEZBTExCQUNLX0hBU0hUQUdTLAogICAgRkVFRF9TQ1JPTExfUk9VTkRTLAogICAgSEFTSFRBR19UUkFOU0lUSU9OX1BBVVNFX01BWCwKICAgIEhBU0hUQUdfVFJBTlNJVElPTl9QQVVTRV9NSU4sCiAgICBNQVhfRk9MTE9XU19QRVJfU0VTU0lPTiwKICAgIE1BWF9MSUtFU19QRVJfU0VTU0lPTiwKICAgIE1BWF9TVUdHRVNURURfRk9MTE9XUywKICAgIE1BWF9WSURFT1NfVE9fV0FUQ0gsCiAgICBOSUNIRV9LRVlXT1JEUywKICAgIFBIQU5UT01XUklHSFRfTEFVTkNIX1JFVFJJRVMsCiAgICBTQ0hFRFVMRV9GSUxFLAogICAgU0VMRUNUT1JTLAogICAgVEFSR0VUX0hBU0hUQUcsCiAgICBUSUtUT0tfQkFTRSwKICAgIFRJS1RPS19MT0dJTiwKICAgIFRJS1RPS19UQUdfVVJMLAogICAgVElLVE9LX1VQTE9BRCwKKQpmcm9tIHN0ZWFsdGggaW1wb3J0ICgKICAgIGdldF9maW5nZXJwcmludF9zY3JpcHRzLAogICAgZ2V0X3Rocm90dGxlLAogICAgaGFuZGxlX2NoYWxsZW5nZSwKICAgIGh1bWFuX2NsaWNrX2VsZW1lbnQsCiAgICBodW1hbl9oYXNodGFnX3dhcm11cCwKICAgIGh1bWFuX21vdXNlX3dhcm11cCwKICAgIGh1bWFuX3Byb2ZpbGVfd2FybXVwLAogICAgaHVtYW5fc2Nyb2xsX25leHRfdmlkZW8sCiAgICBpZGxlX3NsZWVwLAogICAgcmFuZG9tX3ZpZXdwb3J0LAopCgoKZGVmIF9nZXRfZGVza3RvcF91YSgpIC0+IHN0ciB8IE5vbmU6CiAgICAiIiJSZXR1cm4gTm9uZSB0byBsZXQgdGhlIGJyb3dzZXIncyByZWFsIFVBIHBhc3MgdGhyb3VnaC4KCiAgICBVc2luZyBmYWtlX3VzZXJhZ2VudCBjcmVhdGVzIGEgbWlzbWF0Y2ggYmV0d2VlbiB0aGUgSFRUUCBVc2VyLUFnZW50CiAgICBoZWFkZXIgYW5kIHRoZSBicm93c2VyJ3MgYWN0dWFsIGNhcGFiaWxpdGllcy92ZXJzaW9uLCB3aGljaCBpcyBhCiAgICBtYWpvciBib3QgZGV0ZWN0aW9uIHNpZ25hbC4gIFBoYW50b213cmlnaHQncyBwYXRjaGVkIENocm9taXVtIGhhcyBpdHMKICAgIG93biBsZWdpdGltYXRlIFVBIHRoYXQgbWF0Y2hlcyBpdHMgYWN0dWFsIGVuZ2luZSDigJQgd2Ugc2hvdWxkIHVzZSBpdC4KICAgICIiIgogICAgIyBSZXR1cm4gTm9uZSBzbyB0aGUgYnJvd3NlciBjb250ZXh0IGRvZXNuJ3Qgb3ZlcnJpZGUgdGhlIHJlYWwgVUEuCiAgICAjIFRoZSBicm93c2VyJ3MgYnVpbHQtaW4gVUEgd2lsbCBtYXRjaCBpdHMgYWN0dWFsIGVuZ2luZSB2ZXJzaW9uLAogICAgIyBhdm9pZGluZyB0aGUgbWlzbWF0Y2ggdGhhdCB0cmlnZ2VycyBkZXRlY3Rpb24uCiAgICByZXR1cm4gTm9uZQoKCmNsYXNzIFRpa1Rva0JvdDoKICAgICIiIkVuY2Fwc3VsYXRlcyBhbGwgYnJvd3Nlci1sZXZlbCBUaWtUb2sgYXV0b21hdGlvbi4iIiIKCiAgICAjIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogICAgIyBJbml0aWFsaXNhdGlvbiAmIFRlYXJkb3duCiAgICAjIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogICAgZGVmIF9faW5pdF9fKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgc2VsZi5wbGF5d3JpZ2h0ID0gTm9uZQogICAgICAgIHNlbGYuYnJvd3NlciA9IE5vbmUKICAgICAgICBzZWxmLmNvbnRleHQgPSBOb25lCiAgICAgICAgc2VsZi5wYWdlID0gTm9uZQogICAgICAgIHNlbGYuX2Nsb3NlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5fY2hyb21lX3Byb2Nlc3MgPSBOb25lCiAgICAgICAgc2VsZi5fc3RlYWx0aCA9IE5vbmUKICAgICAgICBzZWxmLl91c2VyX2FnZW50ID0gX2dldF9kZXNrdG9wX3VhKCkKICAgICAgICBzZWxmLl9zZXNzaW9uX2JlaGF2aW9yID0gc2VsZi5fYnVpbGRfc2Vzc2lvbl9iZWhhdmlvcigpCgogICAgICAgIHNlbGYuX2ZvbGxvd3NfdGhpc19zZXNzaW9uID0gMAogICAgICAgIHNlbGYuX2xpa2VzX3RoaXNfc2Vzc2lvbiA9IDAKICAgICAgICBzZWxmLl9jYXB0Y2hhX2hpdF90aGlzX3Nlc3Npb24gPSBGYWxzZQogICAgICAgIHNlbGYuX2NvbnRlbnRfYmxvY2tlZF90aGlzX3Nlc3Npb24gPSBGYWxzZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfYnVpbGRfc2Vzc2lvbl9iZWhhdmlvcigpIC0+IGRpY3Q6CiAgICAgICAgIiIiR2VuZXJhdGUgcGVyLXNlc3Npb24gYmVoYXZpb3IgdmFyaWFuY2UgdG8gYXZvaWQgZml4ZWQgcmh5dGhtcy4iIiIKICAgICAgICB3YXRjaF9taW4gPSByYW5kb20udW5pZm9ybSg4LjAsIDE1LjApCiAgICAgICAgd2F0Y2hfbWF4ID0gcmFuZG9tLnVuaWZvcm0oMjAuMCwgNDUuMCkKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAid2F0Y2hfbWluIjogbWluKHdhdGNoX21pbiwgd2F0Y2hfbWF4IC0gMi4wKSwKICAgICAgICAgICAgIndhdGNoX21heCI6IHdhdGNoX21heCwKICAgICAgICAgICAgInByb2ZpbGVfZXZhbF9wYXVzZSI6IChyYW5kb20udW5pZm9ybSgyNS4wLCA0MC4wKSwgcmFuZG9tLnVuaWZvcm0oNDUuMCwgNzUuMCkpLAogICAgICAgICAgICAjIE9jY2FzaW9uYWxseSB0YWtlIGEgbG9uZyBicmVhayBtaWQtZmVlZCAoaHVtYW4gY2hlY2tpbmcgcGhvbmUsIHJlYWRpbmcpCiAgICAgICAgICAgICJsb25nX3BhdXNlX2NoYW5jZSI6IHJhbmRvbS51bmlmb3JtKDAuMTAsIDAuMjUpLAogICAgICAgICAgICAibG9uZ19wYXVzZV9yYW5nZSI6IChyYW5kb20udW5pZm9ybSgxNS4wLCAyNS4wKSwgcmFuZG9tLnVuaWZvcm0oMzAuMCwgNjAuMCkpLAogICAgICAgIH0KCiAgICBkZWYgX2FwcGx5X3N0ZWFsdGhfbGF5ZXJzKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiQXBwbHkgcGxheXdyaWdodC1zdGVhbHRoIGFuZCBjdXN0b20gZmluZ2VycHJpbnQgc2NyaXB0cy4iIiIKICAgICAgICBpZiBub3Qgc2VsZi5jb250ZXh0IG9yIG5vdCBzZWxmLnBhZ2U6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBzZWxmLl9zdGVhbHRoIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3N0ZWFsdGggPSBTdGVhbHRoKAogICAgICAgICAgICAgICAgIyBMZXQgb3ZlcnJpZGVzIHVzZSBkZWZhdWx0cyAoZG9uJ3QgcGFzcyBOb25lIOKAlCBpdCBicmVha3MgSlMgZXZhc2lvbiBzY3JpcHRzKS4KICAgICAgICAgICAgICAgIG5hdmlnYXRvcl9sYW5ndWFnZXNfb3ZlcnJpZGU9KCJlbi1VUyIsICJlbiIpLAogICAgICAgICAgICAgICAgIyBLZWVwIG1lZGlhX2NvZGVjcyBvZmYgKGJyZWFrcyB2aWRlbyBwbGF5YmFjayB3aGVuIHNwb29mZWQpLgogICAgICAgICAgICAgICAgIyBCdXQgZW5hYmxlIGFsbCBvdGhlciBzYWZlIGV2YXNpb25zIHRvIHJlZHVjZSBkZXRlY3Rpb24gc3VyZmFjZS4KICAgICAgICAgICAgICAgIG1lZGlhX2NvZGVjcz1GYWxzZSwKICAgICAgICAgICAgICAgIG5hdmlnYXRvcl91c2VyX2FnZW50PVRydWUsICAgICMgbGV0IHN0ZWFsdGggZml4IFVBIGluY29uc2lzdGVuY2llcwogICAgICAgICAgICAgICAgbmF2aWdhdG9yX3BsYXRmb3JtPVRydWUsICAgICAgIyBsZXQgc3RlYWx0aCBmaXggcGxhdGZvcm0gbGVha3MKICAgICAgICAgICAgICAgIHNlY19jaF91YT1UcnVlLCAgICAgICAgICAgICAgICMgZml4IENsaWVudCBIaW50cyBoZWFkZXIKICAgICAgICAgICAgKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuX3N0ZWFsdGguYXBwbHlfc3RlYWx0aF9zeW5jKHNlbGYuY29udGV4dCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4YzoKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJTdGVhbHRoIGFwcGx5IG9uIGNvbnRleHQgZmFpbGVkOiAlcyIsIGV4YykKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9zdGVhbHRoLmFwcGx5X3N0ZWFsdGhfc3luYyhzZWxmLnBhZ2UpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiU3RlYWx0aCBhcHBseSBvbiBwYWdlIGZhaWxlZDogJXMiLCBleGMpCgogICAgICAgICMgQ3JpdGljYWwgZmluZ2VycHJpbnQgaGFyZGVuaW5nICh3ZWJkcml2ZXIsIHBsdWdpbnMsIGNhbnZhcywgV2ViR0wpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmNvbnRleHQuYWRkX2luaXRfc2NyaXB0KGdldF9maW5nZXJwcmludF9zY3JpcHRzKHNlbGYuX3VzZXJfYWdlbnQpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXhjOgogICAgICAgICAgICBsb2dnZXIuZGVidWcoIkluaXQgZmluZ2VycHJpbnQgc2NyaXB0IGZhaWxlZDogJXMiLCBleGMpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5jb250ZXh0LnNldF9leHRyYV9odHRwX2hlYWRlcnMoewogICAgICAgICAgICAgICAgIkFjY2VwdC1MYW5ndWFnZSI6ICJlbi1VUyxlbjtxPTAuOSIsCiAgICAgICAgICAgIH0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiU2V0dGluZyBleHRyYSBoZWFkZXJzIGZhaWxlZDogJXMiLCBleGMpCgogICAgZGVmIF9kZXRlY3Rfc2hlbGxfb3JfYmxvY2tlZF9wYWdlKHNlbGYsIHBhZ2Vfa2luZDogc3RyKSAtPiB0dXBsZVtib29sLCBkaWN0XToKICAgICAgICAiIiJSZXR1cm4gKGJsb2NrZWQsIGRpYWdub3N0aWNzKSBpZiBUaWtUb2sgc2VydmVkIGFuIGVtcHR5IHNoZWxsL3Jlc3RyaWN0ZWQgcGFnZS4iIiIKICAgICAgICBkaWFnbm9zdGljcyA9IHsKICAgICAgICAgICAgInZpZGVvX2NhcmRzIjogMCwKICAgICAgICAgICAgInByb2ZpbGVfYW5jaG9ycyI6IDAsCiAgICAgICAgICAgICJza2VsZXRvbnMiOiAwLAogICAgICAgICAgICAic2Nyb2xsX2hlaWdodCI6IDAsCiAgICAgICAgICAgICJoYXNfc2lnaV9zdGF0ZSI6IEZhbHNlLAogICAgICAgICAgICAiYmxvY2tlZF90ZXh0IjogIiIsCiAgICAgICAgfQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5wYWdlLndhaXRfZm9yX2xvYWRfc3RhdGUoImRvbWNvbnRlbnRsb2FkZWQiLCB0aW1lb3V0PTE1MDAwKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYucGFnZS53YWl0X2Zvcl9sb2FkX3N0YXRlKCJuZXR3b3JraWRsZSIsIHRpbWVvdXQ9MTUwMDApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIFBvc3QtbG9hZCBkZWxheTogVGlrVG9rJ3MgU1BBIG5lZWRzIGV4dHJhIHRpbWUgdG8gaHlkcmF0ZSBjb250ZW50CiAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgzLjAsIDUuMCkpCgogICAgICAgIHRyeToKICAgICAgICAgICAgZGlhZ25vc3RpY3MgPSBzZWxmLnBhZ2UuZXZhbHVhdGUoIiIiKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IChkb2N1bWVudC5ib2R5Py5pbm5lclRleHQgfHwgIiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkSGludHMgPSBbCiAgICAgICAgICAgICAgICAgICAgInNvbWV0aGluZyB3ZW50IHdyb25nIiwKICAgICAgICAgICAgICAgICAgICAidG9vIG1hbnkgcmVxdWVzdHMiLAogICAgICAgICAgICAgICAgICAgICJ0cnkgYWdhaW4gbGF0ZXIiLAogICAgICAgICAgICAgICAgICAgICJ0ZW1wb3JhcmlseSB1bmF2YWlsYWJsZSIsCiAgICAgICAgICAgICAgICAgICAgInZlcmlmeSB5b3UgYXJlIGh1bWFuIiwKICAgICAgICAgICAgICAgICAgICAic2VjdXJpdHkgdmVyaWZpY2F0aW9uIiwKICAgICAgICAgICAgICAgICAgICAiYWNjZXNzIGRlbmllZCIsCiAgICAgICAgICAgICAgICAgICAgImhhdmluZyB0cm91YmxlIHBsYXlpbmciCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgY29uc3QgbWF0Y2hlZEhpbnQgPSBibG9ja2VkSGludHMuZmluZCgoaCkgPT4gdGV4dC5pbmNsdWRlcyhoKSkgfHwgIiI7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHZpZGVvX2NhcmRzOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKAogICAgICAgICAgICAgICAgICAgICAgICAnW2RhdGEtZTJlPSJyZWNvbW1lbmQtbGlzdC1pdGVtLWNvbnRhaW5lciJdLFtkYXRhLWUyZT0ic2VhcmNoLWNhcmQtaXRlbSJdLGFbaHJlZio9Ii92aWRlby8iXScKICAgICAgICAgICAgICAgICAgICApLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBwcm9maWxlX2FuY2hvcnM6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2FbaHJlZio9Ii9AIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgc2tlbGV0b25zOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKAogICAgICAgICAgICAgICAgICAgICAgICAnW2NsYXNzKj0ic2tlbGV0b24iXSxbZGF0YS1lMmUqPSJza2VsZXRvbiJdLFtjbGFzcyo9IlNrZWxldG9uIl0nCiAgICAgICAgICAgICAgICAgICAgKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsX2hlaWdodDogZG9jdW1lbnQuYm9keSA/IGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0IDogMCwKICAgICAgICAgICAgICAgICAgICBoYXNfc2lnaV9zdGF0ZTogQm9vbGVhbihkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjU0lHSV9TVEFURScpKSwKICAgICAgICAgICAgICAgICAgICBibG9ja2VkX3RleHQ6IG1hdGNoZWRIaW50CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IiIiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgYmxvY2tlZCA9IEZhbHNlCiAgICAgICAgbG93X2NvbnRlbnQgPSAoCiAgICAgICAgICAgIGRpYWdub3N0aWNzWyJ2aWRlb19jYXJkcyJdID09IDAKICAgICAgICAgICAgYW5kIGRpYWdub3N0aWNzWyJwcm9maWxlX2FuY2hvcnMiXSA8PSAxCiAgICAgICAgICAgIGFuZCBkaWFnbm9zdGljc1sic2Nyb2xsX2hlaWdodCJdIDwgMTIwMAogICAgICAgICkKICAgICAgICBibG9ja2VkX2hpbnQgPSAoZGlhZ25vc3RpY3MuZ2V0KCJibG9ja2VkX3RleHQiKSBvciAiIikuc3RyaXAoKQogICAgICAgICMgT24gZmVlZCwgImhhdmluZyB0cm91YmxlIHBsYXlpbmciIGlzIG9mdGVuIGEgc2luZ2xlLXZpZGVvIGZhaWx1cmUsIG5vdCBhIGZ1bGwtcGFnZSBibG9jay4KICAgICAgICAjIERvbid0IHRyaWdnZXIgcmVmcmVzaDsgd2UnbGwgc2Nyb2xsIHRvIG5leHQgdmlkZW8gaW5zdGVhZC4KICAgICAgICBpZiBibG9ja2VkX2hpbnQgYW5kIG5vdCAocGFnZV9raW5kID09ICJmZWVkIiBhbmQgYmxvY2tlZF9oaW50ID09ICJoYXZpbmcgdHJvdWJsZSBwbGF5aW5nIik6CiAgICAgICAgICAgIGJsb2NrZWQgPSBUcnVlCiAgICAgICAgZWxpZiBwYWdlX2tpbmQgPT0gImhhc2h0YWciOgogICAgICAgICAgICBibG9ja2VkID0gZGlhZ25vc3RpY3NbInZpZGVvX2NhcmRzIl0gPT0gMCBhbmQgZGlhZ25vc3RpY3NbInByb2ZpbGVfYW5jaG9ycyJdIDw9IDIKICAgICAgICBlbGlmIHBhZ2Vfa2luZCA9PSAicHJvZmlsZSI6CiAgICAgICAgICAgIHByb2ZpbGVfdGl0bGVfb2sgPSBlbGVtZW50X2V4aXN0cyhzZWxmLnBhZ2UsIFNFTEVDVE9SU1sidXNlcl90aXRsZSJdLCB0aW1lb3V0PTEyMDApCiAgICAgICAgICAgIGJpb19vayA9IGVsZW1lbnRfZXhpc3RzKHNlbGYucGFnZSwgU0VMRUNUT1JTWyJiaW9fdGV4dCJdLCB0aW1lb3V0PTEyMDApCiAgICAgICAgICAgIGJsb2NrZWQgPSBub3QgcHJvZmlsZV90aXRsZV9vayBhbmQgbm90IGJpb19vayBhbmQgbG93X2NvbnRlbnQKICAgICAgICBlbGlmIHBhZ2Vfa2luZCA9PSAiZmVlZCI6CiAgICAgICAgICAgIGJsb2NrZWQgPSBkaWFnbm9zdGljc1sidmlkZW9fY2FyZHMiXSA9PSAwIGFuZCBkaWFnbm9zdGljc1sicHJvZmlsZV9hbmNob3JzIl0gPT0gMCBhbmQgbG93X2NvbnRlbnQKCiAgICAgICAgcmV0dXJuIGJsb2NrZWQsIGRpYWdub3N0aWNzCgogICAgZGVmIF9lbnN1cmVfcGFnZV9oYXNfY29udGVudCgKICAgICAgICBzZWxmLAogICAgICAgIHBhZ2Vfa2luZDogc3RyLAogICAgICAgIG1heF9yZXRyaWVzOiBpbnQgPSAyLAogICAgICAgIHJldHJ5X3Njcm9sbDogYm9vbCA9IFRydWUsCiAgICApIC0+IGJvb2w6CiAgICAgICAgIiIiUmV0cnkgbGlnaHQgaW50ZXJhY3Rpb25zIGFuZCBjb25maXJtIGNvbnRlbnQgZXhpc3RzIGJlZm9yZSBjb250aW51aW5nLiIiIgogICAgICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKG1heF9yZXRyaWVzICsgMSk6CiAgICAgICAgICAgIGJsb2NrZWQsIGRpYWcgPSBzZWxmLl9kZXRlY3Rfc2hlbGxfb3JfYmxvY2tlZF9wYWdlKHBhZ2Vfa2luZCkKICAgICAgICAgICAgaWYgbm90IGJsb2NrZWQ6CiAgICAgICAgICAgICAgICBpZiBhdHRlbXB0ID4gMDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiUmVjb3ZlcmVkICVzIHBhZ2UgY29udGVudCBvbiByZXRyeSAlZC4iLCBwYWdlX2tpbmQsIGF0dGVtcHQpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgbWF0Y2hlZF9oaW50ID0gZGlhZy5nZXQoImJsb2NrZWRfdGV4dCIsICIiKQogICAgICAgICAgICBsb2dnZXIud2FybmluZygKICAgICAgICAgICAgICAgICJMaWtlbHkgcmVzdHJpY3RlZC9lbXB0eSAlcyBwYWdlIChhdHRlbXB0ICVkLyVkKTogY2FyZHM9JXMgcHJvZmlsZXM9JXMgaGVpZ2h0PSVzIHNrZWxldG9ucz0lcyBtYXRjaGVkSGludD0nJXMnIiwKICAgICAgICAgICAgICAgIHBhZ2Vfa2luZCwKICAgICAgICAgICAgICAgIGF0dGVtcHQgKyAxLAogICAgICAgICAgICAgICAgbWF4X3JldHJpZXMgKyAxLAogICAgICAgICAgICAgICAgZGlhZy5nZXQoInZpZGVvX2NhcmRzIiksCiAgICAgICAgICAgICAgICBkaWFnLmdldCgicHJvZmlsZV9hbmNob3JzIiksCiAgICAgICAgICAgICAgICBkaWFnLmdldCgic2Nyb2xsX2hlaWdodCIpLAogICAgICAgICAgICAgICAgZGlhZy5nZXQoInNrZWxldG9ucyIpLAogICAgICAgICAgICAgICAgbWF0Y2hlZF9oaW50LAogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIGF0dGVtcHQgPCBtYXhfcmV0cmllczoKICAgICAgICAgICAgICAgICMgUmVmcmVzaCB0aGUgcGFnZSDigJQgb2Z0ZW4gcmVzb2x2ZXMgVGlrVG9rJ3MgdHJhbnNpZW50IGVycm9ycwogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJSZWZyZXNoaW5nIHBhZ2UgdG8gcmVjb3ZlciBmcm9tICclcycg4oCmIiwgbWF0Y2hlZF9oaW50IG9yICdlbXB0eSBwYWdlJykKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhZ2UucmVsb2FkKHdhaXRfdW50aWw9ImRvbWNvbnRlbnRsb2FkZWQiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBpZiByZXRyeV9zY3JvbGw6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBodW1hbl9zY3JvbGxfbmV4dF92aWRlbyhzZWxmLnBhZ2UpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgcmFuZG9tX3NsZWVwKDQuMCwgOC4wLCBwYWdlPXNlbGYucGFnZSkKCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9tYXJrX3NvZnRfYmxvY2soc2VsZiwgcmVhc29uOiBzdHIpIC0+IE5vbmU6CiAgICAgICAgIiIiTWFyayBjdXJyZW50IHNlc3Npb24gYXMgY29udGVudC1yZXN0cmljdGVkIGFuZCBiYWNrIG9mZi4KCiAgICAgICAgSU1QT1JUQU5UOiBUaGlzIGRvZXMgTk9UIHNldCBfY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uLgogICAgICAgIEEgc2luZ2xlIGNvbnRlbnQtYmxvY2tlZCBwYWdlIHNob3VsZCBub3Qga2lsbCB0aGUgZW50aXJlIHNlc3Npb24uCiAgICAgICAgT25seSBhIHJlYWwgQ0FQVENIQSBzaG91bGQgcHJldmVudCBhbGwgcmVtYWluaW5nIHRhc2tzLgogICAgICAgICIiIgogICAgICAgIHNlbGYuX2NvbnRlbnRfYmxvY2tlZF90aGlzX3Nlc3Npb24gPSBUcnVlCiAgICAgICAgdHJ5OgogICAgICAgICAgICBnZXRfdGhyb3R0bGUoKS5idW1wKDEuMCwgcmVhc29uPWYic29mdC1ibG9jazp7cmVhc29ufSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGNvb2xkb3duID0gcmFuZG9tLnVuaWZvcm0oMTUsIDM1KQogICAgICAgIGxvZ2dlci53YXJuaW5nKCJTb2Z0LWJsb2NrIHN1c3BlY3RlZCAoJXMpLiBCYWNraW5nIG9mZiBmb3IgJS4wZiBzLiIsIHJlYXNvbiwgY29vbGRvd24pCiAgICAgICAgaWRsZV9zbGVlcChzZWxmLnBhZ2UsIGNvb2xkb3duKQoKICAgIGRlZiBfY2xlYXJfcHJvZmlsZV9sb2NrcyhzZWxmKSAtPiBOb25lOgogICAgICAgICIiIlJlbW92ZSBzdGFsZSBDaHJvbWUgcHJvZmlsZSBsb2NrIGZpbGVzIHRoYXQgY2FuIGNhdXNlIGxhdW5jaCBmYWlsdXJlcy4iIiIKICAgICAgICBmb3IgbG9ja19maWxlIGluICgiU2luZ2xldG9uTG9jayIsICJTaW5nbGV0b25Db29raWUiLCAiU2luZ2xldG9uU29ja2V0Iik6CiAgICAgICAgICAgIGxvY2tfcGF0aCA9IG9zLnBhdGguam9pbihCUk9XU0VSX0RBVEFfRElSLCBsb2NrX2ZpbGUpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLnJlbW92ZShsb2NrX3BhdGgpCiAgICAgICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2xhdW5jaF9icm93c2VyKHNlbGYsIGhlYWRsZXNzOiBib29sID0gRmFsc2UpIC0+IE5vbmU6CiAgICAgICAgIiIiTGF1bmNoIGJyb3dzZXIgdXNpbmcgcGhhbnRvbXdyaWdodCdzIHBhdGNoZWQgQ2hyb21pdW0gYmluYXJ5LgoKICAgICAgICBTdHJhdGVneToKICAgICAgICAxLiBQUklNQVJZOiBsYXVuY2hfcGVyc2lzdGVudF9jb250ZXh0IHdpdGggcGhhbnRvbXdyaWdodCdzIHBhdGNoZWQKICAgICAgICAgICBDaHJvbWl1bSAod2l0aCByZXRyaWVzIGFuZCBsb2NrIGNsZWFudXAg4oCUIGZpeGVzICJNYWNoIHJlbmRlenZvdXMiCiAgICAgICAgICAgZmFpbHVyZXMgb24gbWFjT1MpLgogICAgICAgIDIuIEZBTExCQUNLIEE6IElmIHBlcnNpc3RlbnQgY29udGV4dCBhbHdheXMgZmFpbHMsIHRyeSBsYXVuY2goKSB3aXRoCiAgICAgICAgICAgZXBoZW1lcmFsIHByb2ZpbGUgKG5vIHVzZXJfZGF0YV9kaXIpOyBzZXNzaW9uIHJlc3RvcmVkIHZpYSBhdXRoLmpzb24uCiAgICAgICAgMy4gRkFMTEJBQ0sgQjogUmVhbCBDaHJvbWUgKyBDRFAgaWYgcGF0Y2hlZCBDaHJvbWl1bSBjYW5ub3Qgc3RhcnQuCiAgICAgICAgIiIiCiAgICAgICAgb3MubWFrZWRpcnMoQlJPV1NFUl9EQVRBX0RJUiwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICB2aWV3cG9ydCA9IHJhbmRvbV92aWV3cG9ydCgpCgogICAgICAgIHNlbGYuX2NsZWFyX3Byb2ZpbGVfbG9ja3MoKQoKICAgICAgICAjIEtpbGwgYW55IGxlZnRvdmVyIENocm9tZS9DaHJvbWl1bSBvbiBkZWJ1ZyBwb3J0CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgc3VicHJvY2VzcyBhcyBfc3AKICAgICAgICAgICAgcmVzdWx0ID0gX3NwLnJ1bigKICAgICAgICAgICAgICAgIFsibHNvZiIsICItdGkiLCAiOjkyMjIiXSwKICAgICAgICAgICAgICAgIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSwKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiByZXN1bHQuc3Rkb3V0LnN0cmlwKCk6CiAgICAgICAgICAgICAgICBmb3IgcGlkIGluIHJlc3VsdC5zdGRvdXQuc3RyaXAoKS5zcGxpdCgiXG4iKToKICAgICAgICAgICAgICAgICAgICBfc3AucnVuKFsia2lsbCIsICItOSIsIHBpZC5zdHJpcCgpXSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGNocm9taXVtX2FyZ3MgPSBbCiAgICAgICAgICAgICItLW5vLWZpcnN0LXJ1biIsCiAgICAgICAgICAgICItLW5vLWRlZmF1bHQtYnJvd3Nlci1jaGVjayIsCiAgICAgICAgICAgICItLWRpc2FibGUtZmVhdHVyZXM9VHJhbnNsYXRlVUkiLAogICAgICAgICAgICAiLS1kaXNhYmxlLXN5bmMiLAogICAgICAgICAgICAiLS1oaWRlLWNyYXNoLXJlc3RvcmUtYnViYmxlIiwKICAgICAgICAgICAgIi0tZGlzYWJsZS1zZXNzaW9uLWNyYXNoZWQtYnViYmxlIiwKICAgICAgICAgICAgIi0tYXV0b3BsYXktcG9saWN5PW5vLXVzZXItZ2VzdHVyZS1yZXF1aXJlZCIsCiAgICAgICAgICAgICItLWRpc2FibGUtYmxpbmstZmVhdHVyZXM9QXV0b21hdGlvbkNvbnRyb2xsZWQiLAogICAgICAgIF0KCiAgICAgICAgIyBPbiBtYWNPUywgcGVyc2lzdGVudCBjb250ZXh0IG9mdGVuIGZhaWxzIChNYWNoIHJlbmRlenZvdXMgLyBTU0wpLiBUcnkgZXBoZW1lcmFsIGZpcnN0LgogICAgICAgIF9pc19tYWMgPSBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAiRGFyd2luIgogICAgICAgIGxhc3RfcGVyc2lzdGVudF9lcnIgPSBOb25lCiAgICAgICAgZXBoZW1lcmFsX2VyciA9IE5vbmUKCiAgICAgICAgaWYgX2lzX21hYzoKICAgICAgICAgICAgIyDilIDilIAgbWFjT1M6IHRyeSBlcGhlbWVyYWwgZmlyc3QgKG9uZSBjbGVhbiBhdHRlbXB0LCBubyBub2lzeSBmYWlsdXJlcykg4pSA4pSACiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgICJMYXVuY2hpbmcgcGhhbnRvbXdyaWdodCBwYXRjaGVkIENocm9taXVtIChlcGhlbWVyYWwgcHJvZmlsZTsgc2Vzc2lvbiBmcm9tIGF1dGguanNvbikg4oCmIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgc2VsZi5wbGF5d3JpZ2h0ID0gc3luY19wbGF5d3JpZ2h0KCkuc3RhcnQoKQogICAgICAgICAgICAgICAgc2VsZi5icm93c2VyID0gc2VsZi5wbGF5d3JpZ2h0LmNocm9taXVtLmxhdW5jaCgKICAgICAgICAgICAgICAgICAgICBoZWFkbGVzcz1oZWFkbGVzcywKICAgICAgICAgICAgICAgICAgICBhcmdzPWNocm9taXVtX2FyZ3MsCiAgICAgICAgICAgICAgICAgICAgaWdub3JlX2RlZmF1bHRfYXJncz1bIi0tZW5hYmxlLWF1dG9tYXRpb24iXSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IHNlbGYuYnJvd3Nlci5uZXdfY29udGV4dCgKICAgICAgICAgICAgICAgICAgICB2aWV3cG9ydD12aWV3cG9ydCwKICAgICAgICAgICAgICAgICAgICBsb2NhbGU9ImVuLVVTIiwKICAgICAgICAgICAgICAgICAgICB0aW1lem9uZV9pZD0iQW1lcmljYS9OZXdfWW9yayIsCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBzZWxmLnBhZ2UgPSBzZWxmLmNvbnRleHQubmV3X3BhZ2UoKQogICAgICAgICAgICAgICAgc2VsZi5fYXBwbHlfc3RlYWx0aF9sYXllcnMoKQogICAgICAgICAgICAgICAgc2VsZi5wYWdlLmdvdG8oImh0dHBzOi8vd3d3LnRpa3Rvay5jb20iLCB3YWl0X3VudGlsPSJkb21jb250ZW50bG9hZGVkIiwgdGltZW91dD0yMDAwMCkKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICAgICAgICAgIGlmICJ0aWt0b2suY29tIiBpbiAoc2VsZi5wYWdlLnVybCBvciAiIikubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICAgICAgICAgIlBoYW50b213cmlnaHQgcGF0Y2hlZCBDaHJvbWl1bSByZWFkeSAodmlld3BvcnQ9JWR4JWQpLiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdwb3J0WyJ3aWR0aCJdLCB2aWV3cG9ydFsiaGVpZ2h0Il0sCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKGYiVGlrVG9rIG5vdCByZWFjaGFibGUgKGdvdCB7c2VsZi5wYWdlLnVybH0pIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXBoZW1lcmFsX2VyciA9IGUKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJQYXRjaGVkIENocm9taXVtIChlcGhlbWVyYWwpIGZhaWxlZDogJXMuIFRyeWluZyBwZXJzaXN0ZW50IGNvbnRleHQg4oCmIiwgZSkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmNvbnRleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dC5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmJyb3dzZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYnJvd3Nlci5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnBsYXl3cmlnaHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGxheXdyaWdodC5zdG9wKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5wYWdlID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5icm93c2VyID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5wbGF5d3JpZ2h0ID0gTm9uZQoKICAgICAgICAjIOKUgOKUgCBQZXJzaXN0ZW50IGNvbnRleHQgKHdpdGggcmV0cmllczsgc2tpcHBlZCBvbiBtYWNPUyBpZiBlcGhlbWVyYWwgYWxyZWFkeSBzdWNjZWVkZWQpIOKUgOKUgAogICAgICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKDEsIFBIQU5UT01XUklHSFRfTEFVTkNIX1JFVFJJRVMgKyAxKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgYXR0ZW1wdCA+IDE6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xlYXJfcHJvZmlsZV9sb2NrcygpCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgyKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAgICAgIkxhdW5jaGluZyBwaGFudG9td3JpZ2h0IHBhdGNoZWQgQ2hyb21pdW0gKHBlcnNpc3RlbnQsIGF0dGVtcHQgJWQvJWQpIOKApiIsCiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdCwgUEhBTlRPTVdSSUdIVF9MQVVOQ0hfUkVUUklFUywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHNlbGYucGxheXdyaWdodCA9IHN5bmNfcGxheXdyaWdodCgpLnN0YXJ0KCkKICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IHNlbGYucGxheXdyaWdodC5jaHJvbWl1bS5sYXVuY2hfcGVyc2lzdGVudF9jb250ZXh0KAogICAgICAgICAgICAgICAgICAgIHVzZXJfZGF0YV9kaXI9b3MucGF0aC5hYnNwYXRoKEJST1dTRVJfREFUQV9ESVIpLAogICAgICAgICAgICAgICAgICAgIGhlYWRsZXNzPWhlYWRsZXNzLAogICAgICAgICAgICAgICAgICAgIHZpZXdwb3J0PXZpZXdwb3J0LAogICAgICAgICAgICAgICAgICAgIGxvY2FsZT0iZW4tVVMiLAogICAgICAgICAgICAgICAgICAgIHRpbWV6b25lX2lkPSJBbWVyaWNhL05ld19Zb3JrIiwKICAgICAgICAgICAgICAgICAgICBhcmdzPWNocm9taXVtX2FyZ3MsCiAgICAgICAgICAgICAgICAgICAgaWdub3JlX2RlZmF1bHRfYXJncz1bIi0tZW5hYmxlLWF1dG9tYXRpb24iXSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHNlbGYuYnJvd3NlciA9IHNlbGYuY29udGV4dC5icm93c2VyCiAgICAgICAgICAgICAgICBzZWxmLnBhZ2UgPSBzZWxmLmNvbnRleHQucGFnZXNbMF0gaWYgc2VsZi5jb250ZXh0LnBhZ2VzIGVsc2Ugc2VsZi5jb250ZXh0Lm5ld19wYWdlKCkKICAgICAgICAgICAgICAgIHNlbGYuX2FwcGx5X3N0ZWFsdGhfbGF5ZXJzKCkKICAgICAgICAgICAgICAgIHNlbGYucGFnZS5nb3RvKCJodHRwczovL3d3dy50aWt0b2suY29tIiwgd2FpdF91bnRpbD0iZG9tY29udGVudGxvYWRlZCIsIHRpbWVvdXQ9MjAwMDApCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDIpCiAgICAgICAgICAgICAgICBpZiAidGlrdG9rLmNvbSIgaW4gKHNlbGYucGFnZS51cmwgb3IgIiIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAgICAgICAgICJQaGFudG9td3JpZ2h0IHBhdGNoZWQgQ2hyb21pdW0gcmVhZHkgKHZpZXdwb3J0PSVkeCVkKS4iLAogICAgICAgICAgICAgICAgICAgICAgICB2aWV3cG9ydFsid2lkdGgiXSwgdmlld3BvcnRbImhlaWdodCJdLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIlRpa1RvayBub3QgcmVhY2hhYmxlIChnb3Qge3NlbGYucGFnZS51cmx9KSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgbmF2X2VycjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmNvbnRleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dC5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYucGFnZSA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYuYnJvd3NlciA9IE5vbmUKICAgICAgICAgICAgICAgIGlmIHNlbGYucGxheXdyaWdodDoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGxheXdyaWdodC5zdG9wKCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wbGF5d3JpZ2h0ID0gTm9uZQogICAgICAgICAgICAgICAgbGFzdF9wZXJzaXN0ZW50X2VyciA9IG5hdl9lcnIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJQYXRjaGVkIENocm9taXVtIChwZXJzaXN0ZW50KSBhdHRlbXB0ICVkIGZhaWxlZDogJXMiLCBhdHRlbXB0LCBuYXZfZXJyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgZXBoZW1lcmFsX2VyciBpcyBOb25lOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiUGVyc2lzdGVudCBjb250ZXh0IGZhaWxlZC4gVHJ5aW5nIGVwaGVtZXJhbCBwcm9maWxlIOKApiIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYucGxheXdyaWdodCA9IHN5bmNfcGxheXdyaWdodCgpLnN0YXJ0KCkKICAgICAgICAgICAgICAgIHNlbGYuYnJvd3NlciA9IHNlbGYucGxheXdyaWdodC5jaHJvbWl1bS5sYXVuY2goCiAgICAgICAgICAgICAgICAgICAgaGVhZGxlc3M9aGVhZGxlc3MsCiAgICAgICAgICAgICAgICAgICAgYXJncz1jaHJvbWl1bV9hcmdzLAogICAgICAgICAgICAgICAgICAgIGlnbm9yZV9kZWZhdWx0X2FyZ3M9WyItLWVuYWJsZS1hdXRvbWF0aW9uIl0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQgPSBzZWxmLmJyb3dzZXIubmV3X2NvbnRleHQoCiAgICAgICAgICAgICAgICAgICAgdmlld3BvcnQ9dmlld3BvcnQsCiAgICAgICAgICAgICAgICAgICAgbG9jYWxlPSJlbi1VUyIsCiAgICAgICAgICAgICAgICAgICAgdGltZXpvbmVfaWQ9IkFtZXJpY2EvTmV3X1lvcmsiLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgc2VsZi5wYWdlID0gc2VsZi5jb250ZXh0Lm5ld19wYWdlKCkKICAgICAgICAgICAgICAgIHNlbGYuX2FwcGx5X3N0ZWFsdGhfbGF5ZXJzKCkKICAgICAgICAgICAgICAgIHNlbGYucGFnZS5nb3RvKCJodHRwczovL3d3dy50aWt0b2suY29tIiwgd2FpdF91bnRpbD0iZG9tY29udGVudGxvYWRlZCIsIHRpbWVvdXQ9MjAwMDApCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDIpCiAgICAgICAgICAgICAgICBpZiAidGlrdG9rLmNvbSIgaW4gKHNlbGYucGFnZS51cmwgb3IgIiIpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAgICAgICAgICJQaGFudG9td3JpZ2h0IHBhdGNoZWQgQ2hyb21pdW0gcmVhZHkgKGVwaGVtZXJhbCwgdmlld3BvcnQ9JWR4JWQpLiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdwb3J0WyJ3aWR0aCJdLCB2aWV3cG9ydFsiaGVpZ2h0Il0sCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKGYiVGlrVG9rIG5vdCByZWFjaGFibGUgKGdvdCB7c2VsZi5wYWdlLnVybH0pIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXBoZW1lcmFsX2VyciA9IGUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmNvbnRleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dC5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmJyb3dzZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYnJvd3Nlci5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnBsYXl3cmlnaHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGxheXdyaWdodC5zdG9wKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5wYWdlID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5icm93c2VyID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5wbGF5d3JpZ2h0ID0gTm9uZQoKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgIlBhdGNoZWQgQ2hyb21pdW0gZmFpbGVkICglcykuIFVzaW5nIENEUCBmYWxsYmFjay4iLAogICAgICAgICAgICBsYXN0X3BlcnNpc3RlbnRfZXJyIG9yIGVwaGVtZXJhbF9lcnIsCiAgICAgICAgKQoKICAgICAgICAjIOKUgOKUgCBGQUxMQkFDSzogVXNlcidzIHJlYWwgQ2hyb21lICsgQ0RQIOKUgOKUgAogICAgICAgIGNocm9tZV9wYXRoID0gc2VsZi5fZmluZF9jaHJvbWUoKQogICAgICAgIGlmIG5vdCBjaHJvbWVfcGF0aDoKICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKAogICAgICAgICAgICAgICAgIkdvb2dsZSBDaHJvbWUgbm90IGZvdW5kLiBQbGVhc2UgaW5zdGFsbCBDaHJvbWUuXG4iCiAgICAgICAgICAgICAgICAiT24gTWFjOiAvQXBwbGljYXRpb25zL0dvb2dsZSBDaHJvbWUuYXBwXG4iCiAgICAgICAgICAgICAgICAiT24gV2luZG93czogQzpcXFByb2dyYW0gRmlsZXNcXEdvb2dsZVxcQ2hyb21lXFxBcHBsaWNhdGlvblxcY2hyb21lLmV4ZVxuIgogICAgICAgICAgICAgICAgIk9uIExpbnV4OiBnb29nbGUtY2hyb21lIG9yIGNocm9taXVtLWJyb3dzZXIiCiAgICAgICAgICAgICkKCiAgICAgICAgY2RwX3BvcnQgPSA5MjIyCiAgICAgICAgaW1wb3J0IHN1YnByb2Nlc3MKICAgICAgICBjaHJvbWVfYXJncyA9IFsKICAgICAgICAgICAgY2hyb21lX3BhdGgsCiAgICAgICAgICAgIGYiLS1yZW1vdGUtZGVidWdnaW5nLXBvcnQ9e2NkcF9wb3J0fSIsCiAgICAgICAgICAgIGYiLS11c2VyLWRhdGEtZGlyPXtvcy5wYXRoLmFic3BhdGgoQlJPV1NFUl9EQVRBX0RJUil9IiwKICAgICAgICAgICAgZiItLXdpbmRvdy1zaXplPXt2aWV3cG9ydFsnd2lkdGgnXX0se3ZpZXdwb3J0WydoZWlnaHQnXX0iLAogICAgICAgICAgICAiLS1uby1maXJzdC1ydW4iLAogICAgICAgICAgICAiLS1uby1kZWZhdWx0LWJyb3dzZXItY2hlY2siLAogICAgICAgICAgICAiLS1kaXNhYmxlLWZlYXR1cmVzPVRyYW5zbGF0ZVVJIiwKICAgICAgICAgICAgIi0tZGlzYWJsZS1zeW5jIiwKICAgICAgICAgICAgIi0taGlkZS1jcmFzaC1yZXN0b3JlLWJ1YmJsZSIsCiAgICAgICAgICAgICItLWRpc2FibGUtc2Vzc2lvbi1jcmFzaGVkLWJ1YmJsZSIsCiAgICAgICAgICAgICItLWF1dG9wbGF5LXBvbGljeT1uby11c2VyLWdlc3R1cmUtcmVxdWlyZWQiLAogICAgICAgICAgICAiaHR0cHM6Ly93d3cudGlrdG9rLmNvbSIsCiAgICAgICAgXQoKICAgICAgICBsb2dnZXIuaW5mbygiTGF1bmNoaW5nIHJlYWwgQ2hyb21lIChDRFAgZmFsbGJhY2spOiAlcyIsIGNocm9tZV9wYXRoKQogICAgICAgIHNlbGYuX2Nocm9tZV9wcm9jZXNzID0gc3VicHJvY2Vzcy5Qb3BlbigKICAgICAgICAgICAgY2hyb21lX2FyZ3MsCiAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLkRFVk5VTEwsCiAgICAgICAgICAgIHN0ZGVycj1zdWJwcm9jZXNzLkRFVk5VTEwsCiAgICAgICAgKQoKICAgICAgICBpbXBvcnQgdXJsbGliLnJlcXVlc3QKICAgICAgICB3c191cmwgPSBOb25lCiAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMjApOgogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlc3AgPSB1cmxsaWIucmVxdWVzdC51cmxvcGVuKAogICAgICAgICAgICAgICAgICAgIGYiaHR0cDovLzEyNy4wLjAuMTp7Y2RwX3BvcnR9L2pzb24vdmVyc2lvbiIsIHRpbWVvdXQ9MgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZGF0YSA9IGpzb24ubG9hZHMocmVzcC5yZWFkKCkuZGVjb2RlKCkpCiAgICAgICAgICAgICAgICB3c191cmwgPSBkYXRhLmdldCgid2ViU29ja2V0RGVidWdnZXJVcmwiLCAiIikKICAgICAgICAgICAgICAgIGlmIHdzX3VybDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ2hyb21lIERldlRvb2xzIHJlYWR5OiAlcyIsIHdzX3VybFs6NjBdKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIG5vdCB3c191cmw6CiAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigKICAgICAgICAgICAgICAgICJDaHJvbWUgc3RhcnRlZCBidXQgRGV2VG9vbHMgbm90IHJlYWNoYWJsZSBvbiBwb3J0ICIKICAgICAgICAgICAgICAgIGYie2NkcF9wb3J0fS4gSXMgYW5vdGhlciBDaHJvbWUgaW5zdGFuY2UgcnVubmluZz8iCiAgICAgICAgICAgICkKCiAgICAgICAgaWYgbm90IHNlbGYucGxheXdyaWdodDoKICAgICAgICAgICAgc2VsZi5wbGF5d3JpZ2h0ID0gc3luY19wbGF5d3JpZ2h0KCkuc3RhcnQoKQogICAgICAgIHNlbGYuYnJvd3NlciA9IHNlbGYucGxheXdyaWdodC5jaHJvbWl1bS5jb25uZWN0X292ZXJfY2RwKHdzX3VybCkKICAgICAgICBzZWxmLmNvbnRleHQgPSBzZWxmLmJyb3dzZXIuY29udGV4dHNbMF0KICAgICAgICBpZiBzZWxmLmNvbnRleHQucGFnZXM6CiAgICAgICAgICAgIHNlbGYucGFnZSA9IHNlbGYuY29udGV4dC5wYWdlc1swXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYucGFnZSA9IHNlbGYuY29udGV4dC5uZXdfcGFnZSgpCgogICAgICAgIHNlbGYuX2FwcGx5X3N0ZWFsdGhfbGF5ZXJzKCkKCiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICJDb25uZWN0ZWQgdmlhIENEUCBmYWxsYmFjayAocG9ydCAlZCwgdmlld3BvcnQ9JWR4JWQpLiAiCiAgICAgICAgICAgICLimqDvuI8gIFByb2ZpbGUgdmlzaXRzIG1heSB0cmlnZ2VyIENBUFRDSEFzIOKAlCBwYXRjaGVkIENocm9taXVtIHByZWZlcnJlZC4iLAogICAgICAgICAgICBjZHBfcG9ydCwgdmlld3BvcnRbIndpZHRoIl0sIHZpZXdwb3J0WyJoZWlnaHQiXSwKICAgICAgICApCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9maW5kX2Nocm9tZSgpIC0+IHN0ciB8IE5vbmU6CiAgICAgICAgIiIiRmluZCB0aGUgcmVhbCBDaHJvbWUgZXhlY3V0YWJsZSBvbiB0aGUgc3lzdGVtLiIiIgogICAgICAgIHN5c3RlbSA9IHBsYXRmb3JtLnN5c3RlbSgpCgogICAgICAgIGlmIHN5c3RlbSA9PSAiRGFyd2luIjoKICAgICAgICAgICAgcGF0aHMgPSBbCiAgICAgICAgICAgICAgICAiL0FwcGxpY2F0aW9ucy9Hb29nbGUgQ2hyb21lLmFwcC9Db250ZW50cy9NYWNPUy9Hb29nbGUgQ2hyb21lIiwKICAgICAgICAgICAgICAgIG9zLnBhdGguZXhwYW5kdXNlcigifi9BcHBsaWNhdGlvbnMvR29vZ2xlIENocm9tZS5hcHAvQ29udGVudHMvTWFjT1MvR29vZ2xlIENocm9tZSIpLAogICAgICAgICAgICBdCiAgICAgICAgZWxpZiBzeXN0ZW0gPT0gIldpbmRvd3MiOgogICAgICAgICAgICBwYXRocyA9IFsKICAgICAgICAgICAgICAgIHIiQzpcUHJvZ3JhbSBGaWxlc1xHb29nbGVcQ2hyb21lXEFwcGxpY2F0aW9uXGNocm9tZS5leGUiLAogICAgICAgICAgICAgICAgciJDOlxQcm9ncmFtIEZpbGVzICh4ODYpXEdvb2dsZVxDaHJvbWVcQXBwbGljYXRpb25cY2hyb21lLmV4ZSIsCiAgICAgICAgICAgICAgICBvcy5wYXRoLmV4cGFuZHZhcnMociIlTE9DQUxBUFBEQVRBJVxHb29nbGVcQ2hyb21lXEFwcGxpY2F0aW9uXGNocm9tZS5leGUiKSwKICAgICAgICAgICAgXQogICAgICAgIGVsc2U6ICAjIExpbnV4CiAgICAgICAgICAgIHBhdGhzID0gWwogICAgICAgICAgICAgICAgIi91c3IvYmluL2dvb2dsZS1jaHJvbWUiLAogICAgICAgICAgICAgICAgIi91c3IvYmluL2dvb2dsZS1jaHJvbWUtc3RhYmxlIiwKICAgICAgICAgICAgICAgICIvdXNyL2Jpbi9jaHJvbWl1bS1icm93c2VyIiwKICAgICAgICAgICAgICAgICIvdXNyL2Jpbi9jaHJvbWl1bSIsCiAgICAgICAgICAgICAgICAiL3NuYXAvYmluL2Nocm9taXVtIiwKICAgICAgICAgICAgXQoKICAgICAgICBmb3IgcGF0aCBpbiBwYXRoczoKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUocGF0aCk6CiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aAoKICAgICAgICBpbXBvcnQgc2h1dGlsCiAgICAgICAgZm9yIG5hbWUgaW4gKCJnb29nbGUtY2hyb21lIiwgImdvb2dsZS1jaHJvbWUtc3RhYmxlIiwgImNocm9taXVtLWJyb3dzZXIiLCAiY2hyb21pdW0iKToKICAgICAgICAgICAgZm91bmQgPSBzaHV0aWwud2hpY2gobmFtZSkKICAgICAgICAgICAgaWYgZm91bmQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmQKCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgY2xvc2Uoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiJHcmFjZWZ1bGx5IHNodXQgZG93biBicm93c2VyIGFuZCBQbGF5d3JpZ2h0IChpZGVtcG90ZW50KS4iIiIKICAgICAgICBpZiBzZWxmLl9jbG9zZWQ6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHNlbGYuX2Nsb3NlZCA9IFRydWUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLmNvbnRleHQ6CiAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQuY2xvc2UoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuYnJvd3NlcjoKICAgICAgICAgICAgICAgIHNlbGYuYnJvd3Nlci5jbG9zZSgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5wbGF5d3JpZ2h0OgogICAgICAgICAgICAgICAgc2VsZi5wbGF5d3JpZ2h0LnN0b3AoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyBLaWxsIENocm9tZSBzdWJwcm9jZXNzIGlmIHdlIGxhdW5jaGVkIG9uZSAoQ0RQIGZhbGxiYWNrKQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX2Nocm9tZV9wcm9jZXNzIikgYW5kIHNlbGYuX2Nocm9tZV9wcm9jZXNzOgogICAgICAgICAgICAgICAgc2VsZi5fY2hyb21lX3Byb2Nlc3MudGVybWluYXRlKCkKICAgICAgICAgICAgICAgIHNlbGYuX2Nocm9tZV9wcm9jZXNzLndhaXQodGltZW91dD01KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX2Nocm9tZV9wcm9jZXNzLmtpbGwoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICBsb2dnZXIuaW5mbygiQnJvd3NlciBjbG9zZWQuIikKCiAgICAjIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogICAgIyBBdXRoZW50aWNhdGlvbgogICAgIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKICAgIGRlZiBsb2dpbl9tYW51YWwoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiJGaXJzdC1ydW4gbG9naW4gZmxvdy4KCiAgICAgICAgT3BlbnMgVGlrVG9rIGxvZ2luIHBhZ2Ugc28gdGhlIHVzZXIgY2FuIHNjYW4gdGhlIFFSIGNvZGUgb3IKICAgICAgICBsb2cgaW4gbWFudWFsbHkuICBPbmNlIGF1dGhlbnRpY2F0ZWQsIGNvb2tpZXMgYXJlIHNhdmVkIHRvCiAgICAgICAgQ09PS0lFU19QQVRIIGZvciBhbGwgZnV0dXJlIHJ1bnMuCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIj09PSBNQU5VQUwgTE9HSU4gTU9ERSA9PT0iKQogICAgICAgIHNlbGYuX2xhdW5jaF9icm93c2VyKGhlYWRsZXNzPUZhbHNlKQoKICAgICAgICBzZWxmLnBhZ2UuZ290byhUSUtUT0tfTE9HSU4sIHdhaXRfdW50aWw9ImRvbWNvbnRlbnRsb2FkZWQiKQogICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfTUVESVVNKQoKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgIlBsZWFzZSBsb2cgaW4gbWFudWFsbHkgKFFSIGNvZGUgLyBjcmVkZW50aWFscykuICIKICAgICAgICAgICAgIlRoZSBib3Qgd2lsbCB3YWl0IHVwIHRvIDE4MCBzZWNvbmRzIOKApiIKICAgICAgICApCgogICAgICAgICMgUG9sbCBmb3IgbG9nZ2VkLWluIHN0YXRlIHVzaW5nIFBPU0lUSVZFIGRldGVjdGlvbgogICAgICAgIGxvZ2dlZF9pbiA9IEZhbHNlCiAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMTgwKToKICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfbG9nZ2VkX2luKCk6CiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBUcnVlCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgIGlmIGF0dGVtcHQgJSAxNSA9PSAwIGFuZCBhdHRlbXB0ID4gMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTdGlsbCB3YWl0aW5nIGZvciBsb2dpbiDigKYgKCVkIHMgZWxhcHNlZCkiLCBhdHRlbXB0KQoKICAgICAgICBpZiBub3QgbG9nZ2VkX2luOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygKICAgICAgICAgICAgICAgICJMb2dpbiBub3QgZGV0ZWN0ZWQgYWZ0ZXIgMTgwIHMuIFNhdmluZyBjb29raWVzIGFueXdheSDigJMgIgogICAgICAgICAgICAgICAgInlvdSBtYXkgbmVlZCB0byByZS1ydW4gaWYgdGhleSBhcmUgaW52YWxpZC4iCiAgICAgICAgICAgICkKCiAgICAgICAgc2VsZi5fc2F2ZV9jb29raWVzKCkKICAgICAgICBsb2dnZXIuaW5mbygiU2Vzc2lvbiBjb29raWVzIHNhdmVkIHRvICVzIiwgQ09PS0lFU19QQVRIKQogICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfU0hPUlQpCiAgICAgICAgIyBOT1RFOiBjbG9zZSgpIGlzIGNhbGxlZCBoZXJlOyBtYWluLnB5IHNob3VsZCBOT1QgZG91YmxlLWNsb3NlCgogICAgZGVmIGxvZ2luX2F1dG8oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiJMb2FkIHNhdmVkIHNlc3Npb24gYW5kIHZlcmlmeSBpdCBpcyBzdGlsbCB2YWxpZC4KCiAgICAgICAgV2l0aCB0aGUgcmVhbCBDaHJvbWUgKyBDRFAgYXBwcm9hY2gsIGNvb2tpZXMgcGVyc2lzdCBuYXRpdmVseSBpbiB0aGUKICAgICAgICBDaHJvbWUgcHJvZmlsZSBkaXJlY3RvcnkuICBXZSBjaGVjayBpZiB0aGUgc2Vzc2lvbiBpcyBhbHJlYWR5IHZhbGlkCiAgICAgICAgZmlyc3QsIGFuZCBvbmx5IGluamVjdCBjb29raWVzIGZyb20gYXV0aC5qc29uIGFzIGEgZmFsbGJhY2suCgogICAgICAgIFJldHVybnMgYGBUcnVlYGAgaWYgbG9naW4gc3VjY2VlZHMsIGBgRmFsc2VgYCBvdGhlcndpc2UuCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIj09PSBBVVRPIExPR0lOIE1PREUgPT09IikKCiAgICAgICAgc2VsZi5fbGF1bmNoX2Jyb3dzZXIoaGVhZGxlc3M9RmFsc2UpCgogICAgICAgICMgVGhlIHBhZ2UgbWF5IGFscmVhZHkgYmUgYXQgdGlrdG9rLmNvbSBmcm9tIHRoZSBDaHJvbWUgbGF1bmNoCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJyZW50X3VybCA9IHNlbGYucGFnZS51cmwKICAgICAgICAgICAgaWYgInRpa3Rvay5jb20iIG5vdCBpbiBjdXJyZW50X3VybDoKICAgICAgICAgICAgICAgIHNlbGYucGFnZS5nb3RvKFRJS1RPS19CQVNFLCB3YWl0X3VudGlsPSJkb21jb250ZW50bG9hZGVkIiwgdGltZW91dD02MDAwMCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJJbml0aWFsIHBhZ2UgbG9hZCBzbG93OiAlcyIsIGUpCgogICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfTUVESVVNKQoKICAgICAgICBsb2dnZXIuaW5mbygiQ3VycmVudCBVUkwgYWZ0ZXIgbmF2aWdhdGlvbjogJXMiLCBzZWxmLnBhZ2UudXJsKQoKICAgICAgICAjIOKUgOKUgCBDaGVjayAxOiBDaHJvbWUgcHJvZmlsZSBtYXkgYWxyZWFkeSBoYXZlIGEgdmFsaWQgc2Vzc2lvbiDilIDilIAKICAgICAgICBpZiBzZWxmLl9jaGVja19sb2dnZWRfaW4oKToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tbG9naW4gc3VjY2Vzc2Z1bCDigJMgQ2hyb21lIHByb2ZpbGUgc2Vzc2lvbiBpcyB2YWxpZC4iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAjIOKUgOKUgCBDaGVjayAyOiBUcnkgbG9hZGluZyBjb29raWVzIGZyb20gYXV0aC5qc29uIOKUgOKUgAogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKENPT0tJRVNfUEFUSCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJObyBhY3RpdmUgc2Vzc2lvbiBpbiBDaHJvbWUgcHJvZmlsZSwgbG9hZGluZyBjb29raWVzIGZyb20gYXV0aC5qc29uIOKApiIpCiAgICAgICAgICAgIHNlbGYuX2xvYWRfY29va2llcygpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYucGFnZS5yZWxvYWQod2FpdF91bnRpbD0iZG9tY29udGVudGxvYWRlZCIsIHRpbWVvdXQ9NjAwMDApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfTUVESVVNKQoKICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfbG9nZ2VkX2luKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQXV0by1sb2dpbiBzdWNjZXNzZnVsIHZpYSBhdXRoLmpzb24gY29va2llcy4iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgICMgRXh0cmEgd2FpdCArIHJldHJ5CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGaXJzdCBsb2dpbiBjaGVjayBuZWdhdGl2ZSwgd2FpdGluZyA1cyBhbmQgcmV0cnlpbmcg4oCmIikKICAgICAgICAgICAgcmFuZG9tX3NsZWVwKDQuMCwgNi4wKQoKICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfbG9nZ2VkX2luKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQXV0by1sb2dpbiBzdWNjZXNzZnVsIG9uIHJldHJ5IOKAkyBzZXNzaW9uIGlzIHZhbGlkLiIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAjIERlZmluaXRlbHkgbm90IGxvZ2dlZCBpbgogICAgICAgIGRlYnVnX3NjcmVlbnNob3QgPSBvcy5wYXRoLmpvaW4oQkFTRV9ESVIsICJkZWJ1Z19zY3JlZW5zaG90LnBuZyIpCiAgICAgICAgc2VsZi5wYWdlLnNjcmVlbnNob3QocGF0aD1kZWJ1Z19zY3JlZW5zaG90KQogICAgICAgIGxvZ2dlci5pbmZvKCJEZWJ1ZyBzY3JlZW5zaG90IHNhdmVkIHRvOiAlcyIsIGRlYnVnX3NjcmVlbnNob3QpCiAgICAgICAgbG9nZ2VyLmVycm9yKAogICAgICAgICAgICAiQXV0by1sb2dpbiBmYWlsZWQg4oCTIGNvb2tpZXMgbWF5IGhhdmUgZXhwaXJlZC4gIgogICAgICAgICAgICAiUGxlYXNlIHJlLXJ1biB3aXRoIG9wdGlvbiBbMl0gZm9yIG1hbnVhbCBsb2dpbi4iCiAgICAgICAgKQogICAgICAgIHNlbGYuY2xvc2UoKQogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfY2hlY2tfbG9nZ2VkX2luKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiUmV0dXJuIFRydWUgaWYgcG9zaXRpdmUgbG9nZ2VkLWluIGluZGljYXRvcnMgYXJlIGZvdW5kLgoKICAgICAgICBDaGVja3MgZm9yOgogICAgICAgIDEuIE5lZ2F0aXZlIGluZGljYXRvcnMgKExvZ2luIGJ1dHRvbikgLT4gcmV0dXJucyBGYWxzZSBpbW1lZGlhdGVseS4KICAgICAgICAyLiBQb3NpdGl2ZSBpbmRpY2F0b3JzIChQcm9maWxlL1VwbG9hZCBpY29uKSAtPiByZXR1cm5zIFRydWUuCiAgICAgICAgIiIiCiAgICAgICAgIyAxLiBDaGVjayBmb3IgZXhwbGljaXQgIkxvZyBpbiIgYnV0dG9ucwogICAgICAgIGZvciBzZWwgaW4gU0VMRUNUT1JTWyJsb2dnZWRfb3V0X2luZGljYXRvcnMiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgZWxlbWVudF9leGlzdHMoc2VsZi5wYWdlLCBzZWwsIHRpbWVvdXQ9ODAwKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkxvZ2dlZC1vdXQgaW5kaWNhdG9yIGZvdW5kOiAlcyIsIHNlbCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyAyLiBDaGVjayBmb3IgcG9zaXRpdmUgbG9nZ2VkLWluIGVsZW1lbnRzCiAgICAgICAgZm9yIHNlbGVjdG9yIGluIFNFTEVDVE9SU1sibG9nZ2VkX2luX2luZGljYXRvcnMiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgZWxlbWVudF9leGlzdHMoc2VsZi5wYWdlLCBzZWxlY3RvciwgdGltZW91dD0xNTAwKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkxvZ2dlZC1pbiBpbmRpY2F0b3IgZm91bmQ6ICVzIiwgc2VsZWN0b3IpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfc2F2ZV9jb29raWVzKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgY29va2llcyA9IHNlbGYuY29udGV4dC5jb29raWVzKCkKICAgICAgICB3aXRoIG9wZW4oQ09PS0lFU19QQVRILCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZoOgogICAgICAgICAgICBqc29uLmR1bXAoY29va2llcywgZmgsIGluZGVudD0yKQogICAgICAgIGxvZ2dlci5pbmZvKCJTYXZlZCAlZCBjb29raWVzLiIsIGxlbihjb29raWVzKSkKCiAgICBkZWYgX2xvYWRfY29va2llcyhzZWxmKSAtPiBOb25lOgogICAgICAgIHdpdGggb3BlbihDT09LSUVTX1BBVEgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmg6CiAgICAgICAgICAgIGNvb2tpZXMgPSBqc29uLmxvYWQoZmgpCiAgICAgICAgc2VsZi5jb250ZXh0LmFkZF9jb29raWVzKGNvb2tpZXMpCiAgICAgICAgbG9nZ2VyLmluZm8oIkxvYWRlZCAlZCBjb29raWVzIGZyb20gZGlzay4iLCBsZW4oY29va2llcykpCgogICAgIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKICAgICMgRmVlZCBJbnRlcmFjdGlvbiAoV2F0Y2ggLyBMaWtlKQogICAgIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKICAgIGRlZiBpbnRlcmFjdF9mZWVkKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiU2Nyb2xsIHRoZSBGb3ItWW91IHBhZ2UsIHdhdGNoIHZpZGVvcywgYW5kIGxpa2UgbmljaGUtcmVsYXRlZAogICAgICAgIGNvbnRlbnQgdG8gdHJhaW4gdGhlIGFsZ29yaXRobSB0b3dhcmQgdGhlIHRyYWRpbmcgbmljaGUuCiAgICAgICAgIiIiCiAgICAgICAgd2FpdF91bnRpbF9hY3RpdmUoKQogICAgICAgIGxvZ2dlci5pbmZvKCI9PT0gRkVFRCBJTlRFUkFDVElPTiA9PT0iKQoKICAgICAgICBzZWxmLnBhZ2UuZ290byhUSUtUT0tfQkFTRSwgd2FpdF91bnRpbD0iZG9tY29udGVudGxvYWRlZCIpCiAgICAgICAgcmFuZG9tX3NsZWVwKCpERUxBWV9NRURJVU0sIHBhZ2U9c2VsZi5wYWdlKQoKICAgICAgICBpZiBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9ImZlZWQiKToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkNoYWxsZW5nZSBvbiBmZWVkIHBhZ2Ug4oCTIGFib3J0aW5nIGZlZWQgaW50ZXJhY3Rpb24uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IHNlbGYuX2Vuc3VyZV9wYWdlX2hhc19jb250ZW50KCJmZWVkIiwgbWF4X3JldHJpZXM9MiwgcmV0cnlfc2Nyb2xsPVRydWUpOgogICAgICAgICAgICBzZWxmLl9tYXJrX3NvZnRfYmxvY2soImZlZWQiKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdmlkZW9zX3dhdGNoZWQgPSAwCiAgICAgICAgY29uc2VjdXRpdmVfcGxheV9lcnJvcnMgPSAwCiAgICAgICAgbWF4X2NvbnNlY3V0aXZlX3BsYXlfZXJyb3JzID0gMwogICAgICAgIHJvdW5kX251bSA9IDAKICAgICAgICBtYXhfcm91bmRzID0gbWF4KEZFRURfU0NST0xMX1JPVU5EUyAqIDIsIDI1KSAgIyBhbGxvdyBleHRyYSByb3VuZHMgd2hlbiBza2lwcGluZyBicm9rZW4gdmlkZW9zCgogICAgICAgIHdoaWxlIHZpZGVvc193YXRjaGVkIDwgTUFYX1ZJREVPU19UT19XQVRDSCBhbmQgcm91bmRfbnVtIDwgbWF4X3JvdW5kczoKICAgICAgICAgICAgcm91bmRfbnVtICs9IDEKICAgICAgICAgICAgd2FpdF91bnRpbF9hY3RpdmUoKQoKICAgICAgICAgICAgaWYgZ2V0X3Rocm90dGxlKCkuaXNfY3JpdGljYWw6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiVGhyb3R0bGUgY3JpdGljYWwg4oCTIHN0b3BwaW5nIGZlZWQgZWFybHkuIikKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICJGZWVkIHJvdW5kICVkICh3YXRjaGVkICVkLyVkIHZpZGVvcykiLAogICAgICAgICAgICAgICAgcm91bmRfbnVtLCB2aWRlb3Nfd2F0Y2hlZCwgTUFYX1ZJREVPU19UT19XQVRDSCwKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBJZiBjdXJyZW50IHZpZGVvIHNob3dzICJ0cm91YmxlIHBsYXlpbmciLCBzY3JvbGwgdG8gbmV4dCBhbmQgcmV0cnkgKG5vIGNvdW50KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBoYXNfcGxheV9lcnJvciA9IHNlbGYucGFnZS5ldmFsdWF0ZSgiIiIoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IChkb2N1bWVudC5ib2R5Py5pbm5lclRleHQgfHwgIiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRleHQuaW5jbHVkZXMoImhhdmluZyB0cm91YmxlIHBsYXlpbmciKSB8fCB0ZXh0LmluY2x1ZGVzKCJwbGVhc2UgcmVmcmVzaCIpOwogICAgICAgICAgICAgICAgfSIiIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGhhc19wbGF5X2Vycm9yID0gRmFsc2UKICAgICAgICAgICAgaWYgaGFzX3BsYXlfZXJyb3I6CiAgICAgICAgICAgICAgICBjb25zZWN1dGl2ZV9wbGF5X2Vycm9ycyArPSAxCiAgICAgICAgICAgICAgICBpZiBjb25zZWN1dGl2ZV9wbGF5X2Vycm9ycyA+PSBtYXhfY29uc2VjdXRpdmVfcGxheV9lcnJvcnM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAgICAgICAgICJNdWx0aXBsZSBwbGF5YmFjayBlcnJvcnMgaW4gYSByb3cg4oCTIHJlZnJlc2hpbmcgZmVlZCBvbmNlLiIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnBhZ2UucmVsb2FkKHdhaXRfdW50aWw9ImRvbWNvbnRlbnRsb2FkZWQiKQogICAgICAgICAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoNC4wLCA3LjAsIHBhZ2U9c2VsZi5wYWdlKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICBjb25zZWN1dGl2ZV9wbGF5X2Vycm9ycyA9IDAKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlZpZGVvIHBsYXliYWNrIGVycm9yIOKAkyBzY3JvbGxpbmcgdG8gbmV4dC4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgaHVtYW5fc2Nyb2xsX25leHRfdmlkZW8oc2VsZi5wYWdlKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX1NIT1JULCBwYWdlPXNlbGYucGFnZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGNvbnNlY3V0aXZlX3BsYXlfZXJyb3JzID0gMAoKICAgICAgICAgICAgIyBXYXRjaCB0aGUgY3VycmVudCB2aWRlbyB3aXRoIGlkbGUgc2ltdWxhdGlvbgogICAgICAgICAgICB3YXRjaF9kdXJhdGlvbiA9IHJhbmRvbS51bmlmb3JtKAogICAgICAgICAgICAgICAgc2VsZi5fc2Vzc2lvbl9iZWhhdmlvclsid2F0Y2hfbWluIl0sCiAgICAgICAgICAgICAgICBzZWxmLl9zZXNzaW9uX2JlaGF2aW9yWyJ3YXRjaF9tYXgiXSwKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiV2F0Y2hpbmcgdmlkZW8gZm9yICUuMWYgcyDigKYiLCB3YXRjaF9kdXJhdGlvbikKICAgICAgICAgICAgaWRsZV9zbGVlcChzZWxmLnBhZ2UsIHdhdGNoX2R1cmF0aW9uKQogICAgICAgICAgICB2aWRlb3Nfd2F0Y2hlZCArPSAxCgogICAgICAgICAgICAjIERlY2lkZSB3aGV0aGVyIHRvIGxpa2UKICAgICAgICAgICAgaWYgc2VsZi5fbGlrZXNfdGhpc19zZXNzaW9uIDwgTUFYX0xJS0VTX1BFUl9TRVNTSU9OOgogICAgICAgICAgICAgICAgaWYgc2VsZi5faXNfbmljaGVfY29udGVudCgpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3RyeV9saWtlX2N1cnJlbnRfdmlkZW8oKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIlZpZGVvIG5vdCBuaWNoZS1yZWxldmFudCDigJMgc2tpcHBpbmcgbGlrZS4iKQoKICAgICAgICAgICAgaWYgdmlkZW9zX3dhdGNoZWQgPj0gTUFYX1ZJREVPU19UT19XQVRDSDoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAjIE9jY2FzaW9uYWwgbG9uZyBwYXVzZSAoaHVtYW4gYmVoYXZpb3I6IGRpc3RyYWN0ZWQsIHJlYWRpbmcgY29tbWVudHMpCiAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IHNlbGYuX3Nlc3Npb25fYmVoYXZpb3IuZ2V0KCJsb25nX3BhdXNlX2NoYW5jZSIsIDAuMTUpOgogICAgICAgICAgICAgICAgbHBfbWluLCBscF9tYXggPSBzZWxmLl9zZXNzaW9uX2JlaGF2aW9yLmdldCgibG9uZ19wYXVzZV9yYW5nZSIsICgxNS4wLCAzMC4wKSkKICAgICAgICAgICAgICAgIGxvbmdfcGF1c2UgPSByYW5kb20udW5pZm9ybShscF9taW4sIGxwX21heCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJUYWtpbmcgYSBuYXR1cmFsIGJyZWFrICglLjBmIHMpIOKApiIsIGxvbmdfcGF1c2UpCiAgICAgICAgICAgICAgICBpZGxlX3NsZWVwKHNlbGYucGFnZSwgbG9uZ19wYXVzZSkKCiAgICAgICAgICAgICMgU2Nyb2xsIHRvIG5leHQgdmlkZW8KICAgICAgICAgICAgaHVtYW5fc2Nyb2xsX25leHRfdmlkZW8oc2VsZi5wYWdlKQogICAgICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX1NIT1JULCBwYWdlPXNlbGYucGFnZSkKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Vuc3VyZV9wYWdlX2hhc19jb250ZW50KCJmZWVkIiwgbWF4X3JldHJpZXM9MSwgcmV0cnlfc2Nyb2xsPUZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJGZWVkIGNvbnRlbnQgc3RvcHBlZCBsb2FkaW5nIG1pZC1zZXNzaW9uOyBlbmRpbmcgZmVlZCB0YXNrLiIpCiAgICAgICAgICAgICAgICBzZWxmLl9tYXJrX3NvZnRfYmxvY2soImZlZWQtbWlkLXNlc3Npb24iKQogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICJGZWVkIGludGVyYWN0aW9uIGNvbXBsZXRlLiBXYXRjaGVkICVkIHZpZGVvcywgbGlrZWQgJWQgdG90YWwgdGhpcyBzZXNzaW9uLiIsCiAgICAgICAgICAgIHZpZGVvc193YXRjaGVkLAogICAgICAgICAgICBzZWxmLl9saWtlc190aGlzX3Nlc3Npb24sCiAgICAgICAgKQoKICAgIGRlZiBfaXNfbmljaGVfY29udGVudChzZWxmKSAtPiBib29sOgogICAgICAgICIiIkNoZWNrIGlmIHRoZSBDVVJSRU5UTFkgVklTSUJMRSB2aWRlbyBpcyBuaWNoZS1yZWxldmFudC4KCiAgICAgICAgSW5zdGVhZCBvZiBjaGVja2luZyB0aGUgZW50aXJlIHBhZ2UgYm9keSB0ZXh0ICh3aGljaCBpcyBub2lzeSBvbgogICAgICAgIFRpa1RvaydzIFNQQSksIHdlIHRhcmdldCB0aGUgdmlkZW8gZGVzY3JpcHRpb24gYW5kIGF1dGhvciBlbGVtZW50cwogICAgICAgIHNwZWNpZmljYWxseS4KICAgICAgICAiIiIKICAgICAgICB0ZXh0X3BhcnRzID0gW10KCiAgICAgICAgIyAxLiBUcnkgdmlkZW8gZGVzY3JpcHRpb24gZWxlbWVudAogICAgICAgIGZvciBkZXNjX3NlbCBpbiBbU0VMRUNUT1JTWyJ2aWRlb19kZXNjIl0sICdbZGF0YS1lMmU9InZpZGVvLWRlc2MiXScsCiAgICAgICAgICAgICAgICAgICAgICAgICAnW2NsYXNzKj0iRGl2VmlkZW9JbmZvQ29udGFpbmVyIl0nXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVzYyA9IHNlbGYucGFnZS5sb2NhdG9yKGRlc2Nfc2VsKS5maXJzdAogICAgICAgICAgICAgICAgaWYgZGVzYy5pc192aXNpYmxlKHRpbWVvdXQ9MTAwMCk6CiAgICAgICAgICAgICAgICAgICAgdGV4dF9wYXJ0cy5hcHBlbmQoZGVzYy5pbm5lcl90ZXh0KHRpbWVvdXQ9MjAwMCkubG93ZXIoKSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgIyAyLiBUcnkgdG8gZ2V0IGhhc2h0YWcgbGlua3MgZnJvbSB0aGUgY3VycmVudCB2aWRlbwogICAgICAgIHRyeToKICAgICAgICAgICAgaGFzaHRhZ3MgPSBzZWxmLnBhZ2UubG9jYXRvcigKICAgICAgICAgICAgICAgICdhW2hyZWYqPSIvdGFnLyJdLCBhW2RhdGEtZTJlPSJzZWFyY2gtY29tbW9uLWxpbmsiXScKICAgICAgICAgICAgKS5hbGwoKQogICAgICAgICAgICBmb3IgdGFnIGluIGhhc2h0YWdzWzoxMF06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdGFnX3RleHQgPSB0YWcuaW5uZXJfdGV4dCh0aW1lb3V0PTUwMCkubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIGlmIHRhZ190ZXh0OgogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0X3BhcnRzLmFwcGVuZCh0YWdfdGV4dCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgICMgMy4gVHJ5IGF1dGhvciBuYW1lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhdXRob3IgPSBzZWxmLnBhZ2UubG9jYXRvcihTRUxFQ1RPUlNbInZpZGVvX2F1dGhvciJdKS5maXJzdAogICAgICAgICAgICBpZiBhdXRob3IuaXNfdmlzaWJsZSh0aW1lb3V0PTUwMCk6CiAgICAgICAgICAgICAgICB0ZXh0X3BhcnRzLmFwcGVuZChhdXRob3IuaW5uZXJfdGV4dCh0aW1lb3V0PTEwMDApLmxvd2VyKCkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIDQuIEZhbGxiYWNrOiBjaGVjayBhIGxpbWl0ZWQgc2NvcGUgb2YgdGhlIHBhZ2UKICAgICAgICBpZiBub3QgdGV4dF9wYXJ0czoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBHZXQgdGV4dCBmcm9tIHRoZSBtYWluIGNvbnRlbnQgYXJlYSBvbmx5LCBub3Qgc2lkZWJhcgogICAgICAgICAgICAgICAgbWFpbl9hcmVhID0gc2VsZi5wYWdlLmxvY2F0b3IoJ1tpZD0ibWFpbi1jb250ZW50LW90aGVyc19ob21lcGFnZSJdLCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdbY2xhc3MqPSJEaXZDb250ZW50Q29udGFpbmVyIl0sJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21haW4nKS5maXJzdAogICAgICAgICAgICAgICAgYm9keV90ZXh0ID0gbWFpbl9hcmVhLmlubmVyX3RleHQodGltZW91dD0yMDAwKS5sb3dlcigpCiAgICAgICAgICAgICAgICB0ZXh0X3BhcnRzLmFwcGVuZChib2R5X3RleHRbOjIwMDBdKSAgIyBsaW1pdCB0byBhdm9pZCBub2lzZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGJvZHlfdGV4dCA9IHNlbGYucGFnZS5pbm5lcl90ZXh0KCJib2R5IikubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIHRleHRfcGFydHMuYXBwZW5kKGJvZHlfdGV4dFs6MjAwMF0pCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBjb21iaW5lZCA9ICIgIi5qb2luKHRleHRfcGFydHMpCiAgICAgICAgaXNfbmljaGUgPSBhbnkoa3cgaW4gY29tYmluZWQgZm9yIGt3IGluIE5JQ0hFX0tFWVdPUkRTKQoKICAgICAgICBpZiBpc19uaWNoZToKICAgICAgICAgICAgbWF0Y2hpbmcgPSBba3cgZm9yIGt3IGluIE5JQ0hFX0tFWVdPUkRTIGlmIGt3IGluIGNvbWJpbmVkXQogICAgICAgICAgICBsb2dnZXIuZGVidWcoIk5pY2hlIG1hdGNoIGZvdW5kOiAlcyIsIG1hdGNoaW5nWzo1XSkKCiAgICAgICAgcmV0dXJuIGlzX25pY2hlCgogICAgZGVmIF90cnlfbGlrZV9jdXJyZW50X3ZpZGVvKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiTGlrZSB0aGUgY3VycmVudGx5LXZpc2libGUgdmlkZW8gaWYgbm90IGFscmVhZHkgbGlrZWQuCgogICAgICAgIFVzZXMgbXVsdGlwbGUgc3RyYXRlZ2llcyB0byBkZXRlY3QgaWYgdmlkZW8gaXMgYWxyZWFkeSBsaWtlZCwKICAgICAgICBhbmQgbXVsdGlwbGUgc2VsZWN0b3JzIHRvIGZpbmQgdGhlIGxpa2UgYnV0dG9uLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBGaW5kIHRoZSBsaWtlIGJ1dHRvbiAocHJpbWFyeSArIGZhbGxiYWNrIHNlbGVjdG9ycykKICAgICAgICAgICAgbGlrZV9idG4gPSBOb25lCiAgICAgICAgICAgIGZvciBzZWwgaW4gW1NFTEVDVE9SU1sibGlrZV9idXR0b24iXSwgU0VMRUNUT1JTLmdldCgibGlrZV9idXR0b25fYWx0IiwgIiIpXToKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWw6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBidG4gPSBzZWxmLnBhZ2UubG9jYXRvcihzZWwpLmZpcnN0CiAgICAgICAgICAgICAgICAgICAgaWYgYnRuLmlzX3Zpc2libGUodGltZW91dD0xNTAwKToKICAgICAgICAgICAgICAgICAgICAgICAgbGlrZV9idG4gPSBidG4KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIGxpa2VfYnRuIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkxpa2UgYnV0dG9uIG5vdCBmb3VuZC4iKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICAjIENoZWNrIGlmIGFscmVhZHkgbGlrZWQgdXNpbmcgbXVsdGlwbGUgc3RyYXRlZ2llcwogICAgICAgICAgICBhbHJlYWR5X2xpa2VkID0gRmFsc2UKCiAgICAgICAgICAgICMgU3RyYXRlZ3kgMTogQ2hlY2sgYWN0aXZlLXN0YXRlIHNlbGVjdG9ycwogICAgICAgICAgICBmb3IgY2hlY2tfc2VsIGluIFNFTEVDVE9SUy5nZXQoImxpa2VfYnV0dG9uX2FjdGl2ZV9jaGVja3MiLCBbXSk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgZWxlbWVudF9leGlzdHMoc2VsZi5wYWdlLCBjaGVja19zZWwsIHRpbWVvdXQ9NTAwKToKICAgICAgICAgICAgICAgICAgICAgICAgYWxyZWFkeV9saWtlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgU3RyYXRlZ3kgMjogQ2hlY2sgdGhlIGJ1dHRvbidzIGNvbG9yL2ZpbGwgdmlhIEpTCiAgICAgICAgICAgIGlmIG5vdCBhbHJlYWR5X2xpa2VkOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlzX3JlZCA9IHNlbGYucGFnZS5ldmFsdWF0ZSgiIiIoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWUyZT0ibGlrZS1pY29uIl0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4pIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ZnID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJ3N2ZycpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3ZnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxsID0gc3ZnLmdldEF0dHJpYnV0ZSgnZmlsbCcpIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb3IgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShzdmcpLmNvbG9yIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbGwuaW5jbHVkZXMoJzI1NCcpIHx8IGZpbGwuaW5jbHVkZXMoJ0ZFMkM1NScpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IuaW5jbHVkZXMoJzI1NCcpIHx8IGNvbG9yLmluY2x1ZGVzKCdGRTJDNTUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGJ0bik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHlsZS5jb2xvci5pbmNsdWRlcygnMjU0JykgfHwgc3R5bGUuY29sb3IuaW5jbHVkZXMoJ0ZFMkM1NScpOwogICAgICAgICAgICAgICAgICAgIH0iIiIpCiAgICAgICAgICAgICAgICAgICAgaWYgaXNfcmVkOgogICAgICAgICAgICAgICAgICAgICAgICBhbHJlYWR5X2xpa2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICBpZiBhbHJlYWR5X2xpa2VkOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJWaWRlbyBhbHJlYWR5IGxpa2VkIOKAkyBza2lwcGluZy4iKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICAjIENsaWNrIHRoZSBsaWtlIGJ1dHRvbgogICAgICAgICAgICBodW1hbl9jbGlja19lbGVtZW50KHNlbGYucGFnZSwgbGlrZV9idG4sIHRpbWVvdXQ9MzAwMCkKICAgICAgICAgICAgc2VsZi5fbGlrZXNfdGhpc19zZXNzaW9uICs9IDEKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkxpa2VkIGEgdmlkZW8gKHRvdGFsIGxpa2VzIHRoaXMgc2Vzc2lvbjogJWQpLiIsIHNlbGYuX2xpa2VzX3RoaXNfc2Vzc2lvbikKICAgICAgICAgICAgcmFuZG9tX3NsZWVwKCpERUxBWV9TSE9SVCwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgICAgIGdldF90aHJvdHRsZSgpLmRlY2F5KDAuMSkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiQ291bGQgbm90IGxpa2UgdmlkZW86ICVzIiwgZXhjKQoKICAgICMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiAgICAjIE11dHVhbHMgLyBOZXR3b3JrIEdyb3d0aAogICAgIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKICAgIGRlZiBmaW5kX211dHVhbHMoc2VsZiwgdGFyZ2V0X2hhc2h0YWc6IHN0ciB8IE5vbmUgPSBOb25lKSAtPiBOb25lOgogICAgICAgICIiIlRoZSAnTXV0dWFscycgZ3Jvd3RoIGVuZ2luZS4KCiAgICAgICAgU3RyYXRlZ3kgKENBUFRDSEEtc2FmZSk6CiAgICAgICAgMS4gRklSU1Q6IGNvbGxlY3QgcHJvZmlsZSBsaW5rcyBmcm9tIHRoZSBGb3ItWW91IGZlZWQgKG5vIENBUFRDSEEgcmlzaykuCiAgICAgICAgMi4gT05MWSBJRiBmZWVkIHlpZWxkcyBmZXcgbGlua3M6IHRyeSB0aGUgdGFyZ2V0IGhhc2h0YWcgcGFnZS4KICAgICAgICAzLiBJZiBoYXNodGFnIHBhZ2UgdHJpZ2dlcnMgQ0FQVENIQSwgc3RvcCDigJQgZG9uJ3QgdHJ5IGZhbGxiYWNrcy4KICAgICAgICA0LiBWaXNpdCBlYWNoIHByb2ZpbGUsIGNoZWNrIG11dHVhbCArIG5pY2hlLCBmb2xsb3cgaWYgYm90aCBtYXRjaC4KICAgICAgICAiIiIKICAgICAgICB3YWl0X3VudGlsX2FjdGl2ZSgpCiAgICAgICAgdGFnID0gdGFyZ2V0X2hhc2h0YWcgb3IgVEFSR0VUX0hBU0hUQUcKICAgICAgICBsb2dnZXIuaW5mbygiPT09IE1VVFVBTFMgR1JPV1RIIChwcmltYXJ5OiAjJXMpID09PSIsIHRhZykKCiAgICAgICAgcHJvZmlsZV9saW5rczogbGlzdFtzdHJdID0gW10KICAgICAgICBjYXB0Y2hhX2hpdCA9IEZhbHNlCgogICAgICAgICMg4pSA4pSAIFN0cmF0ZWd5IDE6IFNlYXJjaCB2aWEgVGFyZ2V0IEhhc2h0YWcgKFByaW1hcnkpIOKUgOKUgAogICAgICAgICMgVGhpcyBlbnN1cmVzIHdlIHRhcmdldCB0aGUgc3BlY2lmaWMgbmljaGUgKCJ0cmFkaW5nIikgcmF0aGVyIHRoYW4gcmFuZG9tIGZlZWQuCiAgICAgICAgaWYgc2VsZi5fY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiU2tpcHBpbmcgaGFzaHRhZyBzZWFyY2ggZHVlIHRvIHByaW9yIENBUFRDSEEuIikKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEdvIHRvIGhvbWUgZmlyc3QgYW5kIHBhdXNlIHNvIGhhc2h0YWcgdmlzaXQgbG9va3MgbGlrZSAiYnJvd3NlZCB0aGVuIHNlYXJjaGVkIiAocmVkdWNlcyBDQVBUQ0hBKS4KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5wYWdlLmdvdG8oVElLVE9LX0JBU0UsIHdhaXRfdW50aWw9ImRvbWNvbnRlbnRsb2FkZWQiKQogICAgICAgICAgICAgICAgdHJhbnNpdGlvbl9wYXVzZSA9IHJhbmRvbS51bmlmb3JtKEhBU0hUQUdfVFJBTlNJVElPTl9QQVVTRV9NSU4sIEhBU0hUQUdfVFJBTlNJVElPTl9QQVVTRV9NQVgpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiUGF1c2luZyAlLjBmIHMgYmVmb3JlIG9wZW5pbmcgIyVzIChuYXR1cmFsIHRyYW5zaXRpb24pLiIsIHRyYW5zaXRpb25fcGF1c2UsIFRBUkdFVF9IQVNIVEFHKQogICAgICAgICAgICAgICAgcmFuZG9tX3NsZWVwKHRyYW5zaXRpb25fcGF1c2UsIHRyYW5zaXRpb25fcGF1c2UgKyA1LjAsIHBhZ2U9c2VsZi5wYWdlKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBsb2dnZXIuaW5mbygiU2VhcmNoaW5nIGZvciBuaWNoZSBwcm9maWxlcyB2aWEgIyVzIOKApiIsIFRBUkdFVF9IQVNIVEFHKQogICAgICAgICAgICB0YWdfbGlua3MgPSBzZWxmLl9sb2FkX2hhc2h0YWdfcHJvZmlsZXMoVEFSR0VUX0hBU0hUQUcpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiB0YWdfbGlua3MgaXMgTm9uZToKICAgICAgICAgICAgICAgICBzZWxmLl9jYXB0Y2hhX2hpdF90aGlzX3Nlc3Npb24gPSBUcnVlCiAgICAgICAgICAgIGVsaWYgdGFnX2xpbmtzOgogICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGb3VuZCAlZCBwcm9maWxlcyBmcm9tICMlcy4iLCBsZW4odGFnX2xpbmtzKSwgVEFSR0VUX0hBU0hUQUcpCiAgICAgICAgICAgICAgICAgcHJvZmlsZV9saW5rcy5leHRlbmQodGFnX2xpbmtzKQoKICAgICAgICAjIOKUgOKUgCBTdHJhdGVneSAyOiBGYWxsYmFjayB0byBGZWVkIChTZWNvbmRhcnkpIOKUgOKUgAogICAgICAgICMgT25seSBpZiB3ZSBuZWVkIG1vcmUgcHJvZmlsZXMgb3IgaGFzaHRhZyBzZWFyY2ggZmFpbGVkL3lpZWxkZWQgZmV3IHJlc3VsdHMKICAgICAgICBpZiBsZW4ocHJvZmlsZV9saW5rcykgPCA1IGFuZCBub3Qgc2VsZi5fY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbygiQ29sbGVjdGluZyBhZGRpdGlvbmFsIHByb2ZpbGVzIGZyb20gRm9yLVlvdSBmZWVkIOKApiIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYucGFnZS5nb3RvKFRJS1RPS19CQVNFLCB3YWl0X3VudGlsPSJkb21jb250ZW50bG9hZGVkIikKICAgICAgICAgICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfTUVESVVNLCBwYWdlPXNlbGYucGFnZSkKICAgICAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9ImZlZWQiKToKICAgICAgICAgICAgICAgICAgICBzY3JvbGxfcGFnZShzZWxmLnBhZ2UsIHRpbWVzPXJhbmRvbS5yYW5kaW50KDMsIDUpKQogICAgICAgICAgICAgICAgICAgIGZlZWRfbGlua3MgPSBzZWxmLl9leHRyYWN0X3Byb2ZpbGVfbGlua3MoKQogICAgICAgICAgICAgICAgICAgIHByb2ZpbGVfbGlua3MuZXh0ZW5kKGZlZWRfbGlua3MpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNvbGxlY3RlZCAlZCBhZGRpdGlvbmFsIHByb2ZpbGUgbGlua3MgZnJvbSBmZWVkLiIsIGxlbihmZWVkX2xpbmtzKSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uID0gVHJ1ZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiRmVlZCBwcm9maWxlIGV4dHJhY3Rpb24gZXJyb3IgZHVyaW5nIGZhbGxiYWNrOiAlcyIsIGUpCgoKICAgICAgICAjIOKUgOKUgCBTdHJhdGVneSAyYjogRmFsbGJhY2sgaGFzaHRhZ3MgKE9OTFkgaWYgbm8gQ0FQVENIQSBzbyBmYXIpIOKUgOKUgAogICAgICAgIGlmICgKICAgICAgICAgICAgbGVuKHByb2ZpbGVfbGlua3MpIDwgMwogICAgICAgICAgICBhbmQgbm90IGNhcHRjaGFfaGl0CiAgICAgICAgICAgIGFuZCBub3Qgc2VsZi5fY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uCiAgICAgICAgICAgIGFuZCBub3QgdGFyZ2V0X2hhc2h0YWcKICAgICAgICApOgogICAgICAgICAgICBmb3IgZmFsbGJhY2tfdGFnIGluIEZBTExCQUNLX0hBU0hUQUdTWzoyXTogICMgbWF4IDIgZmFsbGJhY2tzCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9mb2xsb3dzX3RoaXNfc2Vzc2lvbiA+PSBNQVhfRk9MTE9XU19QRVJfU0VTU0lPTjoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlRyeWluZyBmYWxsYmFjayBoYXNodGFnICMlcyDigKYiLCBmYWxsYmFja190YWcpCiAgICAgICAgICAgICAgICBleHRyYSA9IHNlbGYuX2xvYWRfaGFzaHRhZ19wcm9maWxlcyhmYWxsYmFja190YWcpCiAgICAgICAgICAgICAgICBpZiBleHRyYSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIGNhcHRjaGFfaGl0ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhcHRjaGFfaGl0X3RoaXNfc2Vzc2lvbiA9IFRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgcHJvZmlsZV9saW5rcy5leHRlbmQoZXh0cmEpCiAgICAgICAgICAgICAgICBpZiBsZW4ocHJvZmlsZV9saW5rcykgPj0gMTA6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgaWYgbm90IHByb2ZpbGVfbGlua3M6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBwcm9maWxlIGxpbmtzIGZvdW5kLiBTa2lwcGluZyBtdXR1YWxzIHRoaXMgc2Vzc2lvbi4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyBEZWR1cGxpY2F0ZQogICAgICAgIHNlZW4gPSBzZXQoKQogICAgICAgIHVuaXF1ZV9saW5rcyA9IFtdCiAgICAgICAgZm9yIGxpbmsgaW4gcHJvZmlsZV9saW5rczoKICAgICAgICAgICAgbm9ybWFsaXNlZCA9IHNlbGYuX25vcm1hbGlzZV9wcm9maWxlX3VybChsaW5rKQogICAgICAgICAgICBpZiBub3JtYWxpc2VkIGFuZCBub3JtYWxpc2VkIG5vdCBpbiBzZWVuOgogICAgICAgICAgICAgICAgc2Vlbi5hZGQobm9ybWFsaXNlZCkKICAgICAgICAgICAgICAgIHVuaXF1ZV9saW5rcy5hcHBlbmQobm9ybWFsaXNlZCkKCiAgICAgICAgcmFuZG9tLnNodWZmbGUodW5pcXVlX2xpbmtzKQogICAgICAgIG1heF90b19ldmFsdWF0ZSA9IG1pbihsZW4odW5pcXVlX2xpbmtzKSwgMykKICAgICAgICBsb2dnZXIuaW5mbygiRXZhbHVhdGluZyAlZCBvZiAlZCB1bmlxdWUgcHJvZmlsZXMgKGxpbWl0ZWQgdG8gcHJldmVudCBDQVBUQ0hBKS4iLCBtYXhfdG9fZXZhbHVhdGUsIGxlbih1bmlxdWVfbGlua3MpKQoKICAgICAgICAjIFBhdXNlIG5hdHVyYWxseSBiZWZvcmUgZmlyc3QgcHJvZmlsZSB2aXNpdC4KICAgICAgICBwcmVfcHJvZmlsZV9wYXVzZSA9IHJhbmRvbS51bmlmb3JtKDIwLjAsIDQwLjApCiAgICAgICAgbG9nZ2VyLmluZm8oIlBhdXNpbmcgJS4wZiBzIGJlZm9yZSBmaXJzdCBwcm9maWxlIHZpc2l0IChuYXR1cmFsIGJyb3dzaW5nKS4iLCBwcmVfcHJvZmlsZV9wYXVzZSkKICAgICAgICByYW5kb21fc2xlZXAocHJlX3Byb2ZpbGVfcGF1c2UsIHByZV9wcm9maWxlX3BhdXNlICsgNS4wLCBwYWdlPXNlbGYucGFnZSkKCiAgICAgICAgZm9yIGksIGxpbmsgaW4gZW51bWVyYXRlKHVuaXF1ZV9saW5rc1s6bWF4X3RvX2V2YWx1YXRlXSk6CiAgICAgICAgICAgIHdhaXRfdW50aWxfYWN0aXZlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMg4pSA4pSAIERJQUdOT1NUSUM6IExvZyBwcm9maWxlIHZpc2l0IGNvdW50IOKUgOKUgAogICAgICAgICAgICBsb2dnZXIud2FybmluZygKICAgICAgICAgICAgICAgICJbRElBR05PU1RJQ10gUHJvZmlsZSB2aXNpdCAjJWQgaW4gdGhpcyBjeWNsZSAobWF4PSVkKS4gIgogICAgICAgICAgICAgICAgIlNlc3Npb24gdG90YWxzOiBmb2xsb3dzPSVkLCBsaWtlcz0lZCIsCiAgICAgICAgICAgICAgICBpICsgMSwgbWF4X3RvX2V2YWx1YXRlLCBzZWxmLl9mb2xsb3dzX3RoaXNfc2Vzc2lvbiwgc2VsZi5fbGlrZXNfdGhpc19zZXNzaW9uCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlmIHNlbGYuX2ZvbGxvd3NfdGhpc19zZXNzaW9uID49IE1BWF9GT0xMT1dTX1BFUl9TRVNTSU9OOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICAgICAgIkZvbGxvdyBsaW1pdCByZWFjaGVkICglZCkuIFN0b3BwaW5nIGdyb3d0aCBjeWNsZS4iLAogICAgICAgICAgICAgICAgICAgIE1BWF9GT0xMT1dTX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGlmIGdldF90aHJvdHRsZSgpLmlzX2NyaXRpY2FsOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlRocm90dGxlIGNyaXRpY2FsIOKAkyBzdG9wcGluZyBtdXR1YWxzIGVhcmx5LiIpCiAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgaWYgc2VsZi5fY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNBUFRDSEEgaGl0IOKAkyBzdG9wcGluZyBwcm9maWxlIHZpc2l0cyBmb3IgdGhpcyBzZXNzaW9uLiIpCiAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgIyBOYXZpZ2F0ZSBkaXJlY3RseSB0byBwcm9maWxlIChkb24ndCBsb29wIGJhY2sgdG8gaGFzaHRhZyDigJQKICAgICAgICAgICAgIyByZXBlYXRlZCBoYXNodGFn4oaScHJvZmlsZeKGkmhhc2h0YWcgbmF2aWdhdGlvbiBpcyBhIGJvdCBwYXR0ZXJuKS4KICAgICAgICAgICAgc2VsZi5fZXZhbHVhdGVfYW5kX2ZvbGxvdyhsaW5rKQoKICAgICAgICAgICAgIyBDb29sZG93biBiZXR3ZWVuIHZpc2l0cyDigJQgc3RheSBvbiBob21lIGZlZWQgbGlrZSBhIHJlYWwgdXNlcgogICAgICAgICAgICBpZiBpIDwgbWF4X3RvX2V2YWx1YXRlIC0gMToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnBhZ2UuZ290byhUSUtUT0tfQkFTRSwgd2FpdF91bnRpbD0iZG9tY29udGVudGxvYWRlZCIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHBhdXNlX21pbiwgcGF1c2VfbWF4ID0gc2VsZi5fc2Vzc2lvbl9iZWhhdmlvclsicHJvZmlsZV9ldmFsX3BhdXNlIl0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDb29saW5nIGRvd24gJS4wZi0lLjBmIHMgYmVmb3JlIG5leHQgcHJvZmlsZSB2aXNpdCDigKYiLCBwYXVzZV9taW4sIHBhdXNlX21heCkKICAgICAgICAgICAgICAgIHJhbmRvbV9zbGVlcChwYXVzZV9taW4sIHBhdXNlX21heCwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgICAgICAgICAjIENoZWNrIGZvciBDQVBUQ0hBIGJlZm9yZSBuZXh0IHZpc2l0CiAgICAgICAgICAgICAgICBpZiBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9InByb2ZpbGUiKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jYXB0Y2hhX2hpdF90aGlzX3Nlc3Npb24gPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNBUFRDSEEgZGV0ZWN0ZWQgZHVyaW5nIGNvb2xkb3duIOKAlCBzdG9wcGluZyBwcm9maWxlIHZpc2l0cy4iKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAiTXV0dWFscyBjeWNsZSBjb21wbGV0ZS4gRm9sbG93cyB0aGlzIHNlc3Npb246ICVkIiwKICAgICAgICAgICAgc2VsZi5fZm9sbG93c190aGlzX3Nlc3Npb24sCiAgICAgICAgKQoKICAgIGRlZiBfbG9hZF9oYXNodGFnX3Byb2ZpbGVzKHNlbGYsIHRhZzogc3RyKSAtPiBsaXN0W3N0cl0gfCBOb25lOgogICAgICAgICIiIkZpbmQgbmljaGUgcHJvZmlsZXMgYnkgc2VhcmNoaW5nIGZvciB0aGUgdGFnIGtleXdvcmQuCgogICAgICAgIFBSSU1BUlk6IFVzZSBUaWtUb2sgc2VhcmNoIChsZXNzIENBUFRDSEEtcHJvbmUgdGhhbiBkaXJlY3QgdGFnIFVSTHMpLgogICAgICAgIEZBTExCQUNLOiBUcnkgZGlyZWN0IHRhZyBVUkwgaWYgc2VhcmNoIHlpZWxkcyBub3RoaW5nLgoKICAgICAgICBSZXR1cm5zIGEgbGlzdCBvZiBsaW5rcywgb3IgTm9uZSBpZiBhIENBUFRDSEEgd2FzIHRyaWdnZXJlZAogICAgICAgIChpbmRpY2F0aW5nIHRoZSBjYWxsZXIgc2hvdWxkIHN0b3AgYWxsIGhhc2h0YWcgYXR0ZW1wdHMpLgogICAgICAgICIiIgogICAgICAgICMg4pSA4pSAIFN0cmF0ZWd5IEE6IFVzZSBUaWtUb2sgc2VhcmNoIChzYWZlciB0aGFuIHRhZyBwYWdlcykg4pSA4pSACiAgICAgICAgc2VhcmNoX3VybCA9IGYie1RJS1RPS19CQVNFfS9zZWFyY2gvdXNlcj9xPXt0YWd9IgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlNlYXJjaGluZyBmb3IgJyVzJyB1c2VycyB2aWEgVGlrVG9rIHNlYXJjaCDigKYiLCB0YWcpCiAgICAgICAgICAgIHNlbGYucGFnZS5nb3RvKHNlYXJjaF91cmwsIHdhaXRfdW50aWw9ImRvbWNvbnRlbnRsb2FkZWQiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlNlYXJjaCBwYWdlIGxvYWQgaXNzdWUgZm9yICclcyc6ICVzIiwgdGFnLCBlKQogICAgICAgICAgICAjIEZhbGwgdGhyb3VnaCB0byB0YWcgVVJMIGZhbGxiYWNrCiAgICAgICAgICAgIHNlYXJjaF91cmwgPSBOb25lCgogICAgICAgIGlmIHNlYXJjaF91cmw6CiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMy4wLCA2LjApKQogICAgICAgICAgICBodW1hbl9tb3VzZV93YXJtdXAoc2VsZi5wYWdlKQogICAgICAgICAgICBodW1hbl9oYXNodGFnX3dhcm11cChzZWxmLnBhZ2UpCgogICAgICAgICAgICBpZiBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9InNlYXJjaCIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkNoYWxsZW5nZSBvbiBzZWFyY2ggcGFnZSBmb3IgJyVzJy4iLCB0YWcpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgIyBFeHRyYWN0IHByb2ZpbGVzIGZyb20gc2VhcmNoIHJlc3VsdHMKICAgICAgICAgICAgbGlua3MgPSBzZWxmLl9leHRyYWN0X3Byb2ZpbGVfbGlua3MoKQogICAgICAgICAgICBpZiBsaW5rczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGb3VuZCAlZCBwcm9maWxlcyBmcm9tIHNlYXJjaCBmb3IgJyVzJy4iLCBsZW4obGlua3MpLCB0YWcpCiAgICAgICAgICAgICAgICByZXR1cm4gbGlua3MKCiAgICAgICAgIyDilIDilIAgU3RyYXRlZ3kgQjogRmFsbGJhY2sgdG8gZGlyZWN0IHRhZyBVUkwg4pSA4pSACiAgICAgICAgdGFnX3VybCA9IGYie1RJS1RPS19CQVNFfS90YWcve3RhZ30iCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiRmFsbGluZyBiYWNrIHRvIHRhZyBwYWdlICMlcyDigKYiLCB0YWcpCiAgICAgICAgICAgIHNlbGYucGFnZS5nb3RvKHRhZ191cmwsIHdhaXRfdW50aWw9ImRvbWNvbnRlbnRsb2FkZWQiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkhhc2h0YWcgcGFnZSBsb2FkIGlzc3VlIGZvciAjJXM6ICVzIiwgdGFnLCBlKQogICAgICAgICAgICByZXR1cm4gW10KCiAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgzLjAsIDYuMCkpCiAgICAgICAgaHVtYW5faGFzaHRhZ193YXJtdXAoc2VsZi5wYWdlKQogICAgICAgIGh1bWFuX21vdXNlX3dhcm11cChzZWxmLnBhZ2UpCgogICAgICAgIGlmIGhhbmRsZV9jaGFsbGVuZ2Uoc2VsZi5wYWdlLCBwaGFzZT0iaGFzaHRhZyIpOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiQ2hhbGxlbmdlIG9uIHRhZyBwYWdlICMlcy4iLCB0YWcpCiAgICAgICAgICAgIHJldHVybiBOb25lICAjIFNpZ25hbCBDQVBUQ0hBIHRvIGNhbGxlcgogICAgICAgIAogICAgICAgICMg4pSA4pSAIERJQUdOT1NUSUM6IExvZyBoYXNodGFnIHBhZ2UgY29udGVudCBzdGF0ZSDilIDilIAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRpYWdfaW5mbyA9IHNlbGYucGFnZS5ldmFsdWF0ZSgiIiIoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBza2VsZXRvbnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSJza2VsZXRvbiJdLCBbY2xhc3MqPSJTa2VsZXRvbiJdJykubGVuZ3RoOwogICAgICAgICAgICAgICAgY29uc3QgdmlkZW9zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtZTJlPSJyZWNvbW1lbmQtbGlzdC1pdGVtLWNvbnRhaW5lciJdJykubGVuZ3RoOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZmlsZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdhW2hyZWYqPSIvQCJdJykubGVuZ3RoOwogICAgICAgICAgICAgICAgY29uc3QgYm9keVRleHQgPSBkb2N1bWVudC5ib2R5Py5pbm5lclRleHQgfHwgIiI7CiAgICAgICAgICAgICAgICBjb25zdCBoYXNDb250ZW50ID0gYm9keVRleHQubGVuZ3RoID4gMjAwOwogICAgICAgICAgICAgICAgcmV0dXJuIHsgc2tlbGV0b25zLCB2aWRlb3MsIHByb2ZpbGVzLCBoYXNDb250ZW50LCBib2R5TGVuOiBib2R5VGV4dC5sZW5ndGggfTsKICAgICAgICAgICAgfSIiIikKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoCiAgICAgICAgICAgICAgICAiW0RJQUdOT1NUSUNdIEhhc2h0YWcgIyVzIHBhZ2Ugc3RhdGU6IHNrZWxldG9ucz0lZCwgdmlkZW9zPSVkLCBwcm9maWxlcz0lZCwgYm9keUxlbj0lZCwgaGFzQ29udGVudD0lcyIsCiAgICAgICAgICAgICAgICB0YWcsIGRpYWdfaW5mby5nZXQoInNrZWxldG9ucyIsIDApLCBkaWFnX2luZm8uZ2V0KCJ2aWRlb3MiLCAwKSwKICAgICAgICAgICAgICAgIGRpYWdfaW5mby5nZXQoInByb2ZpbGVzIiwgMCksIGRpYWdfaW5mby5nZXQoImJvZHlMZW4iLCAwKSwgZGlhZ19pbmZvLmdldCgiaGFzQ29udGVudCIsIEZhbHNlKQogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBkaWFnX2VycjoKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJbRElBR05PU1RJQ10gRmFpbGVkIHRvIGdldCBoYXNodGFnIHBhZ2Ugc3RhdGU6ICVzIiwgZGlhZ19lcnIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHNlbGYuX2Vuc3VyZV9wYWdlX2hhc19jb250ZW50KCJoYXNodGFnIiwgbWF4X3JldHJpZXM9MiwgcmV0cnlfc2Nyb2xsPVRydWUpOgogICAgICAgICAgICBzZWxmLl9tYXJrX3NvZnRfYmxvY2soZiJoYXNodGFnOnt0YWd9IikKICAgICAgICAgICAgcmV0dXJuIFtdCgogICAgICAgICMgU2Nyb2xsIHRvIGxvYWQgbW9yZSBjb250ZW50IChsaW1pdGVkIHNjcm9sbGluZyB0byBhdm9pZCBkZXRlY3Rpb24pCiAgICAgICAgc2Nyb2xsX3BhZ2Uoc2VsZi5wYWdlLCB0aW1lcz1yYW5kb20ucmFuZGludCgyLCAzKSkKICAgICAgICBpZiBub3Qgc2VsZi5fZW5zdXJlX3BhZ2VfaGFzX2NvbnRlbnQoImhhc2h0YWciLCBtYXhfcmV0cmllcz0xLCByZXRyeV9zY3JvbGw9VHJ1ZSk6CiAgICAgICAgICAgIHNlbGYuX21hcmtfc29mdF9ibG9jayhmImhhc2h0YWctcG9zdC1zY3JvbGw6e3RhZ30iKQogICAgICAgICAgICByZXR1cm4gW10KCiAgICAgICAgcmV0dXJuIHNlbGYuX2V4dHJhY3RfcHJvZmlsZV9saW5rcygpCgogICAgZGVmIF9leHRyYWN0X3Byb2ZpbGVfbGlua3Moc2VsZikgLT4gbGlzdFtzdHJdOgogICAgICAgICIiIlNjcmFwZSB1bmlxdWUgUFJPRklMRSBVUkxzIGZyb20gdGhlIGN1cnJlbnQgcGFnZS4KCiAgICAgICAgS0VZIEZJWDogZmlsdGVycyBPVVQgdmlkZW8gbGlua3MgKC9AdXNlci92aWRlby8xMjMpIGFuZCBvbmx5CiAgICAgICAga2VlcHMgYWN0dWFsIHByb2ZpbGUgVVJMcyAoL0B1c2VybmFtZSBvciAvQHVzZXJuYW1lP2xhbmc9eHgpLgogICAgICAgIEFsc28gZXh0cmFjdHMgYXV0aG9yIGxpbmtzIGZyb20gdmlkZW8gY2FyZHMuCiAgICAgICAgIiIiCiAgICAgICAgbGlua3M6IHNldFtzdHJdID0gc2V0KCkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhbmNob3JzID0gc2VsZi5wYWdlLmxvY2F0b3IoImFbaHJlZio9Jy9AJ10iKS5hbGwoKQogICAgICAgICAgICBmb3IgYW5jaG9yIGluIGFuY2hvcnM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaHJlZiA9IGFuY2hvci5nZXRfYXR0cmlidXRlKCJocmVmIikKICAgICAgICAgICAgICAgICAgICBpZiBub3QgaHJlZiBvciAiL0AiIG5vdCBpbiBocmVmOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICAgICBmdWxsX3VybCA9IGhyZWYgaWYgaHJlZi5zdGFydHN3aXRoKCJodHRwIikgZWxzZSBmIntUSUtUT0tfQkFTRX17aHJlZn0iCgogICAgICAgICAgICAgICAgICAgICMgQ1JJVElDQUw6IE9ubHkga2VlcCBwcm9maWxlIFVSTHMsIG5vdCB2aWRlbyBVUkxzCiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXNlZCA9IHNlbGYuX25vcm1hbGlzZV9wcm9maWxlX3VybChmdWxsX3VybCkKICAgICAgICAgICAgICAgICAgICBpZiBub3JtYWxpc2VkOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rcy5hZGQobm9ybWFsaXNlZCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJFcnJvciBleHRyYWN0aW5nIHByb2ZpbGUgbGlua3M6ICVzIiwgZXhjKQoKICAgICAgICBsb2dnZXIuZGVidWcoIkV4dHJhY3RlZCAlZCBwcm9maWxlIGxpbmtzIGZyb20gcGFnZS4iLCBsZW4obGlua3MpKQogICAgICAgIHJldHVybiBsaXN0KGxpbmtzKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfbm9ybWFsaXNlX3Byb2ZpbGVfdXJsKHVybDogc3RyKSAtPiBzdHIgfCBOb25lOgogICAgICAgICIiIkNvbnZlcnQgYW55IFRpa1RvayBVUkwgdG8gYSBjbGVhbiBwcm9maWxlIFVSTCwgb3IgTm9uZSBpZgogICAgICAgIHRoZSBVUkwgaXMgbm90IGEgcHJvZmlsZSBsaW5rLgoKICAgICAgICBFeGFtcGxlczoKICAgICAgICAgICAgL0B1c2VyL3ZpZGVvLzEyMyAg4oaSIE5vbmUgICh2aWRlbyBsaW5rLCBza2lwKQogICAgICAgICAgICAvQHVzZXI/bGFuZz1lbiAgICDihpIgaHR0cHM6Ly93d3cudGlrdG9rLmNvbS9AdXNlcgogICAgICAgICAgICAvQHVzZXIgICAgICAgICAgICDihpIgaHR0cHM6Ly93d3cudGlrdG9rLmNvbS9AdXNlcgogICAgICAgICAgICAvQCAgICAgICAgICAgICAgICDihpIgTm9uZSAgKGVtcHR5IHVzZXJuYW1lKQogICAgICAgICIiIgogICAgICAgIGlmIG5vdCB1cmwgb3IgIi9AIiBub3QgaW4gdXJsOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAjIFJlamVjdCB2aWRlby9waG90by9saXZlIGxpbmtzCiAgICAgICAgaWYgYW55KHNlZyBpbiB1cmwgZm9yIHNlZyBpbiAoIi92aWRlby8iLCAiL3Bob3RvLyIsICIvbGl2ZS8iLCAiL3BsYXlsaXN0LyIpKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgIyBFeHRyYWN0IHVzZXJuYW1lIGZyb20gVVJMCiAgICAgICAgbWF0Y2ggPSByZS5zZWFyY2gociIvQChbXHcuXSspIiwgdXJsKQogICAgICAgIGlmIG5vdCBtYXRjaDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgdXNlcm5hbWUgPSBtYXRjaC5ncm91cCgxKQogICAgICAgIGlmIG5vdCB1c2VybmFtZSBvciBsZW4odXNlcm5hbWUpIDwgMjoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgcmV0dXJuIGYiaHR0cHM6Ly93d3cudGlrdG9rLmNvbS9Ae3VzZXJuYW1lfSIKCiAgICBkZWYgX2V2YWx1YXRlX2FuZF9mb2xsb3coc2VsZiwgcHJvZmlsZV91cmw6IHN0cikgLT4gTm9uZToKICAgICAgICAiIiJWaXNpdCBhIHByb2ZpbGUsIGNoZWNrIGZvciBNVVRVQUwgY29ubmVjdGlvbiBzaWduYWxzIEFORAogICAgICAgIG5pY2hlIHJlbGV2YW5jZSwgdGhlbiBmb2xsb3cgaWYgY29uZGl0aW9ucyBhcmUgbWV0LgoKICAgICAgICBNdXR1YWwgZGV0ZWN0aW9uIHN0cmF0ZWd5OgogICAgICAgIDEuIENoZWNrIGZvciBDU1MgZWxlbWVudHMgdGhhdCBpbmRpY2F0ZSBtdXR1YWwgY29ubmVjdGlvbnMKICAgICAgICAyLiBDaGVjayBwcm9maWxlIHBhZ2UgdGV4dCBmb3IgbXV0dWFsIGluZGljYXRvciBwaHJhc2VzCiAgICAgICAgMy4gQ2hlY2sgaWYgdGhlIHByb2ZpbGUgaXMgbmljaGUtcmVsZXZhbnQgKGJpbywgdXNlcm5hbWUsIHZpZGVvcykKCiAgICAgICAgQW50aS1DQVBUQ0hBOiBSdW4gaHVtYW4gd2FybXVwIChtb3VzZSwgc2Nyb2xsKSBCRUZPUkUgY2hhbGxlbmdlIGNoZWNrCiAgICAgICAgc28gdGhlIHBhZ2Ugc2VlcyBpbnRlcmFjdGlvbiBmaXJzdDsgcmVkdWNlcyBzbGlkZXIgdHJpZ2dlciByYXRlLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkV2YWx1YXRpbmc6ICVzIiwgcHJvZmlsZV91cmwpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIOKUgOKUgCBESUFHTk9TVElDOiBMb2cgc2Vzc2lvbiBzdGF0ZSBiZWZvcmUgcHJvZmlsZSB2aXNpdCDilIDilIAKICAgICAgICAgICAgdGhyb3R0bGUgPSBnZXRfdGhyb3R0bGUoKQogICAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICJbRElBR05PU1RJQ10gUHJlLXZpc2l0IHN0YXRlOiBzdXNwaWNpb249JS4xZiwgY2FwdGNoYV9jb3VudD0lZCwgIgogICAgICAgICAgICAgICAgImZvbGxvd3NfdGhpc19zZXNzaW9uPSVkLCBsaWtlc190aGlzX3Nlc3Npb249JWQiLAogICAgICAgICAgICAgICAgdGhyb3R0bGUuc3VzcGljaW9uX3Njb3JlLCB0aHJvdHRsZS5jYXB0Y2hhX2NvdW50LAogICAgICAgICAgICAgICAgc2VsZi5fZm9sbG93c190aGlzX3Nlc3Npb24sIHNlbGYuX2xpa2VzX3RoaXNfc2Vzc2lvbgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnBhZ2UuZ290byhwcm9maWxlX3VybCwgd2FpdF91bnRpbD0iZG9tY29udGVudGxvYWRlZCIpCiAgICAgICAgICAgIHRpbWUuc2xlZXAocmFuZG9tLnVuaWZvcm0oMi4wLCA0LjApKQoKICAgICAgICAgICAgaHVtYW5fbW91c2Vfd2FybXVwKHNlbGYucGFnZSkKICAgICAgICAgICAgIyBXYXJtIHVwIEZJUlNUOiBtaW1pYyByZWFsIHJlYWRpbmcgKG1vdXNlLCBzY3JvbGwpIGJlZm9yZSBhbnkgY2hlY2tzLgogICAgICAgICAgICBodW1hbl9wcm9maWxlX3dhcm11cChzZWxmLnBhZ2UpCgogICAgICAgICAgICBpZiBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9InByb2ZpbGUiKToKICAgICAgICAgICAgICAgIHNlbGYuX2NhcHRjaGFfaGl0X3RoaXNfc2Vzc2lvbiA9IFRydWUKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fZW5zdXJlX3BhZ2VfaGFzX2NvbnRlbnQoInByb2ZpbGUiLCBtYXhfcmV0cmllcz0yLCByZXRyeV9zY3JvbGw9RmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlByb2ZpbGUgYXBwZWFycyByZXN0cmljdGVkL2VtcHR5OyBza2lwcGluZzogJXMiLCBwcm9maWxlX3VybCkKICAgICAgICAgICAgICAgIHNlbGYuX21hcmtfc29mdF9ibG9jaygicHJvZmlsZSIpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICMg4pSA4pSAIENoZWNrIG5pY2hlIHJlbGV2YW5jZSDilIDilIAKICAgICAgICAgICAgaXNfbmljaGUgPSBzZWxmLl9jaGVja19wcm9maWxlX25pY2hlX3JlbGV2YW5jZSgpCiAgICAgICAgICAgIGlmIG5vdCBpc19uaWNoZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiUHJvZmlsZSBub3QgbmljaGUtcmVsZXZhbnQg4oCTIHNraXBwaW5nLiIpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICMg4pSA4pSAIENoZWNrIGZvciBtdXR1YWwgY29ubmVjdGlvbnMg4pSA4pSACiAgICAgICAgICAgIGhhc19tdXR1YWwgPSBzZWxmLl9jaGVja19tdXR1YWxfaW5kaWNhdG9ycygpCgogICAgICAgICAgICBpZiBoYXNfbXV0dWFsOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk11dHVhbCBjb25uZWN0aW9uIGZvdW5kICsgbmljaGUgcmVsZXZhbnQg4oaSIGZvbGxvd2luZy4iKQogICAgICAgICAgICAgICAgc2VsZi5fY2xpY2tfZm9sbG93KHByb2ZpbGVfdXJsKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJObyBtdXR1YWwgaW5kaWNhdG9yIGZvdW5kIGZvciAlcy4iLCBwcm9maWxlX3VybCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJFcnJvciBldmFsdWF0aW5nIHByb2ZpbGUgJXM6ICVzIiwgcHJvZmlsZV91cmwsIGV4YykKCiAgICBkZWYgX2NoZWNrX3Byb2ZpbGVfbmljaGVfcmVsZXZhbmNlKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiQ2hlY2sgaWYgdGhlIGN1cnJlbnQgcHJvZmlsZSBwYWdlIGlzIG5pY2hlLXJlbGV2YW50IGJ5IGV4YW1pbmluZwogICAgICAgIG11bHRpcGxlIHNpZ25hbHM6IGJpbywgdXNlcm5hbWUsIHJlY2VudCB2aWRlbyB0aXRsZXMuCiAgICAgICAgIiIiCiAgICAgICAgdGV4dF9wYXJ0cyA9IFtdCgogICAgICAgICMgMS4gQ2hlY2sgYmlvIHRleHQKICAgICAgICBmb3IgYmlvX3NlbCBpbiBbU0VMRUNUT1JTWyJiaW9fdGV4dCJdLCAnW2RhdGEtZTJlPSJ1c2VyLWJpbyJdJywKICAgICAgICAgICAgICAgICAgICAgICAgJ2gyW2RhdGEtZTJlPSJ1c2VyLXN1YnRpdGxlIl0nXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmlvID0gc2VsZi5wYWdlLmxvY2F0b3IoYmlvX3NlbCkuZmlyc3QKICAgICAgICAgICAgICAgIGlmIGJpby5pc192aXNpYmxlKHRpbWVvdXQ9MTUwMCk6CiAgICAgICAgICAgICAgICAgICAgdGV4dF9wYXJ0cy5hcHBlbmQoYmlvLmlubmVyX3RleHQodGltZW91dD0yMDAwKS5sb3dlcigpKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAjIDIuIENoZWNrIHVzZXJuYW1lIC8gZGlzcGxheSBuYW1lCiAgICAgICAgZm9yIG5hbWVfc2VsIGluIFtTRUxFQ1RPUlNbInVzZXJfdGl0bGUiXSwgJ1tkYXRhLWUyZT0idXNlci10aXRsZSJdJywKICAgICAgICAgICAgICAgICAgICAgICAgICdoMVtkYXRhLWUyZT0idXNlci1zdWJ0aXRsZSJdJ106CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG5hbWVfZWwgPSBzZWxmLnBhZ2UubG9jYXRvcihuYW1lX3NlbCkuZmlyc3QKICAgICAgICAgICAgICAgIGlmIG5hbWVfZWwuaXNfdmlzaWJsZSh0aW1lb3V0PTEwMDApOgogICAgICAgICAgICAgICAgICAgIHRleHRfcGFydHMuYXBwZW5kKG5hbWVfZWwuaW5uZXJfdGV4dCh0aW1lb3V0PTEwMDApLmxvd2VyKCkpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICMgMy4gQ2hlY2sgdmlzaWJsZSB2aWRlbyB0aXRsZXMgLyBkZXNjcmlwdGlvbnMgb24gcHJvZmlsZQogICAgICAgIHRyeToKICAgICAgICAgICAgdmlkZW9fZGVzY3MgPSBzZWxmLnBhZ2UubG9jYXRvcignW2RhdGEtZTJlPSJ1c2VyLXBvc3QtaXRlbS1kZXNjIl0sJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdbY2xhc3MqPSJEaXZWaWRlb1RpdGxlIl0nKS5hbGwoKQogICAgICAgICAgICBmb3IgdmQgaW4gdmlkZW9fZGVzY3NbOjVdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRleHRfcGFydHMuYXBwZW5kKHZkLmlubmVyX3RleHQodGltZW91dD01MDApLmxvd2VyKCkpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIDQuIEJyb2FkZXIgZmFsbGJhY2s6IGNoZWNrIHBhZ2UgdGV4dCAobGltaXRlZCBzY29wZSkKICAgICAgICBpZiBub3QgdGV4dF9wYXJ0czoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGFnZV90ZXh0ID0gc2VsZi5wYWdlLmlubmVyX3RleHQoImJvZHkiKS5sb3dlcigpCiAgICAgICAgICAgICAgICB0ZXh0X3BhcnRzLmFwcGVuZChwYWdlX3RleHRbOjMwMDBdKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGNvbWJpbmVkID0gIiAiLmpvaW4odGV4dF9wYXJ0cykKICAgICAgICByZXR1cm4gYW55KGt3IGluIGNvbWJpbmVkIGZvciBrdyBpbiBOSUNIRV9LRVlXT1JEUykKCiAgICBkZWYgX2NoZWNrX211dHVhbF9pbmRpY2F0b3JzKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiQ2hlY2sgaWYgdGhlIGN1cnJlbnQgcHJvZmlsZSBoYXMgbXV0dWFsLWNvbm5lY3Rpb24gaW5kaWNhdG9ycy4KCiAgICAgICAgVXNlcyBUSFJFRSBzdHJhdGVnaWVzOgogICAgICAgIDEuIENTUyBzZWxlY3RvciBjaGVjayBmb3IgbXV0dWFsIGZyaWVuZCBlbGVtZW50cwogICAgICAgIDIuIFRleHQtYmFzZWQgY2hlY2sgZm9yIG11dHVhbCBwaHJhc2VzIGluIHBhZ2UgY29udGVudAogICAgICAgIDMuIEphdmFTY3JpcHQtYmFzZWQgRE9NIGluc3BlY3Rpb24gZm9yIGhpZGRlbiBtdXR1YWwgZWxlbWVudHMKICAgICAgICAiIiIKICAgICAgICAjIFN0cmF0ZWd5IDE6IENTUyBzZWxlY3RvcnMgZm9yIG11dHVhbCBpbmRpY2F0b3IgZWxlbWVudHMKICAgICAgICBmb3Igc2VsIGluIFNFTEVDVE9SUy5nZXQoIm11dHVhbF9pbmRpY2F0b3Jfc2VsZWN0b3JzIiwgW10pOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBlbGVtZW50X2V4aXN0cyhzZWxmLnBhZ2UsIHNlbCwgdGltZW91dD0xMDAwKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIk11dHVhbCBpbmRpY2F0b3IgZm91bmQgdmlhIHNlbGVjdG9yOiAlcyIsIHNlbCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgIyBTdHJhdGVneSAyOiBUZXh0LWJhc2VkIGNoZWNrIG9uIHRoZSBwYWdlCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEdldCB0ZXh0IGZyb20gdGhlIHByb2ZpbGUgaGVhZGVyIGFyZWEgKG1vcmUgdGFyZ2V0ZWQgdGhhbiBmdWxsIGJvZHkpCiAgICAgICAgICAgIGhlYWRlcl90ZXh0ID0gIiIKICAgICAgICAgICAgZm9yIHNjb3BlX3NlbCBpbiBbJ1tkYXRhLWUyZT0idXNlci1wYWdlIl0nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnW2NsYXNzKj0iU2hhcmVMYXlvdXRIZWFkZXIiXScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdbY2xhc3MqPSJVc2VySW5mb0NvbnRhaW5lciJdJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcicsICdtYWluJ106CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBzZWxmLnBhZ2UubG9jYXRvcihzY29wZV9zZWwpLmZpcnN0CiAgICAgICAgICAgICAgICAgICAgaWYgc2NvcGUuaXNfdmlzaWJsZSh0aW1lb3V0PTEwMDApOgogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJfdGV4dCA9IHNjb3BlLmlubmVyX3RleHQodGltZW91dD0zMDAwKS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBpZiBub3QgaGVhZGVyX3RleHQ6CiAgICAgICAgICAgICAgICBoZWFkZXJfdGV4dCA9IHNlbGYucGFnZS5pbm5lcl90ZXh0KCJib2R5IikubG93ZXIoKVs6MzAwMF0KCiAgICAgICAgICAgIGZvciBpbmRpY2F0b3IgaW4gU0VMRUNUT1JTWyJtdXR1YWxfaW5kaWNhdG9yX3RleHRzIl06CiAgICAgICAgICAgICAgICBpZiBpbmRpY2F0b3IubG93ZXIoKSBpbiBoZWFkZXJfdGV4dDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIk11dHVhbCBpbmRpY2F0b3IgdGV4dCBmb3VuZDogJyVzJyIsIGluZGljYXRvcikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiVGV4dC1iYXNlZCBtdXR1YWwgY2hlY2sgZXJyb3I6ICVzIiwgZSkKCiAgICAgICAgIyBTdHJhdGVneSAzOiBKUy1iYXNlZCBjaGVjayBmb3IgZWxlbWVudHMgdGhhdCBtaWdodCBub3QgbWF0Y2ggQ1NTIHNlbGVjdG9ycwogICAgICAgIHRyeToKICAgICAgICAgICAgaGFzX211dHVhbF9qcyA9IHNlbGYucGFnZS5ldmFsdWF0ZSgiIiIoKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGZvciBhbnkgZWxlbWVudCBjb250YWluaW5nIG11dHVhbC9mb2xsb3dlZC1ieSB0ZXh0CiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RvcnMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ1tjbGFzcyo9InV0dWFsIl0nLAogICAgICAgICAgICAgICAgICAgICdbY2xhc3MqPSJmb2xsb3dlZEJ5Il0nLAogICAgICAgICAgICAgICAgICAgICdbY2xhc3MqPSJGb2xsb3dlZEJ5Il0nLAogICAgICAgICAgICAgICAgICAgICdbZGF0YS1lMmUqPSJtdXR1YWwiXScsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBzZWwgb2Ygc2VsZWN0b3JzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsICYmIGVsLm9mZnNldFBhcmVudCAhPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBBbHNvIGNoZWNrIGZvciBzbWFsbCB0ZXh0IG5lYXIgZm9sbG93IGJ1dHRvbgogICAgICAgICAgICAgICAgY29uc3QgYWxsVGV4dCA9IGRvY3VtZW50LmJvZHkuaW5uZXJUZXh0LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBjb25zdCBpbmRpY2F0b3JzID0gWydmb2xsb3dlZCBieScsICdtdXR1YWwgZnJpZW5kJywgJ211dHVhbCBjb25uZWN0aW9uJywgJ2ZyaWVuZHMgd2l0aCddOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBpbmQgb2YgaW5kaWNhdG9ycykgewogICAgICAgICAgICAgICAgICAgIGlmIChhbGxUZXh0LmluY2x1ZGVzKGluZCkpIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IiIiKQogICAgICAgICAgICBpZiBoYXNfbXV0dWFsX2pzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJNdXR1YWwgaW5kaWNhdG9yIGZvdW5kIHZpYSBKUyBjaGVjay4iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfY2xpY2tfZm9sbG93KHNlbGYsIHByb2ZpbGVfdXJsOiBzdHIpIC0+IE5vbmU6CiAgICAgICAgIiIiQ2xpY2sgdGhlIEZvbGxvdyBidXR0b24gdXNpbmcgaHVtYW4tbGlrZSBtb3VzZSBtb3ZlbWVudC4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvbGxvd19idG4gPSBOb25lCgogICAgICAgICAgICAjIFRyeSBwcmltYXJ5IHNlbGVjdG9yCiAgICAgICAgICAgIGZvciBzZWwgaW4gW1NFTEVDVE9SU1siZm9sbG93X2J1dHRvbiJdLAogICAgICAgICAgICAgICAgICAgICAgICBTRUxFQ1RPUlMuZ2V0KCJmb2xsb3dfYnV0dG9uX2FsdCIsICIiKV06CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYnRuID0gc2VsZi5wYWdlLmxvY2F0b3Ioc2VsKS5maXJzdAogICAgICAgICAgICAgICAgICAgIGlmIGJ0bi5pc192aXNpYmxlKHRpbWVvdXQ9MjAwMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvbGxvd19idG4gPSBidG4KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIGZvbGxvd19idG4gaXMgTm9uZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiRm9sbG93IGJ1dHRvbiBub3QgZm91bmQgb24gJXMuIiwgcHJvZmlsZV91cmwpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGJ0bl90ZXh0ID0gZm9sbG93X2J0bi5pbm5lcl90ZXh0KHRpbWVvdXQ9MzAwMCkuc3RyaXAoKS5sb3dlcigpCgogICAgICAgICAgICBpZiBidG5fdGV4dCBpbiAoImZvbGxvd2luZyIsICJmcmllbmRzIiwgInJlcXVlc3RlZCIsICJmb2xsb3cgYmFjayIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFscmVhZHkgZm9sbG93aW5nL3JlcXVlc3RlZCAlcyDigJMgc2tpcHBpbmcuIiwgcHJvZmlsZV91cmwpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIGJ0bl90ZXh0IG5vdCBpbiAoImZvbGxvdyIsICIiKToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiRm9sbG93IGJ1dHRvbiB0ZXh0IHVuZXhwZWN0ZWQ6ICclcycg4oCTIHNraXBwaW5nLiIsIGJ0bl90ZXh0KQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICBodW1hbl9jbGlja19lbGVtZW50KHNlbGYucGFnZSwgZm9sbG93X2J0biwgdGltZW91dD01MDAwKQogICAgICAgICAgICBzZWxmLl9mb2xsb3dzX3RoaXNfc2Vzc2lvbiArPSAxCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgIkZvbGxvd2VkICVzIChzZXNzaW9uIHRvdGFsOiAlZC8lZCkuIiwKICAgICAgICAgICAgICAgIHByb2ZpbGVfdXJsLAogICAgICAgICAgICAgICAgc2VsZi5fZm9sbG93c190aGlzX3Nlc3Npb24sCiAgICAgICAgICAgICAgICBNQVhfRk9MTE9XU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgKQogICAgICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX01FRElVTSwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgICAgIGdldF90aHJvdHRsZSgpLmRlY2F5KDAuMSkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJDb3VsZCBub3QgY2xpY2sgRm9sbG93IG9uICVzOiAlcyIsIHByb2ZpbGVfdXJsLCBleGMpCgogICAgIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKICAgICMgU3VnZ2VzdGVkIEFjY291bnRzIChhbHRlcm5hdGl2ZSBncm93dGgpCiAgICAjIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogICAgZGVmIHByb2Nlc3Nfc3VnZ2VzdGVkX2FjY291bnRzKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiSW5zcGVjdCB0aGUgJ1N1Z2dlc3RlZCBBY2NvdW50cycgc2lkZWJhciBhbmQgZm9sbG93IG5pY2hlLQogICAgICAgIHJlbGV2YW50IHVzZXJzIHdpdGggbXV0dWFsIGluZGljYXRvcnMuCgogICAgICAgIFRyaWVzIG11bHRpcGxlIHNlbGVjdG9ycyBzaW5jZSBUaWtUb2sgcmVkZXNpZ25zIHRoZSBzaWRlYmFyCiAgICAgICAgZnJlcXVlbnRseS4gSW5jbHVkZXMgZGVsYXkgYW5kIENBUFRDSEEgY2hlY2tzIHRvIHJlZHVjZSBzbGlkZXIgdHJpZ2dlcnMuCiAgICAgICAgIiIiCiAgICAgICAgd2FpdF91bnRpbF9hY3RpdmUoKQogICAgICAgIGxvZ2dlci5pbmZvKCI9PT0gU1VHR0VTVEVEIEFDQ09VTlRTID09PSIpCgogICAgICAgIHNlbGYucGFnZS5nb3RvKFRJS1RPS19CQVNFLCB3YWl0X3VudGlsPSJkb21jb250ZW50bG9hZGVkIikKICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX01FRElVTSwgcGFnZT1zZWxmLnBhZ2UpCgogICAgICAgIGlmIGhhbmRsZV9jaGFsbGVuZ2Uoc2VsZi5wYWdlLCBwaGFzZT0ic3VnZ2VzdGVkIik6CiAgICAgICAgICAgIHNlbGYuX2NhcHRjaGFfaGl0X3RoaXNfc2Vzc2lvbiA9IFRydWUKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgUGF1c2UgYmVmb3JlIGludGVyYWN0aW5nIHdpdGggc2lkZWJhciAocmVkdWNlcyBDQVBUQ0hBIG9uIHByb2ZpbGUgdmlzaXRzKQogICAgICAgIHBhdXNlID0gcmFuZG9tLnVuaWZvcm0oMTIuMCwgMjIuMCkKICAgICAgICBsb2dnZXIuaW5mbygiUGF1c2luZyAlLjBmIHMgYmVmb3JlIHN1Z2dlc3RlZCBhY2NvdW50cyAobmF0dXJhbCBicm93c2luZykuIiwgcGF1c2UpCiAgICAgICAgcmFuZG9tX3NsZWVwKHBhdXNlLCBwYXVzZSArIDMuMCwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgaWYgaGFuZGxlX2NoYWxsZW5nZShzZWxmLnBhZ2UpOgogICAgICAgICAgICBzZWxmLl9jYXB0Y2hhX2hpdF90aGlzX3Nlc3Npb24gPSBUcnVlCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIFRyeSBtdWx0aXBsZSBzZWxlY3RvcnMgZm9yIHRoZSBzdWdnZXN0ZWQgYWNjb3VudHMgc2VjdGlvbgogICAgICAgIHN1Z2dlc3RlZCA9IE5vbmUKICAgICAgICBmb3Igc2VsIGluIFNFTEVDVE9SUy5nZXQoInN1Z2dlc3RlZF9hY2NvdW50c19zZWxlY3RvcnMiLCBbXSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxvYyA9IHNlbGYucGFnZS5sb2NhdG9yKHNlbCkKICAgICAgICAgICAgICAgIGlmIGVsZW1lbnRfZXhpc3RzKHNlbGYucGFnZSwgc2VsLCB0aW1lb3V0PTMwMDApOgogICAgICAgICAgICAgICAgICAgIHN1Z2dlc3RlZCA9IGxvYy5maXJzdAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGb3VuZCBzdWdnZXN0ZWQgYWNjb3VudHMgdmlhOiAlcyIsIHNlbCkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgc3VnZ2VzdGVkIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTdWdnZXN0ZWQgYWNjb3VudHMgc2lkZWJhciBub3QgZm91bmQgKHRyaWVkIGFsbCBzZWxlY3RvcnMpLiIpCiAgICAgICAgICAgICMgRmFsbGJhY2s6IHRyeSB0byBmaW5kIHVzZXIgcmVjb21tZW5kYXRpb24gY2FyZHMgYW55d2hlcmUgb24gcGFnZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9wcm9jZXNzX2FueV92aXNpYmxlX3N1Z2dlc3Rpb25zKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJGYWxsYmFjayBzdWdnZXN0aW9uIHByb2Nlc3NpbmcgZmFpbGVkOiAlcyIsIGUpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXJfY2FyZHMgPSBzdWdnZXN0ZWQubG9jYXRvcihTRUxFQ1RPUlNbInVzZXJfY2FyZCJdKS5hbGwoKQogICAgICAgICAgICBpZiBub3QgdXNlcl9jYXJkczoKICAgICAgICAgICAgICAgICMgVHJ5IGJyb2FkZXIgY2FyZCBzZWxlY3RvcgogICAgICAgICAgICAgICAgdXNlcl9jYXJkcyA9IHN1Z2dlc3RlZC5sb2NhdG9yKCJhW2hyZWYqPScvQCddIikuYWxsKCkKCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJGb3VuZCAlZCBzdWdnZXN0ZWQgdXNlciBjYXJkcy4iLCBsZW4odXNlcl9jYXJkcykpCiAgICAgICAgICAgIHN1Z2dlc3RlZF9mb2xsb3dzX3RoaXNfdGFzayA9IDAKCiAgICAgICAgICAgIGZvciBjYXJkIGluIHVzZXJfY2FyZHM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9mb2xsb3dzX3RoaXNfc2Vzc2lvbiA+PSBNQVhfRk9MTE9XU19QRVJfU0VTU0lPTjoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgaWYgc3VnZ2VzdGVkX2ZvbGxvd3NfdGhpc190YXNrID49IE1BWF9TVUdHRVNURURfRk9MTE9XUzoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiUmVhY2hlZCBzdWdnZXN0ZWQtYWNjb3VudCBmb2xsb3cgbGltaXQgKCVkKS4iLCBNQVhfU1VHR0VTVEVEX0ZPTExPV1MpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlmIGdldF90aHJvdHRsZSgpLmlzX2NyaXRpY2FsOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJUaHJvdHRsZSBjcml0aWNhbCDigJMgc3RvcHBpbmcgc3VnZ2VzdGVkIGFjY291bnRzLiIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlmIGhhbmRsZV9jaGFsbGVuZ2Uoc2VsZi5wYWdlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jYXB0Y2hhX2hpdF90aGlzX3Nlc3Npb24gPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZGVzY190ZXh0ID0gY2FyZC5pbm5lcl90ZXh0KHRpbWVvdXQ9MjAwMCkubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIGlzX25pY2hlID0gYW55KGt3IGluIGRlc2NfdGV4dCBmb3Iga3cgaW4gTklDSEVfS0VZV09SRFMpCiAgICAgICAgICAgICAgICAgICAgaGFzX211dHVhbCA9IGFueSgKICAgICAgICAgICAgICAgICAgICAgICAgaW5kLmxvd2VyKCkgaW4gZGVzY190ZXh0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBpbmQgaW4gU0VMRUNUT1JTWyJtdXR1YWxfaW5kaWNhdG9yX3RleHRzIl0KICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgIGlmIGlzX25pY2hlIGFuZCBoYXNfbXV0dWFsOgogICAgICAgICAgICAgICAgICAgICAgICBmb2xsb3dfYnRuID0gY2FyZC5sb2NhdG9yKFNFTEVDVE9SU1siZm9sbG93X2J1dHRvbiJdKS5maXJzdAogICAgICAgICAgICAgICAgICAgICAgICBodW1hbl9jbGlja19lbGVtZW50KHNlbGYucGFnZSwgZm9sbG93X2J0biwgdGltZW91dD0zMDAwKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9mb2xsb3dzX3RoaXNfc2Vzc2lvbiArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Z2dlc3RlZF9mb2xsb3dzX3RoaXNfdGFzayArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkZvbGxvd2VkIHN1Z2dlc3RlZCBhY2NvdW50ICh0b3RhbDogJWQpLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9mb2xsb3dzX3RoaXNfc2Vzc2lvbiwKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX01FRElVTSwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGdldF90aHJvdHRsZSgpLmRlY2F5KDAuMSkKICAgICAgICAgICAgICAgICAgICBlbGlmIGlzX25pY2hlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIlN1Z2dlc3RlZCBjYXJkIG5pY2hlLXJlbGV2YW50IGJ1dCBubyBtdXR1YWwgaW5kaWNhdG9yLiIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGlubmVyX2V4YzoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIlNraXBwaW5nIHN1Z2dlc3RlZCBjYXJkOiAlcyIsIGlubmVyX2V4YykKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJFcnJvciBwcm9jZXNzaW5nIHN1Z2dlc3RlZCBhY2NvdW50czogJXMiLCBleGMpCgogICAgZGVmIF9wcm9jZXNzX2FueV92aXNpYmxlX3N1Z2dlc3Rpb25zKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiRmFsbGJhY2s6IGxvb2sgZm9yIGFueSByZWNvbW1lbmRhdGlvbi9zdWdnZXN0aW9uIGxpbmtzIG9uIHRoZQogICAgICAgIGN1cnJlbnQgcGFnZSBhbmQgZXZhbHVhdGUgdGhlbSBmb3IgZm9sbG93LgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBMb29rIGZvciAiU2VlIGFsbCIgb3IgIlZpZXcgbW9yZSIgdHlwZSBsaW5rcyB0aGF0IGV4cGFuZCBzdWdnZXN0aW9ucwogICAgICAgICAgICBleHBhbmRfc2VsZWN0b3JzID0gWwogICAgICAgICAgICAgICAgJ3RleHQ9IlNlZSBhbGwiJywKICAgICAgICAgICAgICAgICd0ZXh0PSJWaWV3IGFsbCInLAogICAgICAgICAgICAgICAgJ1tkYXRhLWUyZT0ic2VlLWFsbCJdJywKICAgICAgICAgICAgXQogICAgICAgICAgICBmb3Igc2VsIGluIGV4cGFuZF9zZWxlY3RvcnM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYnRuID0gc2VsZi5wYWdlLmxvY2F0b3Ioc2VsKS5maXJzdAogICAgICAgICAgICAgICAgICAgIGlmIGJ0bi5pc192aXNpYmxlKHRpbWVvdXQ9MTAwMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGh1bWFuX2NsaWNrX2VsZW1lbnQoc2VsZi5wYWdlLCBidG4sIHRpbWVvdXQ9MjAwMCkKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX3NsZWVwKCpERUxBWV9TSE9SVCwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIE5vdyBleHRyYWN0IGFueSB2aXNpYmxlIHVzZXIgbGlua3MgZnJvbSB0aGUgcGFnZQogICAgICAgICAgICB1c2VyX2xpbmtzID0gc2VsZi5fZXh0cmFjdF9wcm9maWxlX2xpbmtzKCkKICAgICAgICAgICAgcmFuZG9tLnNodWZmbGUodXNlcl9saW5rcykKICAgICAgICAgICAgIyBMaW1pdCBwcm9maWxlIHZpc2l0cyB0byByZWR1Y2UgQ0FQVENIQSAoc3VnZ2VzdGVkIGZsb3cgaXMgaGlnaC1yaXNrKQogICAgICAgICAgICBtYXhfc3VnZ2VzdGVkX3Byb2ZpbGVzID0gMgogICAgICAgICAgICBmb3IgbGluayBpbiB1c2VyX2xpbmtzWzptYXhfc3VnZ2VzdGVkX3Byb2ZpbGVzXToKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2ZvbGxvd3NfdGhpc19zZXNzaW9uID49IE1BWF9GT0xMT1dTX1BFUl9TRVNTSU9OOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jYXB0Y2hhX2hpdF90aGlzX3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNBUFRDSEEgaGl0IOKAkyBzdG9wcGluZyBwcm9maWxlIHZpc2l0cy4iKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoMTUuMCwgMjUuMCwgcGFnZT1zZWxmLnBhZ2UpCiAgICAgICAgICAgICAgICBpZiBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9InN1Z2dlc3RlZCIpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhcHRjaGFfaGl0X3RoaXNfc2Vzc2lvbiA9IFRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgc2VsZi5fZXZhbHVhdGVfYW5kX2ZvbGxvdyhsaW5rKQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiX3Byb2Nlc3NfYW55X3Zpc2libGVfc3VnZ2VzdGlvbnMgZXJyb3I6ICVzIiwgZSkKCiAgICAjIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogICAgIyBWaWRlbyBVcGxvYWQKICAgICMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiAgICBkZWYgdXBsb2FkX2NvbnRlbnQoc2VsZiwgdmlkZW9fcGF0aDogc3RyLCBjYXB0aW9uOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiVXBsb2FkIGEgdmlkZW8gdG8gVGlrVG9rIHdpdGggdGhlIGdpdmVuIGNhcHRpb24uCgogICAgICAgIFJldHVybnMgYGBUcnVlYGAgb24gYXBwYXJlbnQgc3VjY2VzcywgYGBGYWxzZWBgIG90aGVyd2lzZS4KICAgICAgICAiIiIKICAgICAgICB3YWl0X3VudGlsX2FjdGl2ZSgpCiAgICAgICAgdmlkZW9fcGF0aCA9IG9zLnBhdGguYWJzcGF0aCh2aWRlb19wYXRoKQoKICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUodmlkZW9fcGF0aCk6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiVmlkZW8gZmlsZSBub3QgZm91bmQ6ICVzIiwgdmlkZW9fcGF0aCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGxvZ2dlci5pbmZvKCI9PT0gVVBMT0FESU5HIFZJREVPOiAlcyA9PT0iLCB2aWRlb19wYXRoKQoKICAgICAgICBzZWxmLnBhZ2UuZ290byhUSUtUT0tfVVBMT0FELCB3YWl0X3VudGlsPSJkb21jb250ZW50bG9hZGVkIikKICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX0xPTkcsIHBhZ2U9c2VsZi5wYWdlKQoKICAgICAgICBpZiBoYW5kbGVfY2hhbGxlbmdlKHNlbGYucGFnZSwgcGhhc2U9InVwbG9hZCIpOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiQ2hhbGxlbmdlIG9uIHVwbG9hZCBwYWdlIOKAkyBhYm9ydGluZy4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRpa1RvayB1cGxvYWQgcGFnZSB1c2VzIGFuIGlmcmFtZSDigJQgZmluZCB0aGUgY29ycmVjdCBvbmUgYnkgc3JjCiAgICAgICAgICAgIGZyYW1lID0gTm9uZQogICAgICAgICAgICBmb3IgaWZyYW1lX3NlbCBpbiBbCiAgICAgICAgICAgICAgICAnaWZyYW1lW3NyYyo9ImNyZWF0b3IiXScsCiAgICAgICAgICAgICAgICAnaWZyYW1lW3NyYyo9InVwbG9hZCJdJywKICAgICAgICAgICAgICAgIFNFTEVDVE9SU1sidXBsb2FkX2lmcmFtZSJdLCAgIyBnZW5lcmljICJpZnJhbWUiIGZhbGxiYWNrCiAgICAgICAgICAgIF06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lX2xvYyA9IHNlbGYucGFnZS5sb2NhdG9yKGlmcmFtZV9zZWwpLmZpcnN0CiAgICAgICAgICAgICAgICAgICAgaWYgaWZyYW1lX2xvYy5pc192aXNpYmxlKHRpbWVvdXQ9NTAwMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBpZnJhbWVfbG9jLmNvbnRlbnRfZnJhbWUoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUgPSBmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiVXBsb2FkIGlmcmFtZSBmb3VuZCB2aWEgc2VsZWN0b3I6ICVzIiwgaWZyYW1lX3NlbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICB0YXJnZXQgPSBmcmFtZSBpZiBmcmFtZSBlbHNlIHNlbGYucGFnZQoKICAgICAgICAgICAgIyBXYWl0IGZvciB0aGUgZmlsZSBpbnB1dCB0byBiZSByZWFkeSBiZWZvcmUgaW50ZXJhY3RpbmcKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIldhaXRpbmcgZm9yIHVwbG9hZCBmaWxlIGlucHV0IOKApiIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHRhcmdldC5sb2NhdG9yKFNFTEVDVE9SU1sidXBsb2FkX2ZpbGVfaW5wdXQiXSkuZmlyc3Qud2FpdF9mb3IoCiAgICAgICAgICAgICAgICAgICAgc3RhdGU9InZpc2libGUiLCB0aW1lb3V0PTMwMDAwCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgd2FpdF9lcnI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiRmlsZSBpbnB1dCB3YWl0IHRpbWVkIG91dDogJXMg4oCUIHByb2NlZWRpbmcgYW55d2F5LiIsIHdhaXRfZXJyKQoKICAgICAgICAgICAgIyBIYW5kbGUgZmlsZSBjaG9vc2VyCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTZWxlY3RpbmcgdmlkZW8gZmlsZSDigKYiKQogICAgICAgICAgICBmaWxlX2lucHV0ID0gdGFyZ2V0LmxvY2F0b3IoU0VMRUNUT1JTWyJ1cGxvYWRfZmlsZV9pbnB1dCJdKS5maXJzdAogICAgICAgICAgICBmaWxlX2lucHV0LnNldF9pbnB1dF9maWxlcyh2aWRlb19wYXRoKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiRmlsZSBzZWxlY3RlZC4gV2FpdGluZyBmb3IgdXBsb2FkIHByb2Nlc3Npbmcg4oCmIikKICAgICAgICAgICAgcmFuZG9tX3NsZWVwKCpERUxBWV9MT05HLCBwYWdlPXNlbGYucGFnZSkKCiAgICAgICAgICAgICMgV2FpdCBleHRyYSB0aW1lIGZvciB2aWRlbyB0byBwcm9jZXNzCiAgICAgICAgICAgIGlkbGVfc2xlZXAoc2VsZi5wYWdlLCByYW5kb20udW5pZm9ybSgxMC4wLCAyMC4wKSkKCiAgICAgICAgICAgICMgVHlwZSBjYXB0aW9uIOKAlCB0cnkgdGhlIHNwZWNpZmljIGNhcHRpb24gZWRpdG9yIGZpcnN0LCB0aGVuIGZhbGxiYWNrCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJUeXBpbmcgY2FwdGlvbiDigKYiKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjYXB0aW9uX2VsID0gTm9uZQogICAgICAgICAgICAgICAgZm9yIGNhcF9zZWwgaW4gW1NFTEVDVE9SU1siY2FwdGlvbl9lZGl0b3IiXSwgU0VMRUNUT1JTWyJjYXB0aW9uX2lucHV0Il1dOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgZWwgPSB0YXJnZXQubG9jYXRvcihjYXBfc2VsKS5maXJzdAogICAgICAgICAgICAgICAgICAgICAgICBpZiBlbC5pc192aXNpYmxlKHRpbWVvdXQ9NDAwMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9uX2VsID0gZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDYXB0aW9uIGVsZW1lbnQgZm91bmQgdmlhOiAlcyIsIGNhcF9zZWwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBjYXB0aW9uX2VsIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbl9lbCA9IHRhcmdldC5sb2NhdG9yKFNFTEVDVE9SU1siY2FwdGlvbl9pbnB1dCJdKS5maXJzdAoKICAgICAgICAgICAgICAgIGh1bWFuX2NsaWNrX2VsZW1lbnQoc2VsZi5wYWdlLCBjYXB0aW9uX2VsLCB0aW1lb3V0PTUwMDApCiAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoMC41LCAxLjApCgogICAgICAgICAgICAgICAgIyBDbGVhciBleGlzdGluZyB0ZXh0CiAgICAgICAgICAgICAgICBzZWxlY3RfYWxsID0gIk1ldGErQSIgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gIkRhcndpbiIgZWxzZSAiQ29udHJvbCtBIgogICAgICAgICAgICAgICAgc2VsZi5wYWdlLmtleWJvYXJkLnByZXNzKHNlbGVjdF9hbGwpCiAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoMC4yLCAwLjQpCiAgICAgICAgICAgICAgICBzZWxmLnBhZ2Uua2V5Ym9hcmQucHJlc3MoIkJhY2tzcGFjZSIpCiAgICAgICAgICAgICAgICByYW5kb21fc2xlZXAoMC4zLCAwLjYpCgogICAgICAgICAgICAgICAgaHVtYW5fdHlwZV9lbGVtZW50KHNlbGYucGFnZSwgY2FwdGlvbl9lbCwgY2FwdGlvbikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBjYXBfZXhjOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkNhcHRpb24gdHlwaW5nIHZpYSBlbGVtZW50IGZhaWxlZDogJXMuIFRyeWluZyBrZXlib2FyZC4iLCBjYXBfZXhjKQogICAgICAgICAgICAgICAgc2VsZi5wYWdlLmtleWJvYXJkLnR5cGUoY2FwdGlvbiwgZGVsYXk9cmFuZG9tLnJhbmRpbnQoNTAsIDE1MCkpCgogICAgICAgICAgICByYW5kb21fc2xlZXAoKkRFTEFZX01FRElVTSwgcGFnZT1zZWxmLnBhZ2UpCgogICAgICAgICAgICAjIENsaWNrIFBvc3QKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNsaWNraW5nIFBvc3QgYnV0dG9uIOKApiIpCiAgICAgICAgICAgIHBvc3RfY2xpY2tlZCA9IEZhbHNlCiAgICAgICAgICAgIGZvciBwb3N0X3NlbCBpbiBbU0VMRUNUT1JTWyJwb3N0X2J1dHRvbiJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNFTEVDVE9SUy5nZXQoInBvc3RfYnV0dG9uX2FsdCIsICIiKV06CiAgICAgICAgICAgICAgICBpZiBub3QgcG9zdF9zZWw6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBwb3N0X2J0biA9IHRhcmdldC5sb2NhdG9yKHBvc3Rfc2VsKS5maXJzdAogICAgICAgICAgICAgICAgICAgIGlmIGh1bWFuX2NsaWNrX2VsZW1lbnQoc2VsZi5wYWdlLCBwb3N0X2J0biwgdGltZW91dD0xMDAwMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RfY2xpY2tlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIG5vdCBwb3N0X2NsaWNrZWQ6CiAgICAgICAgICAgICAgICBwb3N0X2NsaWNrZWQgPSBzYWZlX2NsaWNrKHNlbGYucGFnZSwgU0VMRUNUT1JTWyJwb3N0X2J1dHRvbiJdLCB0aW1lb3V0PTEwMDAwKQoKICAgICAgICAgICAgaWYgbm90IHBvc3RfY2xpY2tlZDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiQ291bGQgbm90IGNsaWNrIHRoZSBQb3N0IGJ1dHRvbi4iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBsb2dnZXIuaW5mbygiUG9zdCBidXR0b24gY2xpY2tlZC4gV2FpdGluZyBmb3IgY29uZmlybWF0aW9uIOKApiIpCiAgICAgICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfTE9ORywgcGFnZT1zZWxmLnBhZ2UpCgogICAgICAgICAgICAjIFZlcmlmeSBzdWNjZXNzCiAgICAgICAgICAgIGlkbGVfc2xlZXAoc2VsZi5wYWdlLCByYW5kb20udW5pZm9ybSg1LjAsIDEwLjApKQogICAgICAgICAgICBjdXJyZW50X3VybCA9IHNlbGYucGFnZS51cmwKCiAgICAgICAgICAgICMgQ2hlY2sgbXVsdGlwbGUgc3VjY2VzcyBpbmRpY2F0b3JzCiAgICAgICAgICAgIGZvciBzdWNjZXNzX3NlbCBpbiBTRUxFQ1RPUlMuZ2V0KCJ1cGxvYWRfc3VjY2Vzc19pbmRpY2F0b3JzIiwgW10pOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIGVsZW1lbnRfZXhpc3RzKHNlbGYucGFnZSwgc3VjY2Vzc19zZWwsIHRpbWVvdXQ9NTAwMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJVcGxvYWQgc3VjY2VzcyBpbmRpY2F0b3IgZm91bmQ6ICVzIiwgc3VjY2Vzc19zZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBpZiAidXBsb2FkIiBub3QgaW4gY3VycmVudF91cmwubG93ZXIoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJSZWRpcmVjdGVkIGF3YXkgZnJvbSB1cGxvYWQgcGFnZSDigJMgdmlkZW8gbGlrZWx5IHBvc3RlZC4iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJDb3VsZCBub3QgY29uZmlybSB1cGxvYWQgc3VjY2VzcyDigJMgcGxlYXNlIHZlcmlmeSBtYW51YWxseS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiVXBsb2FkIGZhaWxlZDogJXMiLCBleGMpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiAgICAjIFZpZGVvIFNjaGVkdWxpbmcKICAgICMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiAgICBkZWYgY2hlY2tfYW5kX3VwbG9hZF9zY2hlZHVsZWQoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiJDaGVjayBpZiBhbnkgc2NoZWR1bGVkIHZpZGVvcyBhcmUgZHVlIGFuZCB1cGxvYWQgdGhlbS4iIiIKICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUoU0NIRURVTEVfRklMRSk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihTQ0hFRFVMRV9GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZoOgogICAgICAgICAgICAgICAgc2NoZWR1bGVzID0ganNvbi5sb2FkKGZoKQogICAgICAgIGV4Y2VwdCAoanNvbi5KU09ORGVjb2RlRXJyb3IsIElPRXJyb3IpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgbm90IHNjaGVkdWxlczoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgbm93ID0gZGF0ZXRpbWUubm93KCkKICAgICAgICByZW1haW5pbmcgPSBbXQogICAgICAgIHVwbG9hZGVkX2FueSA9IEZhbHNlCgogICAgICAgIGZvciBlbnRyeSBpbiBzY2hlZHVsZXM6CiAgICAgICAgICAgIHNjaGVkdWxlZF90aW1lID0gZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChlbnRyeVsic2NoZWR1bGVkX3RpbWUiXSkKICAgICAgICAgICAgaWYgbm93ID49IHNjaGVkdWxlZF90aW1lIGFuZCBlbnRyeS5nZXQoInN0YXR1cyIpICE9ICJkb25lIjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTY2hlZHVsZWQgdXBsb2FkIGR1ZTogJXMiLCBlbnRyeVsidmlkZW9fcGF0aCJdKQogICAgICAgICAgICAgICAgd2FpdF91bnRpbF9hY3RpdmUoKQogICAgICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYudXBsb2FkX2NvbnRlbnQoZW50cnlbInZpZGVvX3BhdGgiXSwgZW50cnlbImNhcHRpb24iXSkKICAgICAgICAgICAgICAgIGVudHJ5WyJzdGF0dXMiXSA9ICJkb25lIiBpZiBzdWNjZXNzIGVsc2UgImZhaWxlZCIKICAgICAgICAgICAgICAgIGVudHJ5WyJhdHRlbXB0ZWRfYXQiXSA9IG5vdy5pc29mb3JtYXQoKQogICAgICAgICAgICAgICAgdXBsb2FkZWRfYW55ID0gVHJ1ZQogICAgICAgICAgICByZW1haW5pbmcuYXBwZW5kKGVudHJ5KQoKICAgICAgICBpZiB1cGxvYWRlZF9hbnk6CiAgICAgICAgICAgIHdpdGggb3BlbihTQ0hFRFVMRV9GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZoOgogICAgICAgICAgICAgICAganNvbi5kdW1wKHJlbWFpbmluZywgZmgsIGluZGVudD0yKQoKICAgICMg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACiAgICAjIENvbXBvc2l0ZSBTZXNzaW9uIFJ1bm5lcgogICAgIyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKICAgIGRlZiBydW5fc2Vzc2lvbihzZWxmKSAtPiBOb25lOgogICAgICAgICIiIkV4ZWN1dGUgYSBmdWxsIGJvdCBzZXNzaW9uLgoKICAgICAgICBTdHJhdGVneTogQUxXQVlTIHJ1biBmZWVkIGludGVyYWN0aW9uIGZpcnN0IChDQVBUQ0hBLXNhZmUpLCB0aGVuCiAgICAgICAgb25seSBydW4gcHJvZmlsZS12aXNpdCB0YXNrcyAobXV0dWFscywgc3VnZ2VzdGVkKSBpZiBubyBDQVBUQ0hBCiAgICAgICAgd2FzIHRyaWdnZXJlZC4gIFRoaXMgcHJvdGVjdHMgbmV3IGFjY291bnRzIHRoYXQgZ2V0IGhlYXZpbHkKICAgICAgICBDQVBUQ0hBJ2Qgb24gYW55IG5hdmlnYXRpb24gYmV5b25kIGZlZWQgc2Nyb2xsaW5nLgogICAgICAgICIiIgogICAgICAgIHdhaXRfdW50aWxfYWN0aXZlKCkKICAgICAgICBsb2dnZXIuaW5mbygiPT09PT09PT09PSBTRVNTSU9OIFNUQVJUID09PT09PT09PT0iKQoKICAgICAgICAjIFJlc2V0IHBlci1zZXNzaW9uIGNvdW50ZXJzCiAgICAgICAgc2VsZi5fZm9sbG93c190aGlzX3Nlc3Npb24gPSAwCiAgICAgICAgc2VsZi5fbGlrZXNfdGhpc19zZXNzaW9uID0gMAogICAgICAgIHNlbGYuX2NhcHRjaGFfaGl0X3RoaXNfc2Vzc2lvbiA9IEZhbHNlCiAgICAgICAgc2VsZi5fY29udGVudF9ibG9ja2VkX3RoaXNfc2Vzc2lvbiA9IEZhbHNlCiAgICAgICAgc2VsZi5fc2Vzc2lvbl9iZWhhdmlvciA9IHNlbGYuX2J1aWxkX3Nlc3Npb25fYmVoYXZpb3IoKQoKICAgICAgICAjIENoZWNrIGZvciBzY2hlZHVsZWQgdXBsb2FkcyBmaXJzdAogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5jaGVja19hbmRfdXBsb2FkX3NjaGVkdWxlZCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiU2NoZWR1bGVkIHVwbG9hZCBjaGVjayBmYWlsZWQ6ICVzIiwgZSkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIOKUgOKUgCBQSEFTRSAxOiBBbHdheXMgcnVuIGZlZWQgaW50ZXJhY3Rpb24gZmlyc3QgKHNhZmUpIOKUgOKUgAogICAgICAgICAgICB3YWl0X3VudGlsX2FjdGl2ZSgpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTdGFydGluZyB0YXNrOiBmZWVkIikKICAgICAgICAgICAgc2VsZi5pbnRlcmFjdF9mZWVkKCkKICAgICAgICAgICAgcmFuZG9tX3NsZWVwKCpERUxBWV9MT05HLCBwYWdlPXNlbGYucGFnZSkKCiAgICAgICAgICAgICMg4pSA4pSAIFBIQVNFIDI6IFByb2ZpbGUtdmlzaXQgdGFza3MgKG9yZGVyOiBtdXR1YWxzIHRoZW4gc3VnZ2VzdGVkKSDilIDilIAKICAgICAgICAgICAgIyBPcmRlcjogZmVlZCAoc2Nyb2xsKSDihpIgbXV0dWFscyAoI3RyYWRpbmcgKyBwcm9maWxlcykg4oaSIHN1Z2dlc3RlZC4KICAgICAgICAgICAgIyBJc29sYXRpb246IHNldCBFTkFCTEVfTVVUVUFMUz1GYWxzZSBvciBFTkFCTEVfU1VHR0VTVEVEPUZhbHNlIGluIGNvbmZpZyB0byB0ZXN0IENBUFRDSEEgc291cmNlLgogICAgICAgICAgICBwcm9maWxlX3Rhc2tzID0gW10KICAgICAgICAgICAgaWYgRU5BQkxFX01VVFVBTFM6CiAgICAgICAgICAgICAgICBwcm9maWxlX3Rhc2tzLmFwcGVuZCgoIm11dHVhbHMiLCBzZWxmLmZpbmRfbXV0dWFscykpCiAgICAgICAgICAgIGlmIEVOQUJMRV9TVUdHRVNURUQ6CiAgICAgICAgICAgICAgICBwcm9maWxlX3Rhc2tzLmFwcGVuZCgoInN1Z2dlc3RlZCIsIHNlbGYucHJvY2Vzc19zdWdnZXN0ZWRfYWNjb3VudHMpKQogICAgICAgICAgICBmb3IgbmFtZSwgdGFza19mbiBpbiBwcm9maWxlX3Rhc2tzOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fY2FwdGNoYV9oaXRfdGhpc19zZXNzaW9uOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTa2lwcGluZyAnJXMnIOKAkyBDQVBUQ0hBIHRyaWdnZXJlZCBlYXJsaWVyLiIsIG5hbWUpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGlmIGdldF90aHJvdHRsZSgpLmlzX2NyaXRpY2FsOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJUaHJvdHRsZSBjcml0aWNhbCDigJMgc2tpcHBpbmcgcmVtYWluaW5nIHRhc2tzLiIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIHdhaXRfdW50aWxfYWN0aXZlKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTdGFydGluZyB0YXNrOiAlcyIsIG5hbWUpCiAgICAgICAgICAgICAgICB0YXNrX2ZuKCkKICAgICAgICAgICAgICAgIHJhbmRvbV9zbGVlcCgqREVMQVlfTE9ORywgcGFnZT1zZWxmLnBhZ2UpCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXhjOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIlNlc3Npb24gZXJyb3I6ICVzIiwgZXhjKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgIj09PT09PT09PT0gU0VTU0lPTiBFTkQgKGxpa2VzOiAlZCwgZm9sbG93czogJWQpID09PT09PT09PT0iLAogICAgICAgICAgICAgICAgc2VsZi5fbGlrZXNfdGhpc19zZXNzaW9uLAogICAgICAgICAgICAgICAgc2VsZi5fZm9sbG93c190aGlzX3Nlc3Npb24sCiAgICAgICAgICAgICkK'
def patch(fn, b64):
    if os.path.exists(fn): shutil.copy2(fn, fn+".bak"); print("  Backed up", fn)
    open(fn,"wb").write(base64.b64decode(b64)); print("  Patched", fn)
print("Applying upload fix...")
patch("stealth.py", STEALTH)
patch("tiktok_bot.py", TIKTOK)
print("Done! Run the bot and choose option [3].")
